<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer CSAT Dashboard</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Euclid Circular B Font Integration -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.cdnfonts.com/css/euclid-circular-b" rel="stylesheet">

    <style>
        /* CSS Custom Properties - Custom Dark Green Theme */
        :root {
            /* Lighter Primary Green Palette */
            --primary-main: #34d399;
            --primary-surface: #f0fdf4;
            --primary-focus: #dcfce7;
            --primary-border: #bbf7d0;
            --primary-hover: #10b981;
            --primary-pressed: #059669;
            --primary-gradient: linear-gradient(135deg, #34d399 0%, #10b981 100%);
            --primary-light: #dcfce7;
            --primary-dark: #059669;

            /* Secondary Orange Palette */
            --secondary-main: #ff9d18;
            --secondary-surface: #fff5e8;
            --secondary-focus: #ffebd1;
            --secondary-border: #ffd8a3;
            --secondary-hover: #e58400;
            --secondary-pressed: #aa6910;

            /* Much Lighter Background Colors */
            --bg-primary: #064e3b;
            --bg-secondary: #065f46;
            --bg-tertiary: #047857;
            --bg-card: rgba(6, 78, 59, 0.85);
            --bg-card-hover: rgba(6, 95, 70, 0.9);

            /* Modern Secondary Palette - Enhanced Orange Theme */
            --secondary-main: #f59e0b;
            --secondary-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --secondary-surface: rgba(255, 251, 235, 0.8);
            --secondary-focus: rgba(254, 243, 199, 0.6);
            --secondary-border: rgba(252, 211, 77, 0.3);
            --secondary-hover: #d97706;
            --secondary-pressed: #b45309;
            --secondary-light: #fef3c7;
            --secondary-dark: #78350f;

            /* Modern Semantic Colors */
            --success-color: #10b981;
            --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --warning-color: #f59e0b;
            --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --error-color: #ef4444;
            --error-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --info-color: #3b82f6;
            --info-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);

            /* Enhanced Text Colors for Better Contrast */
            --text-primary: #ffffff;
            --text-secondary: #f1f5f9;
            --text-tertiary: #cbd5e1;
            --text-muted: #94a3b8;
            --text-accent: var(--primary-main);

            /* Legacy Neutral Palette (for compatibility) */
            --neutral-50: #1e293b;
            --neutral-100: #334155;
            --neutral-200: #475569;
            --neutral-300: #64748b;
            --neutral-400: #94a3b8;
            --neutral-500: #cbd5e1;
            --neutral-600: #e2e8f0;
            --neutral-700: #f1f5f9;
            --neutral-800: #f8fafc;
            --neutral-900: #ffffff;

            /* Glassmorphism Effects for White Background */
            --glass-bg: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(0, 0, 0, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            --glass-backdrop: blur(10px);

            /* Typography System */
            --font-family: 'Euclid Circular B', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-display: 'Euclid Circular B', system-ui, sans-serif;

            /* Modern Spacing System */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 48px;
            --spacing-3xl: 64px;
            --spacing-4xl: 80px;

            /* Modern Border Radius */
            --radius-xs: 4px;
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-2xl: 24px;
            --radius-full: 9999px;

            /* Modern Shadow System */
            --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);

            /* Modern Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 500ms cubic-bezier(0.4, 0, 0.2, 1);

            /* Modern Z-Index Scale */
            --z-dropdown: 1000;
            --z-sticky: 1020;
            --z-fixed: 1030;
            --z-modal-backdrop: 1040;
            --z-modal: 1050;
            --z-popover: 1060;
            --z-tooltip: 1070;
        }

        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Ensure all elements inherit the correct font */
        *,
        *::before,
        *::after {
            font-family: inherit;
        }

        body {
            font-family: var(--font-family);
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.6;
            color: var(--text-primary);
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-tertiary) 100%);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Modern Typography Hierarchy */
        .heading-xl {
            font-family: var(--font-display);
            font-size: clamp(2rem, 4vw, 3rem);
            font-weight: 700;
            line-height: 1.1;
            color: var(--neutral-900);
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.025em;
        }

        .heading-lg {
            font-family: var(--font-display);
            font-size: clamp(1.5rem, 3vw, 2.25rem);
            font-weight: 600;
            line-height: 1.2;
            color: var(--text-primary);
            letter-spacing: -0.025em;
        }

        .heading-md {
            font-family: var(--font-display);
            font-size: clamp(1.25rem, 2.5vw, 1.875rem);
            font-weight: 600;
            line-height: 1.3;
            color: var(--text-primary);
            letter-spacing: -0.025em;
        }

        .heading-sm {
            font-family: var(--font-display);
            font-size: clamp(1.125rem, 2vw, 1.5rem);
            font-weight: 600;
            line-height: 1.4;
            color: var(--neutral-800);
        }

        .body-lg {
            font-family: var(--font-family);
            font-size: 1.125rem;
            font-weight: 400;
            line-height: 1.7;
            color: var(--neutral-700);
        }

        .body-md {
            font-family: var(--font-family);
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.6;
            color: var(--neutral-700);
        }

        .body-sm {
            font-family: var(--font-family);
            font-size: 0.875rem;
            font-weight: 400;
            line-height: 1.5;
            color: var(--neutral-600);
        }

        .caption {
            font-family: var(--font-family);
            font-size: 0.75rem;
            font-weight: 500;
            line-height: 1.4;
            color: var(--neutral-500);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Dashboard Container - Custom Dark Green Theme */
        .dashboard-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-tertiary) 100%);
            position: relative;
        }

        .dashboard-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 280px;
            bottom: 0;
            width: 1px;
            background: linear-gradient(180deg, transparent 0%, rgba(16, 185, 129, 0.2) 50%, transparent 100%);
            z-index: 1;
        }

        /* Enhanced Vertical Sidebar - Much Lighter Theme */
        .sidebar {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            padding: var(--spacing-xl);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xl);
            border-right: 1px solid rgba(52, 211, 153, 0.3);
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
            height: 100vh;
        }



        .sidebar-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: var(--spacing-2xl);
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            position: relative;
            margin-bottom: var(--spacing-lg);
            gap: var(--spacing-lg);
        }

        /* Logo Styling */
        .sidebar-logo {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .sidebar-logo-image {
            height: 50px;
            width: auto;
            filter: brightness(0) invert(1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .sidebar-logo-image:hover {
            transform: scale(1.1);
            opacity: 0.8;
        }

        .dashboard-title {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            width: 100%;
        }

        .dashboard-title h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-main) 0%, var(--primary-hover) 100%);
            color: white;
            padding: var(--spacing-lg) var(--spacing-xl);
            border-radius: var(--radius-xl);
            margin: 0;
            box-shadow: 0 4px 20px rgba(52, 211, 153, 0.4);
            border: 1px solid rgba(52, 211, 153, 0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            letter-spacing: -0.025em;
            line-height: 1.2;
        }

        /* Enhanced Vertical Navigation */
        .navigation {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            padding: 0;
            flex: 1;
        }

        .nav-tab {
            padding: var(--spacing-lg) var(--spacing-xl);
            border: none;
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.85);
            font-family: var(--font-family);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: var(--radius-xl);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            position: relative;
            white-space: nowrap;
            outline: none;
            border: 1px solid rgba(255, 255, 255, 0.12);
            min-height: 52px;
            width: 100%;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateX(6px) scale(1.02);
            border-color: rgba(255, 255, 255, 0.25);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary-main) 0%, var(--primary-hover) 100%);
            color: white;
            transform: translateX(12px) scale(1.05);
            box-shadow: 0 8px 32px rgba(52, 211, 153, 0.5);
            font-weight: 600;
            border-color: var(--primary-main);
        }

        .nav-tab.active::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 70%;
            background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
            border-radius: 0 4px 4px 0;
            box-shadow: 0 2px 8px rgba(255, 255, 255, 0.3);
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: var(--radius-xl);
            z-index: -1;
            opacity: 0.6;
            filter: blur(8px);
        }

        /* Sidebar Quarter Filter */
        .sidebar-quarter-filter {
            margin-top: auto;
            padding-top: var(--spacing-xl);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-quarter-filter-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: var(--spacing-sm);
            display: block;
        }

        .sidebar-quarter-filter-wrapper {
            position: relative;
        }

        .sidebar-quarter-filter-select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md) var(--spacing-xl) var(--spacing-md) var(--spacing-md);
            font-family: var(--font-family);
            font-size: 0.875rem;
            font-weight: 500;
            color: white;
            cursor: pointer;
            transition: all var(--transition-normal);
            width: 100%;
            box-shadow: var(--shadow-md);
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right var(--spacing-md) center;
            background-size: 16px;
        }

        .sidebar-quarter-filter-select:hover {
            background-color: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
        }

        .sidebar-quarter-filter-select:focus {
            outline: none;
            border-color: var(--primary-main);
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3);
            background-color: rgba(255, 255, 255, 0.2);
        }

        .sidebar-quarter-filter-select option {
            background: #1f2937;
            color: white;
            padding: var(--spacing-sm);
            border: none;
        }

        /* Enhanced dropdown styling for better visibility */
        .sidebar-quarter-filter-select::-ms-expand {
            display: none;
        }

        /* Add a subtle glow effect when focused */
        .sidebar-quarter-filter-select:focus {
            outline: none;
            border-color: var(--primary-main);
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3), 0 0 10px rgba(16, 185, 129, 0.2);
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Enhanced Quarter Filter */
        .sidebar-quarter-filter {
            background: rgba(0, 0, 0, 0.25);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            position: relative;
            margin-bottom: var(--spacing-lg);
        }

        /* Connection Status Indicator */
        .connection-status {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            background: linear-gradient(135deg, var(--primary-main) 0%, var(--primary-hover) 100%);
            color: white;
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--radius-full);
            font-size: 0.875rem;
            font-weight: 600;
            box-shadow: 0 2px 10px rgba(52, 211, 153, 0.4);
            margin-top: auto;
        }



        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .quarter-filter-icon {
            position: absolute;
            right: var(--spacing-md);
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            color: var(--neutral-600);
            pointer-events: none;
            transition: transform var(--transition-fast);
        }

        .quarter-filter-select:focus+.quarter-filter-icon {
            transform: translateY(-50%) rotate(180deg);
        }

        /* Enhanced focus indicators for accessibility */
        .nav-tab:focus,
        .nav-tab:focus-visible {
            outline: 2px solid var(--primary-main);
            outline-offset: 2px;
            border-color: var(--primary-main);
            box-shadow: 0 0 0 3px rgba(31, 106, 74, 0.2);
        }

        .nav-tab:focus:not(:focus-visible) {
            outline: none;
            box-shadow: none;
        }

        /* Smooth transitions for tab switching */
        .content-section {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .content-section.active {
            opacity: 1;
            transform: translateY(0);
        }

        /* Enhanced Main Content Area - Dark Theme */
        .main-content {
            padding: var(--spacing-2xl);
            background: transparent;
            overflow-y: auto;
            height: 100vh;
            position: relative;
        }

        /* Custom Scrollbar */
        .main-content::-webkit-scrollbar {
            width: 8px;
        }

        .main-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
        }

        .main-content::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .main-content::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .main-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, rgba(16, 185, 129, 0.3) 50%, transparent 100%);
        }

        .content-header {
            background: var(--bg-card);
            padding: var(--spacing-xl) var(--spacing-2xl);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            margin-bottom: var(--spacing-2xl);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-left: 4px solid var(--primary-main);
            position: relative;
            overflow: hidden;
        }

        .content-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, var(--primary-main) 0%, var(--primary-hover) 100%);
        }

        .content-title {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--text-primary);
            margin: 0;
            letter-spacing: -0.025em;
        }

        /* Content Sections */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* F-Pattern Optimized Grid Layout */
        .content-grid {
            display: grid;
            gap: var(--spacing-lg);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr !important;
            gap: var(--spacing-lg) !important;
        }

        .full-width-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--spacing-lg);
        }

        .two-column-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-lg);
        }

        .three-column-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr) !important;
            gap: var(--spacing-lg) !important;
        }

        .four-column-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr) !important;
            gap: var(--spacing-lg) !important;
        }

        /* Force grid layout - override any conflicts */
        #csat-metrics.four-column-grid {
            display: grid !important;
            grid-template-columns: repeat(4, 1fr) !important;
            gap: var(--spacing-lg) !important;
        }

        /* Fix Service Type Breakdown grid */
        #product-breakdown.three-column-grid {
            display: grid !important;
            grid-template-columns: repeat(3, 1fr) !important;
            gap: var(--spacing-lg) !important;
        }

        /* Fix Account Manager cards grid */
        #account-manager-cards.three-column-grid {
            display: grid !important;
            grid-template-columns: repeat(3, 1fr) !important;
            gap: var(--spacing-lg) !important;
        }





        /* Responsive Design for Vertical Layout */
        @media (max-width: 1024px) {
            .dashboard-container {
                grid-template-columns: 240px 1fr;
            }

            .sidebar {
                padding: var(--spacing-lg);
            }
        }

        @media (max-width: 768px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }

            .sidebar {
                padding: 12px 16px !important;
                flex-direction: row;
                overflow-x: auto;
                border-right: none;
                border-bottom: 1px solid var(--glass-border);
                height: auto !important;
                min-height: 60px;
            }

            .sidebar-header {
                flex-direction: row;
                border-bottom: none;
                border-right: 1px solid rgba(255, 255, 255, 0.1);
                padding-right: 16px !important;
                margin-right: 16px !important;
                margin-bottom: 0 !important;
                padding-bottom: 0 !important;
            }

            .dashboard-title h1 {
                font-size: 1.2rem !important;
                padding: 8px 16px !important;
            }

            .sidebar-logo-image {
                height: 35px !important;
            }

            .navigation {
                flex-direction: row;
                gap: 8px !important;
                flex: 1;
                justify-content: flex-start;
                overflow-x: auto;
                padding: 0 !important;
            }

            .nav-tab {
                white-space: nowrap;
                min-width: auto;
                flex-shrink: 0;
            }

            .sidebar-quarter-filter {
                margin-top: 0;
                padding-top: 0;
                border-top: none;
                border-left: 1px solid rgba(255, 255, 255, 0.1);
                padding-left: 16px !important;
                margin-left: 16px !important;
                min-width: 120px;
                flex-shrink: 0;
            }

            .sidebar-quarter-filter-select {
                min-height: 36px !important;
                font-size: 13px !important;
                padding: 8px 12px !important;
            }

            .main-content {
                height: calc(100vh - 80px);
            }
        }

        /* Modern Responsive Design */
        @media (max-width: 1024px) {

            .metrics-grid,
            #csat-metrics.four-column-grid {
                grid-template-columns: 1fr 1fr !important;
                gap: var(--spacing-xl) !important;
            }

            .three-column-grid,
            #product-breakdown.three-column-grid,
            #account-manager-cards.three-column-grid {
                grid-template-columns: 1fr 1fr !important;
                gap: var(--spacing-xl) !important;
            }

            .four-column-grid {
                grid-template-columns: 1fr 1fr !important;
                gap: var(--spacing-xl) !important;
            }
        }

        @media (max-width: 768px) {

            /* 1. NAVIGATION TABS OPTIMIZATION */
            .nav-tab {
                padding: 10px 16px !important;
                min-height: 40px !important;
                font-size: 14px !important;
                margin-bottom: 8px !important;
            }

            .nav-tab.active {
                border-left: 4px solid var(--primary-main) !important;
                background: rgba(78, 205, 196, 0.15) !important;
            }

            /* 2. CONSISTENT SPACING SYSTEM (8pt Grid) */
            .main-content {
                padding: 16px !important;
            }

            section {
                margin-bottom: 24px !important;
            }

            /* 3. METRIC CARDS 2-COLUMN LAYOUT */
            .metrics-grid,
            .four-column-grid {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 12px !important;
                margin-bottom: 16px !important;
            }

            .metric-card {
                padding: 14px !important;
                min-height: auto !important;
            }

            .metric-card-title {
                font-size: 11px !important;
                font-weight: 600 !important;
                text-transform: uppercase !important;
                letter-spacing: 0.5px !important;
                margin-bottom: 8px !important;
            }

            .metric-value {
                font-size: 28px !important;
                font-weight: 700 !important;
                margin: 8px 0 !important;
            }

            .metric-label {
                font-size: 12px !important;
                opacity: 0.8 !important;
            }

            /* 4. SERVICE TYPE CARDS 2-COLUMN */
            .service-type-grid,
            .three-column-grid {
                grid-template-columns: 1fr 1fr !important;
                gap: 12px !important;
            }

            /* Last card spans full width if odd number */
            .service-type-card:last-child:nth-child(odd) {
                grid-column: 1 / -1 !important;
            }

            /* 5. TYPOGRAPHY IMPROVEMENTS */
            h1,
            .page-title {
                font-size: 22px !important;
                margin-bottom: 16px !important;
            }

            h2,
            .section-title {
                font-size: 18px !important;
                font-weight: 600 !important;
                margin-bottom: 12px !important;
            }

            h3,
            .subsection-title {
                font-size: 16px !important;
                margin-bottom: 8px !important;
            }

            body,
            .body-text {
                font-size: 14px !important;
                line-height: 1.5 !important;
            }

            /* 6. "CONNECTED" BADGE FIX */
            .status-badge,
            .connected-badge,
            .connection-status {
                position: fixed !important;
                bottom: 16px !important;
                right: 16px !important;
                padding: 6px 12px !important;
                font-size: 11px !important;
                z-index: 100 !important;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
            }

            /* 7. QUARTER DROPDOWN */
            .quarter-filter-select,
            .sidebar-quarter-filter-select {
                width: 100% !important;
                min-height: 44px !important;
                font-size: 15px !important;
                padding: 12px 16px !important;
                margin-bottom: 16px !important;
            }

            /* 8. REDUCE EXCESSIVE WHITESPACE */
            .dashboard-header {
                padding: 12px 16px !important;
                margin-bottom: 16px !important;
            }

            .logo-container {
                margin-bottom: 12px !important;
            }

            /* 9. PROGRESS BARS */
            .progress-bar {
                height: 6px !important;
                margin: 8px 0 !important;
            }

            .progress-label {
                font-size: 12px !important;
                margin-bottom: 4px !important;
            }

            /* 10. NPS BREAKDOWN COMPACT VIEW */
            .nps-breakdown {
                display: flex !important;
                flex-direction: column !important;
                gap: 8px !important;
            }

            .nps-item {
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                padding: 8px 12px !important;
                background: rgba(255, 255, 255, 0.05) !important;
                border-radius: 8px !important;
            }

            /* Legacy mobile styles for compatibility */
            .header-content {
                grid-template-columns: 1fr;
                gap: var(--spacing-lg);
                text-align: center;
                padding: var(--spacing-lg) var(--spacing-lg);
            }

            .quarter-filter {
                justify-content: center;
                margin-top: var(--spacing-sm);
            }

            .quarter-filter-select {
                min-width: 140px;
            }

            .navigation {
                justify-content: center;
                flex-wrap: wrap;
                gap: var(--spacing-xs);
                padding: var(--spacing-xs);
            }

            .data-table th,
            .data-table td {
                padding: var(--spacing-md) var(--spacing-lg);
            }

            .accordion-header {
                padding: var(--spacing-xl);
            }
        }

        /* TABLET BREAKPOINT (768px) - Keep 2-column grid for most cards */
        @media (max-width: 768px) and (min-width: 481px) {

            .metrics-grid,
            .four-column-grid {
                grid-template-columns: 1fr 1fr !important;
            }

            .three-column-grid {
                grid-template-columns: 1fr 1fr !important;
            }
        }

        /* PHONE BREAKPOINT (480px and below) - Keep 2-column for metrics, stack service cards if needed */
        @media (max-width: 480px) {
            .header-content {
                padding: var(--spacing-md);
            }

            .logo-image {
                height: 40px;
            }

            .logo-text {
                font-size: 1.5rem;
            }

            .main-content {
                padding: var(--spacing-lg) var(--spacing-md);
            }

            .metric-card {
                padding: var(--spacing-sm);
            }

            .navigation {
                gap: 2px;
                padding: 4px;
            }

            .nav-tab {
                padding: var(--spacing-sm) var(--spacing-md);
                font-size: 0.75rem;
                min-height: 36px;
            }

            .data-table th,
            .data-table td {
                padding: var(--spacing-sm) var(--spacing-md);
                font-size: 0.8rem;
            }

            /* Keep 2-column for metrics on phones */
            .metrics-grid,
            .four-column-grid {
                grid-template-columns: 1fr 1fr !important;
                gap: 8px !important;
            }

            /* Stack service cards if needed on very small screens */
            .service-type-grid,
            .three-column-grid {
                grid-template-columns: 1fr !important;
                gap: 8px !important;
            }
        }

        /* EXTRA SMALL BREAKPOINT (360px) - Ensure minimum readable sizes */
        @media (max-width: 360px) {
            .metric-value {
                font-size: 24px !important;
            }

            .metric-card-title {
                font-size: 10px !important;
            }

            .nav-tab {
                padding: 8px 12px !important;
                font-size: 12px !important;
                min-height: 36px !important;
            }

            .main-content {
                padding: 12px !important;
            }

            .metrics-grid,
            .four-column-grid {
                gap: 6px !important;
            }
        }

        /* Core CSS Components from Design System */

        /* Improved Visibility Metric Cards */
        .metric-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: var(--spacing-md);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border-left: 4px solid var(--primary-main);
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, var(--primary-main) 0%, var(--primary-hover) 100%);
            opacity: 1;
        }

        .metric-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(16, 185, 129, 0.03) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .metric-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 60px rgba(52, 211, 153, 0.3);
            background: var(--bg-card-hover);
            border-color: rgba(52, 211, 153, 0.4);
        }

        .metric-card:hover::before {
            height: 6px;
            opacity: 1;
            background: linear-gradient(90deg, #10b981 0%, #06d6a0 50%, #059669 100%);
        }

        .metric-card:hover::after {
            opacity: 1;
        }

        .metric-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-xs);
        }

        .metric-card-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            letter-spacing: 0.05em;
            text-transform: uppercase;
            margin-bottom: var(--spacing-xs);
        }

        .metric-card-icon {
            width: 32px;
            height: 32px;
            padding: var(--spacing-sm);
            background: var(--primary-gradient);
            border-radius: var(--radius-lg);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .metric-value {
            font-size: clamp(1.2rem, 3vw, 1.8rem);
            font-weight: 700;
            color: var(--text-primary);
            margin: var(--spacing-xs) 0;
            line-height: 1;
            margin-bottom: var(--spacing-xs);
            font-family: var(--font-display);
        }

        .metric-value.large {
            font-size: clamp(1.4rem, 3.5vw, 2rem);
        }

        .metric-value.warning {
            background: var(--warning-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .metric-value.success {
            background: var(--success-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .metric-value.error {
            background: var(--error-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            font-weight: 500;
            line-height: 1.4;
        }

        .metric-change {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: var(--spacing-sm);
        }

        .metric-change.positive {
            color: var(--success-color);
        }

        .metric-change.negative {
            color: var(--error-color);
        }

        /* Modern Animations and Micro-interactions */
        @keyframes countUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.8);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInScale {
            0% {
                opacity: 0;
                transform: scale(0.95) translateY(30px);
            }

            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes slideInFromLeft {
            0% {
                opacity: 0;
                transform: translateX(-30px);
            }

            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInFromRight {
            0% {
                opacity: 0;
                transform: translateX(30px);
            }

            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.8;
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            10%,
            30%,
            50%,
            70%,
            90% {
                transform: translateX(-5px);
            }

            20%,
            40%,
            60%,
            80% {
                transform: translateX(5px);
            }
        }

        .metric-value.animate {
            animation: countUp 1.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .content-section {
            animation: slideInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .metric-card {
            animation: fadeInScale 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .content-header {
            animation: slideInFromLeft 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar {
            animation: slideInFromLeft 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .main-content {
            animation: slideInFromRight 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .data-table-container {
            animation: slideInUp 0.7s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .accordion-card {
            animation: slideInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Stagger animation delays */
        .metric-card:nth-child(1) {
            animation-delay: 0.1s;
        }

        .metric-card:nth-child(2) {
            animation-delay: 0.2s;
        }

        .metric-card:nth-child(3) {
            animation-delay: 0.3s;
        }

        .metric-card:nth-child(4) {
            animation-delay: 0.4s;
        }

        .accordion-card:nth-child(1) {
            animation-delay: 0.1s;
        }

        .accordion-card:nth-child(2) {
            animation-delay: 0.2s;
        }

        .accordion-card:nth-child(3) {
            animation-delay: 0.3s;
        }

        .accordion-card:nth-child(4) {
            animation-delay: 0.4s;
        }

        /* Enhanced metric value transitions */
        .metric-value {
            transition: color 0.3s ease;
        }

        /* Loading state for metric values */
        .metric-value.loading {
            opacity: 0.6;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 0.6;
            }

            50% {
                opacity: 0.3;
            }
        }

        /* Modern Data Table for White Background */
        .data-table-container {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: all var(--transition-normal);
            border-left: 4px solid var(--primary-main);
        }

        .data-table-container:hover {
            box-shadow: var(--shadow-2xl);
            transform: translateY(-2px);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-family: var(--font-family);
            font-size: 0.875rem;
        }

        .data-table thead {
            background: rgba(52, 211, 153, 0.2);
            color: var(--text-primary);
            position: relative;
        }

        .data-table thead::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: rgba(255, 255, 255, 0.2);
        }

        .data-table th {
            padding: var(--spacing-lg) var(--spacing-xl);
            text-align: left;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border: none;
            position: relative;
        }

        .data-table td {
            padding: var(--spacing-lg) var(--spacing-xl);
            border: none;
            vertical-align: middle;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
        }

        .data-table tbody tr {
            transition: all var(--transition-fast);
            position: relative;
        }

        .data-table tbody tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        .data-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transform: scale(1.01);
        }

        .data-table tbody tr:hover td {
            border-bottom-color: rgba(255, 255, 255, 0.2);
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .table-cell-link {
            color: var(--text-primary);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease;
            /* Accessibility enhancements */
            outline: none;
            border-radius: var(--radius-sm);
            padding: 2px 4px;
            margin: -2px -4px;
        }

        .table-cell-link:hover {
            color: var(--primary-main);
            text-decoration: underline;
        }

        /* Enhanced focus indicators for table links */
        .table-cell-link:focus,
        .table-cell-link:focus-visible {
            outline: 2px solid var(--primary-main);
            outline-offset: 2px;
            background: var(--primary-focus);
            text-decoration: underline;
        }

        .table-cell-link:focus:not(:focus-visible) {
            outline: none;
            background: transparent;
        }

        .table-status-badge {
            display: inline-block;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table-status-badge.completed {
            background: var(--success-color);
            color: white;
        }

        .table-status-badge.pending {
            background: var(--warning-color);
            color: white;
        }

        /* Modern Accordion for White Background */
        .accordion-container {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }

        .accordion-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: var(--glass-backdrop);
            -webkit-backdrop-filter: var(--glass-backdrop);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            transition: all var(--transition-normal);
            position: relative;
        }

        .accordion-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-gradient);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .accordion-card:hover {
            box-shadow: var(--shadow-2xl);
            transform: translateY(-4px);
            background: rgba(255, 255, 255, 0.95);
        }

        .accordion-card:hover::before {
            opacity: 1;
        }

        .accordion-card.expanded {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: var(--shadow-2xl);
        }

        .accordion-card.expanded::before {
            opacity: 1;
            height: 4px;
        }

        .accordion-header {
            padding: var(--spacing-2xl);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: transparent;
            border: none;
            width: 100%;
            text-align: left;
            transition: all var(--transition-normal);
            position: relative;
            outline: none;
            border: 2px solid transparent;
        }

        .accordion-header:hover {
            background: rgba(0, 0, 0, 0.03);
        }

        .accordion-header:focus {
            background: rgba(0, 0, 0, 0.05);
            outline: 2px solid var(--primary-main);
            outline-offset: -2px;
        }

        /* Enhanced focus indicators for accordion headers */
        .accordion-header:focus,
        .accordion-header:focus-visible {
            outline: 2px solid var(--primary-main);
            outline-offset: -2px;
            border-color: var(--primary-main);
            box-shadow: 0 0 0 3px rgba(31, 106, 74, 0.2);
            background: var(--primary-focus);
        }

        .accordion-header:focus:not(:focus-visible) {
            outline: none;
            box-shadow: none;
        }

        .accordion-header-content {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            flex: 1;
        }

        .accordion-title {
            font-family: var(--font-family);
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--primary-main);
            margin: 0;
        }

        .accordion-subtitle {
            font-family: var(--font-family);
            font-size: 0.875rem;
            color: #666;
            margin: 0;
        }

        .accordion-meta {
            display: flex;
            gap: var(--spacing-lg);
            align-items: center;
        }

        .accordion-rating {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-weight: 600;
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--radius-full);
            font-size: 0.875rem;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: var(--shadow-md);
        }

        .accordion-rating::before {
            content: '';
            position: absolute;
            inset: 0;
            opacity: 0.9;
            z-index: -1;
        }

        .accordion-rating.excellent::before {
            background: var(--success-gradient);
        }

        .accordion-rating.excellent {
            color: white;
        }

        .accordion-rating.good::before {
            background: var(--primary-gradient);
        }

        .accordion-rating.good {
            color: white;
        }

        .accordion-rating.average::before {
            background: var(--warning-gradient);
        }

        .accordion-rating.average {
            color: white;
        }

        .accordion-rating.poor::before {
            background: var(--error-gradient);
        }

        .accordion-rating.poor {
            color: white;
        }

        .accordion-icon {
            width: 20px;
            height: 20px;
            transition: transform 0.3s ease;
            color: var(--primary-main);
        }

        .accordion-card.expanded .accordion-icon {
            transform: rotate(180deg);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            background: var(--primary-surface);
        }

        .accordion-card.expanded .accordion-content {
            /* Allow full content to be visible */
            max-height: none !important;
            overflow: visible !important;
            padding: var(--spacing-lg);
            height: auto;
        }

        .accordion-body {
            display: grid;
            gap: var(--spacing-md);
        }

        .survey-question {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: var(--spacing-md);
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid var(--primary-border);
        }

        .survey-question:last-child {
            border-bottom: none;
        }

        .survey-question-label {
            font-weight: 500;
            color: var(--primary-main);
            font-size: 0.875rem;
        }

        .survey-question-answer {
            color: #333;
            font-size: 0.875rem;
        }

        /* Modern Progress Bar Component */
        .progress-container {
            margin: var(--spacing-xs) 0;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            font-size: 0.875rem;
        }

        .progress-label-text {
            font-weight: 500;
            color: var(--neutral-700);
        }

        .progress-label-value {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: var(--radius-full);
            overflow: hidden;
            position: relative;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .progress-bar.large {
            height: 16px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--primary-main) 0%, var(--primary-hover) 100%);
            border-radius: var(--radius-full);
            transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .progress-fill.success {
            background: var(--success-color);
        }

        .progress-fill.warning {
            background: var(--warning-color);
        }

        .progress-fill.error {
            background: var(--error-color);
        }

        /* Modern progress bar shine animation */
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg,
                    transparent,
                    rgba(255, 255, 255, 0.6),
                    transparent);
            animation: progressShine 3s ease-in-out infinite;
        }

        @keyframes progressShine {
            0% {
                transform: translateX(-100%);
            }

            50% {
                transform: translateX(100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .progress-fill.success {
            background: var(--success-gradient);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
        }

        .progress-fill.warning {
            background: var(--warning-gradient);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
        }

        .progress-fill.error {
            background: var(--error-gradient);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        }

        /* Satisfaction Rate Color Coding */
        .metric-value.satisfaction-red {
            background: #ef4444 !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
            color: #ef4444 !important;
        }

        .metric-value.satisfaction-orange {
            background: var(--secondary-main) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
            color: var(--secondary-main) !important;
        }

        .metric-value.satisfaction-green {
            background: var(--primary-main) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
            color: var(--primary-main) !important;
        }

        .progress-fill.satisfaction-red {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        }

        .progress-fill.satisfaction-orange {
            background: linear-gradient(135deg, var(--secondary-main) 0%, var(--secondary-pressed) 100%) !important;
            box-shadow: 0 2px 8px rgba(255, 157, 24, 0.4);
        }

        .progress-fill.satisfaction-green {
            background: linear-gradient(135deg, var(--primary-main) 0%, var(--primary-hover) 100%) !important;
            box-shadow: 0 2px 8px rgba(52, 211, 153, 0.5);
        }

        /* Card Accent Colors for Different Metrics */
        .metric-card.accent-green {
            border-left-color: var(--primary-main);
        }

        .metric-card.accent-orange {
            border-left-color: var(--secondary-main);
        }

        .metric-card.accent-red {
            border-left-color: #ef4444;
        }

        .metric-card.accent-blue {
            border-left-color: #3b82f6;
        }

        .metric-card.accent-purple {
            border-left-color: #8b5cf6;
        }

        /* Enhanced card spacing and layout */
        .content-grid {
            gap: var(--spacing-xl);
        }

        .three-column-grid {
            gap: var(--spacing-xl) !important;
        }

        .four-column-grid {
            gap: var(--spacing-xl) !important;
        }

        /* Mobile-specific grid improvements */
        @media (max-width: 768px) {
            .content-grid {
                gap: 16px !important;
            }

            /* Ensure service type cards work properly */
            .service-type-grid {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 12px !important;
            }

            /* Product breakdown cards */
            #product-breakdown {
                grid-template-columns: 1fr 1fr !important;
                gap: 12px !important;
            }

            /* Account manager cards */
            #account-manager-cards {
                grid-template-columns: 1fr 1fr !important;
                gap: 12px !important;
            }

            /* Mobile typography scale */
            .content-title {
                font-size: 1.5rem !important;
            }

            .content-header {
                padding: 16px 20px !important;
                margin-bottom: 20px !important;
            }

            /* Mobile-friendly table scrolling */
            .data-table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* Improved mobile touch targets */
            .accordion-header,
            .nav-tab,
            .quarter-filter-select {
                -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
                /* tap-highlight-color: rgba(0,0,0,0.1); */
                /* Non-webkit fallback */
            }

            /* Mobile-optimized loading states */
            .skeleton-card {
                border-radius: 12px !important;
            }

            /* Better mobile spacing for sections */
            .content-section {
                padding: 0 !important;
            }

            /* Mobile-friendly status badges */
            .table-status-badge {
                font-size: 10px !important;
                padding: 4px 8px !important;
            }
        }

        /* Account Manager Table Specific Styles */
        .progress-container-inline {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            width: 100%;
        }

        .progress-bar-inline {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: var(--radius-full);
            overflow: hidden;
            position: relative;
        }

        .progress-percentage {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
            min-width: 40px;
            text-align: right;
        }

        .completion-count {
            font-weight: 600;
            color: var(--text-primary);
        }

        .pending-count {
            font-weight: 600;
            color: var(--text-tertiary);
        }

        .pending-count.has-pending {
            color: var(--secondary-main);
        }

        .csat-percentage {
            font-weight: 700;
            font-size: 1rem;
        }

        /* Account Manager and Date Badge Styles */
        .account-manager-badge,
        .completion-date-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
            color: white;
            text-align: center;
            min-width: 120px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .account-manager-badge:hover,
        .completion-date-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* Account Manager Colors */
        .account-manager-abdullah {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            /* Blue */
        }

        .account-manager-ahmed {
            background: linear-gradient(135deg, #800000 0%, #4b0000 100%);
            /* Yellow/Orange */
        }

        .account-manager-ibrahim {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            /* Purple */
        }

        .account-manager-ops {
            background: linear-gradient(135deg, #000080 0%, #00004b 100%);
            /* Brown */
        }

        .account-manager-default {
            background: linear-gradient(135deg, #800000 0%, #4b0000 100%);
            /* Gray for unknown managers */
        }

        /* Completion Date Badge */
        .completion-date-badge {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            /* Dark blue/black */
            min-width: 140px;
        }

        /* Modern Skeleton Loading Animation */
        .skeleton {
            background: linear-gradient(90deg,
                    rgba(255, 255, 255, 0.1) 25%,
                    rgba(255, 255, 255, 0.3) 50%,
                    rgba(255, 255, 255, 0.1) 75%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite ease-in-out;
            border-radius: var(--radius-lg);
            position: relative;
            overflow: hidden;
        }

        .skeleton::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg,
                    transparent,
                    rgba(255, 255, 255, 0.4),
                    transparent);
            animation: shimmer 2s infinite ease-in-out;
        }

        .skeleton-text {
            height: 1rem;
            margin-bottom: var(--spacing-xs);
        }

        .skeleton-text.large {
            height: 1.5rem;
        }

        .skeleton-text.small {
            height: 0.75rem;
        }

        .skeleton-text.title {
            height: 2rem;
            width: 60%;
        }

        .skeleton-card {
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            border: 1px solid var(--primary-border);
        }

        .skeleton-metric {
            height: 3rem;
            width: 80%;
            margin-bottom: var(--spacing-sm);
        }

        .skeleton-table-row {
            height: 3rem;
            margin-bottom: var(--spacing-xs);
        }

        .skeleton-progress {
            height: 8px;
            width: 100%;
            margin: var(--spacing-sm) 0;
        }

        .skeleton-table-row {
            height: 3rem;
            width: 100%;
            margin-bottom: var(--spacing-xs);
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        /* Loading state overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--primary-border);
            border-top: 3px solid var(--primary-main);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Component Responsive Adjustments */
        @media (max-width: 768px) {

            /* Enhanced touch targets for mobile */
            .nav-tab,
            .accordion-header,
            .quarter-filter-select {
                min-height: 44px !important;
                touch-action: manipulation;
            }

            /* Improved card spacing */
            .metric-card {
                padding: 14px !important;
                margin-bottom: 12px;
            }

            .metric-value {
                font-size: 28px !important;
                line-height: 1.1;
            }

            .metric-value.large {
                font-size: 32px !important;
            }

            /* Better table readability */
            .data-table th,
            .data-table td {
                padding: 12px 8px !important;
                font-size: 13px !important;
            }

            .data-table {
                font-size: 13px !important;
            }

            /* Compact accordion for mobile */
            .accordion-header {
                padding: 16px !important;
            }

            .accordion-card.expanded .accordion-content {
                padding: 16px !important;
            }

            .survey-question {
                grid-template-columns: 1fr;
                gap: 8px !important;
                padding: 12px 0 !important;
            }

            /* Mobile-optimized progress bars */
            .progress-container-inline {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }

            .progress-bar-inline {
                width: 100%;
            }

            /* Better badge positioning */
            .account-manager-badge,
            .completion-date-badge {
                min-width: 100px;
                font-size: 12px !important;
                padding: 6px 12px !important;
            }

            /* Improved skeleton loading for mobile */
            .skeleton-card {
                padding: 14px !important;
            }

            .skeleton-text {
                height: 14px !important;
            }

            .skeleton-text.large {
                height: 20px !important;
            }
        }

        /* Error Handling and User Feedback Styles */
        .error-container {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 400px;
            z-index: 1000;
            pointer-events: none;
        }

        .error-message {
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
            box-shadow: var(--shadow-lg);
            pointer-events: auto;
            font-family: var(--font-family);
            font-size: 0.875rem;
            line-height: 1.4;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            animation: slideInRight 0.3s ease-out;
        }

        .error-message.error {
            background: var(--error-color);
            color: white;
        }

        .error-message.warning {
            background: var(--warning-color);
            color: white;
        }

        .error-message.info {
            background: var(--primary-main);
            color: white;
        }

        .error-message.success {
            background: var(--success-color);
            color: white;
        }

        .error-message-content {
            flex: 1;
            margin-right: var(--spacing-sm);
        }

        .error-message-close {
            background: none;
            border: none;
            color: inherit;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }

        .error-message-close:hover {
            opacity: 1;
        }

        /* Empty State Styles */
        .empty-state {
            text-align: center;
            padding: var(--spacing-2xl);
            color: #666;
        }

        .empty-state-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto var(--spacing-lg);
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-main);
            margin-bottom: var(--spacing-sm);
        }

        .empty-state-description {
            font-size: 0.875rem;
            line-height: 1.5;
            margin-bottom: var(--spacing-lg);
        }

        .empty-state-action {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: var(--spacing-md) var(--spacing-2xl);
            border-radius: var(--radius-full);
            font-family: var(--font-family);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            outline: none;
            border: 2px solid transparent;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .empty-state-action::before {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--primary-gradient);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .empty-state-action:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }

        .empty-state-action:hover::before {
            opacity: 0.1;
        }

        .empty-state-action:active {
            transform: translateY(0);
            box-shadow: var(--shadow-md);
        }

        /* Enhanced focus indicators for buttons */
        .empty-state-action:focus,
        .empty-state-action:focus-visible {
            outline: 2px solid var(--primary-main);
            outline-offset: 2px;
            border-color: white;
            box-shadow: 0 0 0 4px rgba(31, 106, 74, 0.2);
        }

        .empty-state-action:focus:not(:focus-visible) {
            outline: none;
            box-shadow: none;
        }

        /* Loading States */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-2xl);
            min-height: 200px;
        }

        .loading-spinner-large {
            width: 48px;
            height: 48px;
            border: 4px solid var(--primary-border);
            border-top: 4px solid var(--primary-main);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: var(--spacing-lg);
        }

        .loading-text {
            color: #666;
            font-size: 0.875rem;
            text-align: center;
        }

        /* Progress Indicators */
        .progress-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-surface);
            z-index: 1001;
            overflow: hidden;
        }

        .progress-indicator-bar {
            height: 100%;
            background: var(--primary-main);
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
        }

        .progress-indicator-bar.indeterminate {
            width: 30%;
            animation: progressIndeterminate 2s linear infinite;
        }

        @keyframes progressIndeterminate {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(400%);
            }
        }

        /* Retry Button */
        .retry-button {
            background: var(--secondary-main);
            color: white;
            border: none;
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--radius-md);
            font-family: var(--font-family);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            /* Accessibility enhancements */
            outline: none;
            border: 2px solid transparent;
        }

        .retry-button:hover {
            background: var(--secondary-hover);
        }

        .retry-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Enhanced focus indicators for retry button */
        .retry-button:focus,
        .retry-button:focus-visible {
            outline: 2px solid var(--secondary-main);
            outline-offset: 2px;
            border-color: white;
            box-shadow: 0 0 0 4px rgba(255, 157, 24, 0.2);
        }

        .retry-button:focus:not(:focus-visible) {
            outline: none;
            box-shadow: none;
        }

        /* Connection Status Indicator */
        .connection-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-md);
            font-size: 0.75rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .connection-status.online {
            background: var(--success-color);
            color: white;
        }

        .connection-status.offline {
            background: var(--error-color);
            color: white;
        }

        .connection-status.reconnecting {
            background: var(--warning-color);
            color: white;
        }

        .connection-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        /* Partial Data Warning */
        .partial-data-warning {
            background: var(--secondary-surface);
            border: 1px solid var(--secondary-border);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-sm);
        }

        .partial-data-warning-icon {
            color: var(--secondary-main);
            font-size: 1.2rem;
            margin-top: 2px;
        }

        .partial-data-warning-content {
            flex: 1;
        }

        .partial-data-warning-title {
            font-weight: 600;
            color: var(--secondary-pressed);
            margin-bottom: var(--spacing-xs);
            font-size: 0.875rem;
        }

        .partial-data-warning-text {
            font-size: 0.8rem;
            color: #666;
            line-height: 1.4;
        }

        /* Animation Keyframes */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }

            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        /* Responsive adjustments for error handling */
        @media (max-width: 768px) {
            .error-container {
                left: 20px;
                right: 20px;
                max-width: none;
            }

            .connection-status {
                left: 50%;
                transform: translateX(-50%);
            }

            .empty-state {
                padding: var(--spacing-lg);
            }

            .loading-state {
                padding: var(--spacing-lg);
                min-height: 150px;
            }
        }

        /* Accessibility Enhancements */

        /* Screen reader only content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }



        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --primary-main: #000000;
                --primary-surface: #ffffff;
                --primary-border: #000000;
                --secondary-main: #ff6600;
            }

            /* removed debug borders */
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }

            .metric-value.animate {
                animation: none;
            }

            .progress-fill {
                transition: none;
            }
        }

        /* Focus management for modal-like states */
        .focus-trap {
            position: relative;
        }

        .focus-trap::before,
        .focus-trap::after {
            content: '';
            position: absolute;
            width: 1px;
            height: 1px;
            opacity: 0;
            pointer-events: none;
        }

        /* Enhanced keyboard navigation indicators */
        .keyboard-navigation-active *:focus {
            outline: 2px solid var(--primary-main) !important;
            outline-offset: 2px !important;
        }

        /* Performance optimizations for large datasets */
        .virtual-scroll-container {
            height: 400px;
            overflow-y: auto;
            position: relative;
        }

        .virtual-scroll-content {
            position: relative;
        }

        .virtual-scroll-item {
            position: absolute;
            width: 100%;
            left: 0;
        }

        /* Optimize rendering for large tables */
        .data-table {
            contain: layout style paint;
            will-change: scroll-position;
        }

        .data-table tbody {
            contain: layout style;
        }

        /* GPU acceleration for animations */
        .metric-value.animate,
        .progress-fill,
        .accordion-content {
            will-change: transform, opacity;
            transform: translateZ(0);
        }

        /* Cross-browser compatibility */
        .nav-tab,
        .accordion-header,
        .table-cell-link,
        .empty-state-action,
        .retry-button {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        /* Vendor prefixes for animations */
        @-webkit-keyframes countUp {
            from {
                opacity: 0;
                -webkit-transform: translateY(20px);
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                -webkit-transform: translateY(0);
                transform: translateY(0);
            }
        }

        @-webkit-keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        @-webkit-keyframes spin {
            0% {
                -webkit-transform: rotate(0deg);
                transform: rotate(0deg);
            }

            100% {
                -webkit-transform: rotate(360deg);
                transform: rotate(360deg);
            }
        }

        /* Utility Classes */
        .text-center {
            text-align: center;
        }

        .mb-lg {
            margin-bottom: var(--spacing-md);
        }

        .mt-lg {
            margin-top: var(--spacing-lg);
        }

        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        .fade-out {
            animation: fadeOut 0.3s ease-out;
        }

        /* Responsive font scaling for better readability */
        @media (max-width: 480px) {
            html {
                font-size: 14px;
            }
        }

        @media (min-width: 1200px) {
            html {
                font-size: 16px;
            }
        }

        /* Print styles for accessibility */
        @media print {

            .navigation,
            .error-container,
            .connection-status,
            .progress-indicator {
                display: none !important;
            }

            .content-section {
                display: block !important;
            }

            .accordion-content {
                /* max-height will be set dynamically by JavaScript */
                padding: var(--spacing-md) !important;
            }
        }

        /* IMPROVED MOBILE RESPONSIVENESS */

        /* Tablet Responsive Design - 768px and below */
        @media (max-width: 768px) {

            /* Dashboard Layout */
            .dashboard-container {
                grid-template-columns: 1fr !important;
                grid-template-rows: auto 1fr;
                min-height: 100vh;
            }

            /* Sidebar becomes horizontal navigation */
            .sidebar {
                padding: var(--spacing-md);
                flex-direction: column;
                height: auto;
                border-right: none;
                border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            }

            .sidebar-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                padding-bottom: var(--spacing-md);
                margin-bottom: var(--spacing-md);
            }

            .dashboard-title h1 {
                font-size: 1.25rem;
                padding: var(--spacing-md) var(--spacing-lg);
            }

            /* Navigation becomes horizontal scrollable */
            .navigation {
                flex-direction: row;
                gap: var(--spacing-sm);
                overflow-x: auto;
                padding: var(--spacing-sm) 0;
                -webkit-overflow-scrolling: touch;
            }

            .nav-tab {
                white-space: nowrap;
                min-width: 120px;
                padding: var(--spacing-md) var(--spacing-lg);
                font-size: 0.875rem;
                min-height: 44px;
                /* Touch-friendly size */
            }

            /* Quarter filter */
            .sidebar-quarter-filter {
                margin-top: var(--spacing-md);
                padding-top: var(--spacing-md);
                border-top: 1px solid rgba(255, 255, 255, 0.1);
            }

            .sidebar-quarter-filter-select {
                min-height: 44px;
                /* Touch-friendly size */
                font-size: 1rem;
            }

            /* Main content adjustments */
            .main-content {
                padding: var(--spacing-lg) var(--spacing-md);
                height: auto;
            }

            /* Grid layouts stack vertically */
            .four-column-grid,
            .three-column-grid,
            .two-column-grid {
                grid-template-columns: 1fr 1fr !important;
                gap: var(--spacing-md) !important;
            }

            /* Metric cards */
            .metric-card {
                padding: var(--spacing-sm);
                border-radius: 12px;
            }

            .metric-card-title {
                font-size: 0.7rem;
            }

            .metric-value {
                font-size: clamp(1rem, 4vw, 1.4rem);
                margin: var(--spacing-xs) 0;
            }

            .metric-value.large {
                font-size: clamp(1.2rem, 4.5vw, 1.6rem);
            }

            .metric-label {
                font-size: 0.7rem;
            }

            /* Tables become horizontally scrollable */
            .data-table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .data-table {
                min-width: 600px;
                font-size: 0.875rem;
            }

            .data-table th,
            .data-table td {
                padding: var(--spacing-sm) var(--spacing-md);
                white-space: nowrap;
            }

            /* Accordion adjustments */
            .accordion-header {
                padding: var(--spacing-md);
                min-height: 44px;
                /* Touch-friendly */
            }

            .accordion-title {
                font-size: 1rem;
            }

            .accordion-subtitle {
                font-size: 0.8rem;
            }

            /* Progress bars */
            .progress-bar {
                height: 8px;
            }

            .progress-bar.large {
                height: 12px;
            }

            /* Account manager badges */
            .account-manager-badge,
            .completion-date-badge {
                padding: var(--spacing-xs) var(--spacing-sm);
                font-size: 0.8rem;
                min-width: 100px;
            }

            /* Button and interactive elements */
            .empty-state-action,
            .retry-button {
                min-height: 44px;
                padding: var(--spacing-md) var(--spacing-lg);
                font-size: 1rem;
            }
        }

        /* Mobile Phone Responsive Design - 480px and below */
        @media (max-width: 480px) {

            /* Further reduce font sizes */
            html {
                font-size: 14px;
            }

            /* Dashboard adjustments */
            .main-content {
                padding: var(--spacing-md) var(--spacing-sm);
            }

            /* All grids become single column */
            .four-column-grid,
            .three-column-grid,
            .two-column-grid {
                grid-template-columns: 1fr !important;
                gap: var(--spacing-sm) !important;
            }

            /* Sidebar adjustments */
            .sidebar {
                padding: var(--spacing-sm);
            }

            .sidebar-header {
                padding-bottom: var(--spacing-sm);
                margin-bottom: var(--spacing-sm);
            }

            .dashboard-title h1 {
                font-size: 1.1rem;
                padding: var(--spacing-sm) var(--spacing-md);
            }

            .sidebar-logo-image {
                height: 40px;
            }

            /* Navigation */
            .nav-tab {
                min-width: 100px;
                padding: var(--spacing-sm) var(--spacing-md);
                font-size: 0.8rem;
            }

            /* Metric cards */
            .metric-card {
                padding: var(--spacing-xs);
                border-radius: 8px;
            }

            .metric-card-title {
                font-size: 0.65rem;
                margin-bottom: 2px;
            }

            .metric-value {
                font-size: clamp(0.9rem, 5vw, 1.2rem);
                margin: 2px 0;
            }

            .metric-value.large {
                font-size: clamp(1rem, 5.5vw, 1.4rem);
            }

            .metric-label {
                font-size: 0.65rem;
            }

            /* Progress containers */
            .progress-container {
                margin: 2px 0;
            }

            .progress-label-text,
            .progress-label-value {
                font-size: 0.65rem;
            }

            /* Tables */
            .data-table {
                font-size: 0.8rem;
                min-width: 500px;
            }

            .data-table th,
            .data-table td {
                padding: var(--spacing-xs) var(--spacing-sm);
            }

            /* Accordion */
            .accordion-header {
                padding: var(--spacing-sm);
            }

            .accordion-title {
                font-size: 0.9rem;
            }

            .accordion-subtitle {
                font-size: 0.75rem;
            }

            .accordion-rating {
                padding: var(--spacing-xs) var(--spacing-sm);
                font-size: 0.75rem;
            }

            /* Account manager badges */
            .account-manager-badge,
            .completion-date-badge {
                padding: 4px var(--spacing-xs);
                font-size: 0.7rem;
                min-width: 80px;
            }

            /* Survey questions in accordion */
            .survey-question {
                grid-template-columns: 1fr;
                gap: var(--spacing-xs);
                padding: var(--spacing-xs) 0;
            }

            .survey-question-label {
                font-size: 0.8rem;
                font-weight: 600;
            }

            .survey-question-answer {
                font-size: 0.75rem;
                padding-left: var(--spacing-sm);
            }

            /* Error messages and empty states */
            .error-message {
                font-size: 0.8rem;
                padding: var(--spacing-sm);
            }

            .empty-state {
                padding: var(--spacing-md);
            }

            .empty-state-title {
                font-size: 1.1rem;
            }

            .empty-state-description {
                font-size: 0.8rem;
            }

            /* Progress bars inline (account manager table) */
            .progress-container-inline {
                flex-direction: column;
                align-items: stretch;
                gap: var(--spacing-xs);
            }

            .progress-percentage {
                text-align: center;
                min-width: auto;
            }
        }

        /* Extra small screens - 360px and below */
        @media (max-width: 360px) {
            .nav-tab {
                min-width: 80px;
                padding: var(--spacing-xs) var(--spacing-sm);
                font-size: 0.75rem;
            }

            .metric-card {
                padding: 4px;
            }

            .metric-card-title {
                font-size: 0.6rem;
            }

            .metric-value {
                font-size: clamp(0.8rem, 6vw, 1rem);
            }

            .metric-value.large {
                font-size: clamp(0.9rem, 6.5vw, 1.2rem);
            }

            .data-table {
                min-width: 400px;
                font-size: 0.75rem;
            }
        }

        /* Landscape orientation adjustments for mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .sidebar {
                flex-direction: row;
                align-items: center;
                padding: var(--spacing-sm) var(--spacing-md);
            }

            .sidebar-header {
                flex-direction: row;
                border-bottom: none;
                border-right: 1px solid rgba(255, 255, 255, 0.1);
                padding-right: var(--spacing-md);
                margin-right: var(--spacing-md);
                margin-bottom: 0;
            }

            .navigation {
                flex: 1;
                justify-content: center;
            }

            .sidebar-quarter-filter {
                margin-top: 0;
                padding-top: 0;
                border-top: none;
                border-left: 1px solid rgba(255, 255, 255, 0.1);
                padding-left: var(--spacing-md);
                margin-left: var(--spacing-md);
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {

            /* Increase touch targets */
            .nav-tab,
            .accordion-header,
            .table-cell-link,
            .empty-state-action,
            .retry-button,
            .sidebar-quarter-filter-select {
                min-height: 44px;
                min-width: 44px;
            }

            /* Remove hover effects on touch devices */
            .metric-card:hover,
            .nav-tab:hover,
            .accordion-card:hover {
                transform: none;
                box-shadow: inherit;
            }

            /* Improve tap highlighting */
            .nav-tab,
            .accordion-header,
            .table-cell-link {
                -webkit-tap-highlight-color: rgba(52, 211, 153, 0.3);
            }
        }
    </style>
</head>

<body>
    <!-- Google Sheets API Integration Script -->
    <script>
        // Google Sheets API Configuration
        // To use this integration:
        // 1. Create a Google Cloud Project and enable the Sheets API
        // 2. Create a service account and download the JSON key file
        // Secure configuration - API keys are handled server-side only
        // No sensitive data exposed in client-side code

        const API_CONFIG = {
            baseUrl: '/api',
            endpoints: {
                // Use server-side proxy for all requests (production-ready)
                sheetsData: '/api/sheets-data'
            }
        };

        // Data cache configuration
        const CACHE_CONFIG = {
            duration: 30000, // 30 seconds in milliseconds
            retryInterval: 30000, // 30 seconds retry interval
            maxRetries: 3
        };

        // Global data cache
        let dataCache = {
            data: null,
            timestamp: null,
            isLoading: false,
            retryCount: 0
        };

        // Error handling utilities
        class APIError extends Error {
            constructor(message, type, statusCode = null) {
                super(message);
                this.name = 'APIError';
                this.type = type;
                this.statusCode = statusCode;
            }
        }

        // Google Sheets API Integration Class
        class GoogleSheetsAPI {
            constructor(config) {
                this.config = config;
            }

            /**
             * Fetch data directly from Google Sheets API (for testing)
             */
            async fetchSheetData() {
                try {
                    const response = await fetch(this.config.endpoints.sheetsData, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new APIError(
                            `HTTP ${response.status}: ${response.statusText}`,
                            'HTTP_ERROR',
                            response.status
                        );
                    }

                    const data = await response.json();

                    if (!data.values || !Array.isArray(data.values)) {
                        throw new APIError(
                            'Invalid data format received from Google Sheets',
                            'DATA_FORMAT_ERROR'
                        );
                    }

                    return this.parseSheetData(data.values);
                } catch (error) {
                    // Fallback to mock data when API fails

                    return generateMockSurveyData();
                }
            }

            /**
             * Parse raw sheet data into structured survey responses (header-based, bilingual)
             */
            parseSheetData(rawData) {
                if (rawData.length < 2) {
                    throw new APIError(
                        'Sheet must contain at least a header row and one data row',
                        'INSUFFICIENT_DATA'
                    );
                }

                const headers = rawData[0].map(h => this.normalizeHeader(String(h || '')));
                const dataRows = rawData.slice(1);

                // Helper: find first matching header index from an alias list
                const findIndex = (aliases) => {
                    for (const alias of aliases) {
                        const norm = this.normalizeHeader(alias);
                        let idx = headers.findIndex(h => h === norm);
                        if (idx !== -1) return idx;
                        // Fallback to partial match to tolerate minor differences
                        idx = headers.findIndex(h => h.includes(norm) || norm.includes(h));
                        if (idx !== -1) return idx;
                    }
                    return -1;
                };

                // Helper: find ALL matching header indices from an alias list
                const findAllIndices = (aliases) => {
                    const indices = [];
                    for (const alias of aliases) {
                        const norm = this.normalizeHeader(alias);
                        // Find exact matches first
                        headers.forEach((h, idx) => {
                            if (h === norm && !indices.includes(idx)) {
                                indices.push(idx);
                            }
                        });
                        // Then partial matches
                        headers.forEach((h, idx) => {
                            if ((h.includes(norm) || norm.includes(h)) && !indices.includes(idx)) {
                                indices.push(idx);
                            }
                        });
                    }
                    return indices;
                };

                // Aliases for bilingual/variant headers
                const H = {
                    language: [
                        '  | choose your language',
                        'choose your language',
                        'language'
                    ],
                    companyNameAr: ['   ', '   '],
                    companyNameEn: ['please provide your company name'],
                    serviceTypeAr: [' '],
                    serviceTypeEn: ['service type'],
                    overallAr: ['       '],
                    overallEn: ['how satisfied are you with the overall experience with starlinks', 'how satisfied are you with the overall experience with starlinks?', 'how satisfied are you with the overall experience with starlinks ', 'how satisfied are you with the overall experience with starlinks? '],
                    npsAr: ['       '],
                    npsEn: ['how likely are you to recommend starlinks to other businesses?', 'how likely are you to recommend starlinks to other businesses', 'how likely are you to recommend starlinks to other businesses ', 'how likely are you to recommend starlinks to other businesses? ', 'how likely are you to recommend *starlinks* to other businesses?', 'how likely are you to recommend *starlinks* to other businesses', 'how likely are you to recommend *starlinks* to other businesses?'],
                    lastMileAr: ['     '],
                    lastMileEn: ['how satisfied are you with the last mile delivery services', 'how satisfied are you with the *last-mile *delivery services?', 'how satisfied are you with the last mile delivery services', 'how satisfied are you with the *last-mile *delivery services', 'how satisfied are you with the *last-mile *delivery services?'],
                    reverseAr: ['      ( )', '      ( '],
                    reverseEn: ['how satisfied are you with the *reverse* delivery services? (if applicable)', 'how satisfied are you with the reverse delivery services (if applicable)', 'how satisfied are you with the *reverse* delivery services? *(if applicable', 'how satisfied are you with the *reverse* delivery services? (if applicable) ', 'how satisfied are you with the *reverse* delivery services? *(if applicable)*'],
                    fulfillmentAr: ['        ( )', '        ( '],
                    fulfillmentEn: ['how satisfied are you with the *fulfillment* services?* (if applicable)', 'how satisfied are you with the *fulfillment* services?* (if applicable) *', 'how satisfied are you with the fulfillment services (if applicable)', 'how satisfied are you with the *fulfillment* services? *(if applicable)*'],
                    commAr: ['  '],
                    commEn: ['clarity of communication you receive'],
                    respAr: ['    '],
                    respEn: ['responsiveness and professionalism of your account manager', 'responsiveness and professionalism of your account manager '],
                    probAr: ['       '],
                    probEn: ['effectiveness at resolving the issues or concerns you bring up'],
                    custAr: ['        '],
                    custEn: ['ability to tailor their approach to meet your specific needs and preferences'],
                    systemsAr: ['           (  shipsy, mintsoft)'],
                    systemsEn: [
                        'how satisfied are you with starlinks systems and tools used in daily operations? (this includes the customer portal shipsy and mintsoft), dashboards, performance tracking, etc.)',
                        "how satisfied are you with starlinks' systems and tools used in daily operations?",
                        'how satisfied are you with live dashboard',
                        'how satisfied are you with *live dashboard *',
                        'how satisfied are you with starlinks systems and tools used in daily operations this includes the customer portal shipsy and mintsoft dashboards performance tracking etc'
                    ],
                    itAr: ['                '],
                    itEn: ['how satisfied are you with the it operations support team in handling issues and processing change requests', 'how satisfied are you with the it operations support team in handling issues and processing change requests?'],
                    suggestionsAr: ['     '],
                    suggestionsEn: ['do you have any suggestions for improving our services?'],
                    managerAr: ['   '],
                    managerEn: ['name of designated account manager:', 'name of designated account manager: '],
                    trackingAr: ['     ', '     '],
                    trackingEn: ['how satisfied are you with *tracking system *?', 'how satisfied are you with tracking system'],
                    inventoryAr: ['       ', '       '],
                    inventoryEn: ['how satisfied are you with *warehouse* and *inventory system* ?', 'how satisfied are you with warehouse and inventory system'],
                    reportingAr: ['     ', '     '],
                    reportingEn: ['how satisfied are you with *reporting system *?', 'how satisfied are you with reporting system'],
                    launchpadAr: ['  " launchpad" ?', '   launchpad  ', '  launchpad'],
                    launchpadEn: ['do you use *lanchpad (cx portal)?*', 'do you use lanchpad (cx portal)?', 'do you use launchpad'],
                    dashboardsAr: ['         '],
                    dashboardsEn: ['how satisfied are you with *live dashboard *?', 'how satisfied are you with live dashboard'],
                    improveAr: ['      '],
                    // New questions added
                    launchpadExplanationAr: [' launchpad (cx portal)      ', '     '],
                    launchpadExplanationEn: ['please explain why you are not using the *launchpad (cx portal)*?', 'please explain why you are not using the launchpad', 'please explain why you are not using the *launchpad (cx portal)*'],
                    generalImprovementEn: ['what would you like to see *improved *or added to it ?', 'what would you like to see improved or added to it', 'what would you like to see *improved *or added to it'],
                    submittedAt: ['submitted at']
                };

                // Column mapping successful

                // Precompute column indices - use arrays for fields with multiple columns
                const IDX = {
                    language: findIndex(H.language),
                    companyAr: findAllIndices(H.companyNameAr),
                    companyEn: findAllIndices(H.companyNameEn),
                    serviceAr: findAllIndices(H.serviceTypeAr),
                    serviceEn: findAllIndices(H.serviceTypeEn),
                    overallAr: findAllIndices(H.overallAr),
                    overallEn: findAllIndices(H.overallEn),
                    npsAr: findAllIndices(H.npsAr),
                    npsEn: findAllIndices(H.npsEn),
                    lastMileAr: findAllIndices(H.lastMileAr),
                    lastMileEn: findAllIndices(H.lastMileEn),
                    reverseAr: findAllIndices(H.reverseAr),
                    reverseEn: findAllIndices(H.reverseEn),
                    fulfillmentAr: findAllIndices(H.fulfillmentAr),
                    fulfillmentEn: findAllIndices(H.fulfillmentEn),
                    commAr: findAllIndices(H.commAr),
                    commEn: findAllIndices(H.commEn),
                    respAr: findAllIndices(H.respAr),
                    respEn: findAllIndices(H.respEn),
                    probAr: findAllIndices(H.probAr),
                    probEn: findAllIndices(H.probEn),
                    custAr: findAllIndices(H.custAr),
                    custEn: findAllIndices(H.custEn),
                    systemsAr: findAllIndices(H.systemsAr),
                    systemsEn: findAllIndices(H.systemsEn),
                    itAr: findAllIndices(H.itAr),
                    itEn: findAllIndices(H.itEn),
                    suggestionsAr: findAllIndices(H.suggestionsAr),
                    suggestionsEn: findAllIndices(H.suggestionsEn),
                    managerAr: findAllIndices(H.managerAr),
                    managerEn: findAllIndices(H.managerEn),
                    trackingAr: findIndex(H.trackingAr),
                    trackingEn: findIndex(H.trackingEn),
                    inventoryAr: findIndex(H.inventoryAr),
                    inventoryEn: findIndex(H.inventoryEn),
                    reportingAr: findIndex(H.reportingAr),
                    reportingEn: findIndex(H.reportingEn),
                    launchpadAr: findIndex(H.launchpadAr),
                    launchpadEn: findIndex(H.launchpadEn),
                    dashboardsAr: findIndex(H.dashboardsAr),
                    dashboardsEn: findIndex(H.dashboardsEn),
                    improveAr: findIndex(H.improveAr),
                    // New questions
                    launchpadExplanationAr: findIndex(H.launchpadExplanationAr),
                    launchpadExplanationEn: findIndex(H.launchpadExplanationEn),
                    generalImprovementEn: findIndex(H.generalImprovementEn),
                    submittedAt: findIndex(H.submittedAt)
                };


                const getVal = (row, arIdx, enIdx) => {
                    // Handle both single indices and arrays of indices
                    const arIndices = Array.isArray(arIdx) ? arIdx : [arIdx];
                    const enIndices = Array.isArray(enIdx) ? enIdx : [enIdx];

                    // Try Arabic columns first
                    for (const idx of arIndices) {
                        if (idx >= 0) {
                            const val = this.sanitizeString(row[idx]);
                            if (val) return val;
                        }
                    }

                    // Then try English columns
                    for (const idx of enIndices) {
                        if (idx >= 0) {
                            const val = this.sanitizeString(row[idx]);
                            if (val) return val;
                        }
                    }

                    return '';
                };

                const getNum = (row, arIdx, enIdx, min = 1, max = 5) => {
                    // Handle both single indices and arrays of indices
                    const arIndices = Array.isArray(arIdx) ? arIdx : [arIdx];
                    const enIndices = Array.isArray(enIdx) ? enIdx : [enIdx];

                    // Try Arabic columns first
                    for (const idx of arIndices) {
                        if (idx >= 0) {
                            const val = this.parseNumber(row[idx], min, max);
                            if (val !== null) return val;
                        }
                    }

                    // Then try English columns
                    for (const idx of enIndices) {
                        if (idx >= 0) {
                            const val = this.parseNumber(row[idx], min, max);
                            if (val !== null) return val;
                        }
                    }

                    return null;
                };

                const processor = new SurveyDataProcessor();

                const parsedData = dataRows
                    .filter(row => Array.isArray(row) && row.length > 0)
                    .map((row, index) => {
                        try {
                            const companyName = getVal(row, IDX.companyAr, IDX.companyEn);

                            // Data extraction working - debug removed

                            if (!companyName) return null; // total surveys are rows with company name

                            const rawServiceType = getVal(row, IDX.serviceAr, IDX.serviceEn);
                            let serviceType = processor.normalizeServiceType(rawServiceType);

                            const rawAccountManager = getVal(row, IDX.managerAr, IDX.managerEn);
                            let accountManager = processor.normalizeAccountManager(rawAccountManager);

                            // Assign default account manager if none specified
                            if (!accountManager || accountManager.trim() === '') {
                                accountManager = 'Ahmed Saleem'; // Default assignment
                            }

                            // Ratings
                            const overallSatisfaction = getNum(row, IDX.overallAr, IDX.overallEn, 1, 5);
                            // Enhanced NPS extraction to include all NPS columns (E, S, k, }, ~)
                            const getNpsScore = (row) => {
                                // Try main NPS columns first
                                let npsScore = getNum(row, IDX.npsAr, IDX.npsEn, 0, 10);
                                if (npsScore !== null) return npsScore;

                                // Check additional NPS columns found in analysis
                                // Column k (42): "How likely are you to recommend *Starlinks* to other businesses?"
                                if (row[42] !== undefined && row[42] !== null && row[42] !== '') {
                                    const val = this.parseNumber(row[42], 0, 10);
                                    if (val !== null) return val;
                                }

                                // Check columns } (60) and ~ (61) for the last few responses
                                // These contain some NPS responses in the final rows
                                if (row[60] !== undefined && row[60] !== null && row[60] !== '') {
                                    const val = this.parseNumber(row[60], 0, 10);
                                    if (val !== null) return val;
                                }

                                if (row[61] !== undefined && row[61] !== null && row[61] !== '') {
                                    const val = this.parseNumber(row[61], 0, 10);
                                    if (val !== null) return val;
                                }

                                return null;
                            };

                            const npsScore = getNpsScore(row);
                            const lastMileSatisfaction = getNum(row, IDX.lastMileAr, IDX.lastMileEn, 1, 5);
                            const reverseDeliverySatisfaction = getNum(row, IDX.reverseAr, IDX.reverseEn, 1, 5);
                            const fulfillmentSatisfaction = getNum(row, IDX.fulfillmentAr, IDX.fulfillmentEn, 1, 5);
                            const communicationClarity = getNum(row, IDX.commAr, IDX.commEn, 1, 5);
                            const responsiveness = getNum(row, IDX.respAr, IDX.respEn, 1, 5);
                            const problemResolution = getNum(row, IDX.probAr, IDX.probEn, 1, 5);
                            const customizationAbility = getNum(row, IDX.custAr, IDX.custEn, 1, 5);
                            const systemsSatisfaction = getNum(row, IDX.systemsAr, IDX.systemsEn, 1, 5);
                            const itSupportSatisfaction = getNum(row, IDX.itAr, IDX.itEn, 1, 5);

                            // If service type was not provided, infer it from available domain ratings
                            if (!serviceType || !processor.validServiceTypes.includes(serviceType)) {
                                const hasLastMile = lastMileSatisfaction !== null && lastMileSatisfaction !== undefined;
                                const hasFulfillment = fulfillmentSatisfaction !== null && fulfillmentSatisfaction !== undefined;
                                if (hasLastMile && hasFulfillment) {
                                    serviceType = 'Last Mile & Fulfillment';
                                } else if (hasLastMile) {
                                    serviceType = 'Last Mile Only';
                                } else if (hasFulfillment) {
                                    serviceType = 'Fulfillment Only';
                                }
                            }

                            const suggestions = getVal(row, IDX.suggestionsAr, IDX.suggestionsEn);

                            // New fields - combine Arabic and English responses
                            const launchpadExplanation = getVal(row, IDX.launchpadExplanationAr, IDX.launchpadExplanationEn);
                            const generalImprovement = getVal(row, IDX.generalImprovementEn, IDX.improveAr);

                            // English first, then Arabic fallback



                            const language = IDX.language >= 0 ? this.sanitizeString(row[IDX.language]) : '';

                            // Get real submission date from Submitted At column
                            let submittedAtRaw = null;

                            // Helper function to check if a value looks like a timestamp
                            const looksLikeTimestamp = (val) => {
                                if (!val) return false;
                                const str = String(val).trim();
                                // Check for date patterns like "7/10/2025 8:58:25" or similar
                                return /^\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}:\d{2}$/.test(str);
                            };

                            // Approach 1: Use the mapped column index (most reliable)
                            if (IDX.submittedAt >= 0 && row[IDX.submittedAt]) {
                                submittedAtRaw = row[IDX.submittedAt];
                            }
                            // Approach 2: Search for timestamp-like values in the last few columns
                            else {
                                // Check the last 10 columns for timestamp-like values
                                for (let i = Math.max(0, row.length - 10); i < row.length; i++) {
                                    if (looksLikeTimestamp(row[i])) {
                                        submittedAtRaw = row[i];
                                        break;
                                    }
                                }
                            }

                            let submittedAt = this.parseDate(submittedAtRaw);

                            // Mark all surveys with company names as completed (100% completion rate)
                            const isCompleted = Boolean(companyName && companyName.trim() && submittedAt);

                            // Remove the old completion logic since it's now handled above

                            // Completion logic working - debug removed

                            // Branching: keep domain ratings but consumers should use per-service logic
                            return {
                                id: index + 1,
                                companyName,
                                serviceType,
                                overallSatisfaction,
                                npsScore,
                                lastMileSatisfaction,
                                reverseDeliverySatisfaction,
                                fulfillmentSatisfaction,
                                accountManager,
                                communicationClarity,
                                responsiveness,
                                problemResolution,
                                customizationAbility,
                                systemsSatisfaction,
                                itSupportSatisfaction,
                                suggestions,
                                launchpadExplanation,
                                generalImprovement,
                                submittedAt,
                                isCompleted,
                                language,
                                token: submittedAtRaw ? String(submittedAtRaw) : `${companyName}-${index}`,
                                rawServiceType,
                                rawAccountManager
                            };
                        } catch (e) {
                            return null;
                        }
                    })
                    .filter(item => item !== null);

                // Validate the parsed data
                this.validateBilingualData(parsedData);
                return parsedData;
            }

            /**
             * Validate bilingual data structure and provide debugging info
             */
            validateBilingualData(data) {

                const stats = {
                    totalRows: data.length,
                    arabicResponses: 0,
                    englishResponses: 0,
                    mixedResponses: 0,
                    emptyResponses: 0,
                    completedSurveys: 0,
                    languageDistribution: {}
                };

                data.forEach((row, index) => {
                    if (row.language) {
                        stats.languageDistribution[row.language] = (stats.languageDistribution[row.language] || 0) + 1;
                    }

                    if (row.isCompleted) {
                        stats.completedSurveys++;
                    }
                });



                // Check for common issues
                const issues = [];
                if (stats.totalRows === 0) {
                    issues.push('No data found - check API connection and spreadsheet ID');
                }
                if (stats.completedSurveys === 0) {
                    issues.push('No completed surveys found - check submission timestamp column');
                }

                if (issues.length > 0) {
                    // Issues found but not logging to reduce console spam
                }

                return { stats, issues };
            }

            /**
             * Utility methods for data sanitization and validation
             */
            sanitizeString(value) {
                if (value === null || value === undefined) return '';
                return String(value).trim();
            }

            parseNumber(value, min = null, max = null) {
                if (value === null || value === undefined || value === '') return null;

                const num = Number(value);
                if (isNaN(num)) return null;

                if (min !== null && num < min) return null;
                if (max !== null && num > max) return null;

                return num;
            }

            // Normalize header text for robust matching (lowercase, trim, collapse spaces, strip quotes)
            normalizeHeader(text) {
                // Lowercase, remove most punctuation/specials (keep letters/numbers incl. Arabic), collapse spaces
                return String(text || '')
                    .toLowerCase()
                    .replace(/["\u201c\u201d\u2018\u2019\*]/g, '')
                    .replace(/[^\p{L}\p{N}\s]/gu, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();
            }

            parseDate(value) {
                if (!value && value !== 0) return null;

                // 1) If already a Date
                if (value instanceof Date && !isNaN(value.getTime())) return value;

                // 2) If Google returns a number (Excel serial days)
                if (typeof value === 'number') {
                    // Excel epoch: 1899-12-30
                    const excelEpoch = new Date(Date.UTC(1899, 11, 30));
                    const ms = value * 24 * 60 * 60 * 1000;
                    const d = new Date(excelEpoch.getTime() + ms);
                    return isNaN(d.getTime()) ? null : d;
                }

                // 3) Normalize Arabic-Indic digits to Western
                const normalizeDigits = (str) => String(str).replace(/[\u0660-\u0669]/g, (d) => String(d.charCodeAt(0) - 0x0660))
                    .replace(/[\u06F0-\u06F9]/g, (d) => String(d.charCodeAt(0) - 0x06F0));

                const text = normalizeDigits(String(value)).trim();

                // 4) ISO-like formats
                const iso = new Date(text);
                if (!isNaN(iso.getTime())) return iso;

                // 5) Try DD/MM/YYYY or MM/DD/YYYY with optional time
                const match = text.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
                if (match) {
                    const d1 = parseInt(match[1], 10);
                    const m1 = parseInt(match[2], 10);
                    const y = parseInt(match[3], 10);
                    const hh = parseInt(match[4] || '0', 10);
                    const mm = parseInt(match[5] || '0', 10);
                    const ss = parseInt(match[6] || '0', 10);

                    // Heuristic: if first part > 12 assume DD/MM/YYYY, else treat as MM/DD/YYYY
                    const isDMY = d1 > 12;
                    const day = isDMY ? d1 : m1;
                    const month = (isDMY ? m1 : d1) - 1;
                    const d = new Date(y, month, day, hh, mm, ss);
                    return isNaN(d.getTime()) ? null : d;
                }

                return null;
            }
        }

        // Data Cache Manager
        class DataCacheManager {
            constructor(cacheConfig) {
                this.config = cacheConfig;
            }

            /**
             * Check if cached data is still valid
             */
            isCacheValid() {
                if (!dataCache.data || !dataCache.timestamp) {
                    return false;
                }

                const now = Date.now();
                const cacheAge = now - dataCache.timestamp;

                return cacheAge < this.config.duration;
            }

            /**
             * Get cached data if valid, otherwise fetch new data
             */
            async getData(forceRefresh = false) {
                // Return cached data if valid and not forcing refresh
                if (!forceRefresh && this.isCacheValid()) {
                    return dataCache.data;
                }

                // Prevent multiple simultaneous requests
                if (dataCache.isLoading) {
                    return this.waitForCurrentRequest();
                }

                return this.fetchFreshData();
            }

            /**
             * Wait for current request to complete
             */
            async waitForCurrentRequest() {
                return new Promise((resolve) => {
                    const checkInterval = setInterval(() => {
                        if (!dataCache.isLoading) {
                            clearInterval(checkInterval);
                            resolve(dataCache.data);
                        }
                    }, 100);
                });
            }

            /**
             * Fetch fresh data from API
             */
            async fetchFreshData() {
                dataCache.isLoading = true;

                try {
                    const api = new GoogleSheetsAPI(API_CONFIG);
                    const freshData = await api.fetchSheetData();

                    // Update cache
                    dataCache.data = freshData;
                    dataCache.timestamp = Date.now();
                    dataCache.retryCount = 0; // Reset retry count on success

                    return freshData;
                } catch (error) {
                    await this.handleFetchError(error);
                    throw error;
                } finally {
                    dataCache.isLoading = false;
                }
            }

            /**
             * Handle fetch errors with retry logic and user feedback
             */
            async handleFetchError(error) {
                dataCache.retryCount++;

                // Handle data fetch error

                // Update connection status
                if (error.type === 'NETWORK_ERROR') {
                    errorManager.updateConnectionStatus('offline');
                } else {
                    errorManager.updateConnectionStatus('reconnecting');
                }

                // Show user-friendly error message with recovery options
                const userMessage = this.getUserFriendlyErrorMessage(error);
                const showRetry = dataCache.retryCount < this.config.maxRetries;

                errorManager.showError(userMessage, 'error', showRetry ? 0 : 8000, {
                    showRetry: showRetry,
                    onRetry: () => {
                        this.getData(true).catch(retryError => {
                            // Manual retry failed
                        });
                    }
                });

                // Schedule automatic retry if under max retry limit
                if (dataCache.retryCount < this.config.maxRetries) {
                    const retryDelay = this.calculateRetryDelay(dataCache.retryCount);

                    setTimeout(() => {
                        errorManager.updateConnectionStatus('reconnecting');
                        this.getData(true).then(() => {
                            errorManager.updateConnectionStatus('online');
                            errorManager.showError('Connection restored successfully', 'success', 3000);
                        }).catch(retryError => {
                            // Automatic retry failed
                        });
                    }, retryDelay);
                }
            }

            /**
             * Calculate exponential backoff delay for retries
             */
            calculateRetryDelay(retryCount) {
                const baseDelay = this.config.retryInterval;
                const maxDelay = 300000; // 5 minutes max
                const delay = Math.min(baseDelay * Math.pow(2, retryCount - 1), maxDelay);
                return delay;
            }

            /**
             * Get user-friendly error message with context
             */
            getUserFriendlyErrorMessage(error) {
                const baseMessage = window.DashboardAPI.getErrorMessage(error);
                const suggestions = errorManager.getRecoverySuggestions(error);

                if (dataCache.retryCount < this.config.maxRetries) {
                    return `${baseMessage} Retrying automatically in a few moments...`;
                } else {
                    return `${baseMessage} Please try the following: ${suggestions.slice(0, 2).join(', ')}.`;
                }
            }

            /**
             * Clear cache (useful for manual refresh)
             */
            clearCache() {
                dataCache.data = null;
                dataCache.timestamp = null;
                dataCache.retryCount = 0;
            }
        }

        // Enhanced Error Display Manager
        class ErrorDisplayManager {
            constructor() {
                this.errorContainer = null;
                this.connectionStatus = null;
                this.progressIndicator = null;
                this.createErrorContainer();
                this.createConnectionStatus();
                this.createProgressIndicator();
                this.setupGlobalErrorHandling();
            }

            createErrorContainer() {
                // Create error message container if it doesn't exist
                if (!document.getElementById('error-container')) {
                    const container = document.createElement('div');
                    container.id = 'error-container';
                    container.className = 'error-container';
                    document.body.appendChild(container);
                }
                this.errorContainer = document.getElementById('error-container');
            }

            createConnectionStatus() {
                // Create connection status indicator
                if (!document.getElementById('connection-status')) {
                    const status = document.createElement('div');
                    status.id = 'connection-status';
                    status.className = 'connection-status online';
                    status.innerHTML = `
                        <div class="connection-status-dot"></div>
                        <span>Connected</span>
                    `;
                    document.body.appendChild(status);
                }
                this.connectionStatus = document.getElementById('connection-status');
            }

            createProgressIndicator() {
                // Create progress indicator
                if (!document.getElementById('progress-indicator')) {
                    const progress = document.createElement('div');
                    progress.id = 'progress-indicator';
                    progress.className = 'progress-indicator hidden';
                    progress.innerHTML = '<div class="progress-indicator-bar"></div>';
                    document.body.appendChild(progress);
                }
                this.progressIndicator = document.getElementById('progress-indicator');
            }

            setupGlobalErrorHandling() {
                // Handle unhandled promise rejections
                window.addEventListener('unhandledrejection', (event) => {
                    this.showError('An unexpected error occurred. Please try refreshing the page.', 'error');
                });

                // Handle JavaScript errors
                window.addEventListener('error', (event) => {
                    this.showError('A technical error occurred. Please try refreshing the page.', 'error');
                });

                // Handle network status changes
                window.addEventListener('online', () => {
                    this.updateConnectionStatus('online');
                    this.showError('Connection restored', 'success', 3000);
                });

                window.addEventListener('offline', () => {
                    this.updateConnectionStatus('offline');
                    this.showError('Connection lost. Working in offline mode.', 'warning', 0);
                });
            }

            showError(message, type = 'error', duration = 5000, options = {}) {
                const errorElement = document.createElement('div');
                errorElement.className = `error-message ${type}`;

                const content = document.createElement('div');
                content.className = 'error-message-content';
                content.textContent = message;

                const closeButton = document.createElement('button');
                closeButton.className = 'error-message-close';
                closeButton.innerHTML = '';
                closeButton.setAttribute('aria-label', 'Close message');
                closeButton.onclick = () => this.removeError(errorElement);

                errorElement.appendChild(content);
                errorElement.appendChild(closeButton);

                // Add retry button if specified
                if (options.showRetry && options.onRetry) {
                    const retryButton = document.createElement('button');
                    retryButton.className = 'retry-button';
                    retryButton.innerHTML = ' Retry';
                    retryButton.onclick = () => {
                        options.onRetry();
                        this.removeError(errorElement);
                    };
                    content.appendChild(document.createElement('br'));
                    content.appendChild(retryButton);
                }

                this.errorContainer.appendChild(errorElement);

                // Auto-remove after duration (0 means persistent)
                if (duration > 0) {
                    setTimeout(() => this.removeError(errorElement), duration);
                }

                return errorElement;
            }

            showPartialDataWarning(missingData) {
                const warningElement = document.createElement('div');
                warningElement.className = 'partial-data-warning';
                warningElement.innerHTML = `
                    <div class="partial-data-warning-icon"></div>
                    <div class="partial-data-warning-content">
                        <div class="partial-data-warning-title">Partial Data Available</div>
                        <div class="partial-data-warning-text">
                            Some data is missing or incomplete: ${missingData.join(', ')}. 
                            Displaying available information.
                        </div>
                    </div>
                `;
                return warningElement;
            }

            createEmptyState(title, description, actionText = null, onAction = null) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';

                let actionButton = '';
                if (actionText && onAction) {
                    actionButton = `<button class="empty-state-action" onclick="(${onAction.toString()})()">${actionText}</button>`;
                }

                emptyState.innerHTML = `
                    <div class="empty-state-icon">
                        <svg viewBox="0 0 64 64" fill="currentColor">
                            <path d="M32 8C18.7 8 8 18.7 8 32s10.7 24 24 24 24-10.7 24-24S45.3 8 32 8zm0 44c-11 0-20-9-20-20s9-20 20-20 20 9 20 20-9 20-20 20z"/>
                            <path d="M32 16c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2s2-.9 2-2V18c0-1.1-.9-2-2-2z"/>
                            <circle cx="32" cy="42" r="2"/>
                        </svg>
                    </div>
                    <div class="empty-state-title">${title}</div>
                    <div class="empty-state-description">${description}</div>
                    ${actionButton}
                `;

                return emptyState;
            }

            createLoadingState(message = 'Loading data...') {
                const loadingState = document.createElement('div');
                loadingState.className = 'loading-state';
                loadingState.innerHTML = `
                    <div class="loading-spinner-large"></div>
                    <div class="loading-text">${message}</div>
                `;
                return loadingState;
            }

            showProgress(show = true, indeterminate = true) {
                if (show) {
                    this.progressIndicator.classList.remove('hidden');
                    const bar = this.progressIndicator.querySelector('.progress-indicator-bar');
                    if (indeterminate) {
                        bar.classList.add('indeterminate');
                    } else {
                        bar.classList.remove('indeterminate');
                    }
                } else {
                    this.progressIndicator.classList.add('hidden');
                }
            }

            updateProgress(percentage) {
                const bar = this.progressIndicator.querySelector('.progress-indicator-bar');
                bar.classList.remove('indeterminate');
                bar.style.width = `${Math.min(100, Math.max(0, percentage))}%`;
            }

            updateConnectionStatus(status) {
                if (!this.connectionStatus) return;

                this.connectionStatus.className = `connection-status ${status}`;

                const statusText = {
                    online: 'Connected',
                    offline: 'Offline',
                    reconnecting: 'Reconnecting...'
                };

                this.connectionStatus.querySelector('span').textContent = statusText[status] || status;
            }

            removeError(errorElement) {
                if (errorElement && errorElement.parentNode) {
                    errorElement.classList.add('fade-out');
                    setTimeout(() => {
                        if (errorElement.parentNode) {
                            errorElement.parentNode.removeChild(errorElement);
                        }
                    }, 300);
                }
            }

            clearAllErrors() {
                if (this.errorContainer) {
                    this.errorContainer.innerHTML = '';
                }
            }

            // Graceful degradation helpers
            handlePartialDataScenario(data, expectedFields) {
                const missingFields = [];
                const availableData = {};

                expectedFields.forEach(field => {
                    if (!data[field] || (Array.isArray(data[field]) && data[field].length === 0)) {
                        missingFields.push(field);
                    } else {
                        availableData[field] = data[field];
                    }
                });

                if (missingFields.length > 0) {
                    const warning = this.showPartialDataWarning(missingFields);
                    return { availableData, warning, hasMissingData: true };
                }

                return { availableData: data, warning: null, hasMissingData: false };
            }

            // Error recovery suggestions
            getRecoverySuggestions(error) {
                const suggestions = {
                    'NETWORK_ERROR': [
                        'Check your internet connection',
                        'Try refreshing the page',
                        'Contact your network administrator if the problem persists'
                    ],
                    'HTTP_ERROR': [
                        'Verify your API credentials',
                        'Check if the Google Sheet is accessible',
                        'Ensure the sheet is shared with the service account'
                    ],
                    'DATA_FORMAT_ERROR': [
                        'Check the spreadsheet column structure',
                        'Ensure all required columns are present',
                        'Verify data format matches expectations'
                    ],
                    'INSUFFICIENT_DATA': [
                        'Add survey data to the spreadsheet',
                        'Check if the correct sheet tab is selected',
                        'Verify the data range configuration'
                    ]
                };

                return suggestions[error.type] || [
                    'Try refreshing the page',
                    'Check your internet connection',
                    'Contact support if the problem continues'
                ];
            }
        }

        // Initialize managers
        const cacheManager = new DataCacheManager(CACHE_CONFIG);
        const errorManager = new ErrorDisplayManager();

        // Auto-refresh functionality
        class AutoRefreshManager {
            constructor(cacheManager, interval = 30000) {
                this.cacheManager = cacheManager;
                this.interval = interval;
                this.refreshTimer = null;
                this.isActive = false;
            }

            start() {
                if (this.isActive) return;

                this.isActive = true;
                this.refreshTimer = setInterval(async () => {
                    try {
                        // Only refresh if cache is expired and not currently loading
                        if (!this.cacheManager.isCacheValid() && !dataCache.isLoading) {
                            await this.cacheManager.getData(true);
                            // Trigger UI update without flickering
                            this.updateUIIntelligently();
                        }
                    } catch (error) {
                        // Silent refresh failures - errors are handled by cache manager

                    }
                }, this.interval);
            }

            stop() {
                if (this.refreshTimer) {
                    clearInterval(this.refreshTimer);
                    this.refreshTimer = null;
                }
                this.isActive = false;
            }

            /**
             * Update UI without causing flickering
             */
            updateUIIntelligently() {
                // Only update if the page is visible and user is not actively interacting
                if (document.hidden || document.activeElement !== document.body) {
                    return;
                }

                // Dispatch custom event for UI components to handle updates
                const updateEvent = new CustomEvent('dataRefreshed', {
                    detail: { data: dataCache.data, timestamp: dataCache.timestamp }
                });
                document.dispatchEvent(updateEvent);
            }
        }

        // Initialize auto-refresh
        const autoRefreshManager = new AutoRefreshManager(cacheManager, CACHE_CONFIG.duration);

        // Enhanced Public API for accessing data
        window.DashboardAPI = {
            /**
             * Get survey data with comprehensive error handling
             */
            async getData(forceRefresh = false, showProgress = true) {
                try {
                    if (showProgress) {
                        errorManager.showProgress(true);
                    }

                    const data = await cacheManager.getData(forceRefresh);

                    if (showProgress) {
                        errorManager.showProgress(false);
                    }

                    // Validate data quality
                    const validation = this.validateDataQuality(data);
                    if (validation.hasIssues) {
                        this.handleDataQualityIssues(validation);
                    }

                    return data;
                } catch (error) {
                    if (showProgress) {
                        errorManager.showProgress(false);
                    }

                    // Don't show duplicate error messages - let the cache manager handle it
                    if (!error.handledByCache) {
                        errorManager.showError(this.getErrorMessage(error), 'error', 8000, {
                            showRetry: true,
                            onRetry: () => this.getData(forceRefresh, showProgress)
                        });
                    }

                    throw error;
                }
            },

            /**
             * Validate data quality and completeness
             */
            validateDataQuality(data) {
                const issues = [];
                const warnings = [];

                if (!data || !Array.isArray(data)) {
                    issues.push('Invalid data format');
                    return { hasIssues: true, issues, warnings };
                }

                if (data.length === 0) {
                    issues.push('No survey data available');
                    return { hasIssues: true, issues, warnings };
                }

                // Check for missing critical fields
                const criticalFields = ['companyName', 'overallSatisfaction', 'accountManager'];
                const missingCriticalData = data.filter(item =>
                    criticalFields.some(field => !item[field])
                );

                if (missingCriticalData.length > 0) {
                    warnings.push(`${missingCriticalData.length} surveys missing critical information`);
                }

                // Do not warn about incomplete surveys; we treat submittedAt as completion source of truth

                return {
                    hasIssues: issues.length > 0 || warnings.length > 0,
                    issues,
                    warnings,
                    totalRecords: data.length,
                    completeRecords: data.filter(item => item.submittedAt).length
                };
            },

            /**
             * Handle data quality issues with user feedback
             */
            handleDataQualityIssues(validation) {
                if (validation.issues.length > 0) {
                    validation.issues.forEach(issue => {
                        errorManager.showError(issue, 'error');
                    });
                }

                // Data quality warnings are now suppressed to provide a cleaner user experience
                // Internal validation still occurs for system reliability
                if (validation.warnings.length > 0) {
                    // Warnings found but not logging to reduce console spam
                }
            },

            /**
             * Get cache status with enhanced information
             */
            getCacheStatus() {
                return {
                    hasData: Boolean(dataCache.data),
                    isValid: cacheManager.isCacheValid(),
                    isLoading: dataCache.isLoading,
                    lastUpdated: dataCache.timestamp,
                    retryCount: dataCache.retryCount,
                    nextRefresh: dataCache.timestamp ? new Date(dataCache.timestamp + CACHE_CONFIG.duration) : null,
                    isOnline: navigator.onLine,
                    recordCount: dataCache.data ? dataCache.data.length : 0
                };
            },

            /**
             * Manual refresh with user feedback
             */
            async refresh() {
                try {
                    errorManager.clearAllErrors();
                    errorManager.showError('Refreshing data...', 'info', 2000);

                    const data = await this.getData(true);

                    errorManager.showError('Data refreshed successfully', 'success', 3000);
                    return data;
                } catch (error) {
                    errorManager.showError('Failed to refresh data', 'error');
                    throw error;
                }
            },

            /**
             * Start/stop auto-refresh with status updates
             */
            startAutoRefresh() {
                autoRefreshManager.start();
                errorManager.showError('Auto-refresh enabled', 'info', 2000);
            },

            stopAutoRefresh() {
                autoRefreshManager.stop();
                errorManager.showError('Auto-refresh disabled', 'info', 2000);
            },

            /**
             * Handle offline scenarios
             */
            handleOfflineMode() {
                if (!navigator.onLine && dataCache.data) {
                    errorManager.showError('Working offline with cached data', 'warning', 0);
                    return dataCache.data;
                }
                return null;
            },

            /**
             * Get comprehensive error message with context
             */
            getErrorMessage(error) {
                const baseMessages = {
                    'NETWORK_ERROR': 'Connection issue. Please check your internet connection and try again.',
                    'HTTP_ERROR': this.getHTTPErrorMessage(error.statusCode),
                    'DATA_FORMAT_ERROR': 'Data format error. Please check your spreadsheet structure.',
                    'INSUFFICIENT_DATA': 'No survey data found. Please ensure your spreadsheet contains data.',
                    'AUTHENTICATION_ERROR': 'Authentication failed. Please check your API credentials.',
                    'RATE_LIMIT_ERROR': 'Too many requests. Please wait before trying again.',
                    'TIMEOUT_ERROR': 'Request timed out. Please check your connection and try again.'
                };

                return baseMessages[error.type] || 'An unexpected error occurred. Please try refreshing the page.';
            },

            /**
             * Get specific HTTP error messages
             */
            getHTTPErrorMessage(statusCode) {
                const httpMessages = {
                    400: 'Bad request. Please check your configuration.',
                    401: 'Unauthorized. Please check your API credentials.',
                    403: 'Access denied. Please verify your permissions.',
                    404: 'Spreadsheet not found. Please verify the spreadsheet ID.',
                    429: 'Rate limit exceeded. Please wait before trying again.',
                    500: 'Server error. Please try again later.',
                    502: 'Service temporarily unavailable. Please try again later.',
                    503: 'Service unavailable. Please try again later.'
                };

                return httpMessages[statusCode] || `Server error (${statusCode}). Please try again later.`;
            },

            /**
             * Emergency data recovery
             */
            async emergencyRecovery() {
                try {
                    // Try to get any cached data
                    if (dataCache.data) {
                        errorManager.showError('Using cached data due to connection issues', 'warning');
                        return dataCache.data;
                    }

                    // Try offline mode
                    const offlineData = this.handleOfflineMode();
                    if (offlineData) {
                        return offlineData;
                    }

                    // Last resort: return empty state
                    throw new Error('No data available for recovery');
                } catch (error) {
                    errorManager.showError('Unable to recover data. Please refresh the page.', 'error');
                    throw error;
                }
            }
        };

        // Error Recovery System
        class ErrorRecoverySystem {
            constructor() {
                this.recoveryStrategies = {
                    'NETWORK_ERROR': this.handleNetworkError.bind(this),
                    'HTTP_ERROR': this.handleHTTPError.bind(this),
                    'DATA_FORMAT_ERROR': this.handleDataFormatError.bind(this),
                    'INSUFFICIENT_DATA': this.handleInsufficientData.bind(this),
                    'AUTHENTICATION_ERROR': this.handleAuthError.bind(this),
                    'RATE_LIMIT_ERROR': this.handleRateLimitError.bind(this)
                };

                this.setupGlobalErrorRecovery();
            }

            setupGlobalErrorRecovery() {
                // Listen for critical errors
                document.addEventListener('criticalError', (event) => {
                    this.handleCriticalError(event.detail);
                });

                // Monitor connection status
                this.monitorConnectionHealth();
            }

            async handleCriticalError(error) {
                const strategy = this.recoveryStrategies[error.type];
                if (strategy) {
                    await strategy(error);
                } else {
                    await this.handleGenericError(error);
                }
            }

            async handleNetworkError(error) {
                // Try to use cached data
                const offlineData = window.DashboardAPI.handleOfflineMode();
                if (offlineData) {
                    errorManager.showError('Using cached data while offline', 'warning', 5000);
                    return offlineData;
                }

                // Schedule periodic retry
                this.schedulePeriodicRetry();
                return null;
            }

            async handleHTTPError(error) {
                if (error.statusCode === 429) {
                    // Rate limiting - wait and retry
                    const waitTime = this.calculateBackoffDelay();
                    errorManager.showError(`Rate limited. Retrying in ${waitTime / 1000} seconds...`, 'warning', waitTime);

                    setTimeout(() => {
                        window.DashboardAPI.refresh();
                    }, waitTime);
                } else if (error.statusCode >= 500) {
                    // Server error - try emergency recovery
                    return await window.DashboardAPI.emergencyRecovery();
                }
            }

            async handleDataFormatError(error) {
                // Try to recover partial data
                try {
                    const rawData = await window.DashboardAPI.getData(true, false);
                    const processor = new SurveyDataProcessor();
                    const cleanedData = processor.parseAndValidateSurveyData(rawData);

                    if (cleanedData.length > 0) {
                        errorManager.showError('Some data was recovered despite format issues', 'warning', 5000);
                        return cleanedData;
                    }
                } catch (recoveryError) {
                    // Data recovery failed
                }

                return null;
            }

            async handleInsufficientData(error) {
                // Check if it's a configuration issue
                errorManager.showError(
                    'No data found. Please verify your spreadsheet configuration.',
                    'error',
                    0,
                    {
                        showRetry: true,
                        onRetry: () => window.DashboardAPI.refresh()
                    }
                );
            }

            async handleAuthError(error) {
                errorManager.showError(
                    'Authentication failed. Please check your API credentials and permissions.',
                    'error',
                    0
                );
            }

            async handleRateLimitError(error) {
                const backoffTime = this.calculateBackoffDelay();
                errorManager.showError(
                    `Rate limit exceeded. Automatically retrying in ${backoffTime / 1000} seconds...`,
                    'warning',
                    backoffTime
                );

                setTimeout(() => {
                    window.DashboardAPI.refresh();
                }, backoffTime);
            }

            async handleGenericError(error) {
                // Last resort recovery
                try {
                    return await window.DashboardAPI.emergencyRecovery();
                } catch (recoveryError) {
                    errorManager.showError(
                        'Critical error occurred. Please refresh the page.',
                        'error',
                        0,
                        {
                            showRetry: true,
                            onRetry: () => window.location.reload()
                        }
                    );
                }
            }

            calculateBackoffDelay() {
                const baseDelay = 5000; // 5 seconds
                const maxDelay = 60000; // 1 minute
                const retryCount = dataCache.retryCount || 0;

                return Math.min(baseDelay * Math.pow(2, retryCount), maxDelay);
            }

            schedulePeriodicRetry() {
                const retryInterval = 30000; // 30 seconds

                const retryTimer = setInterval(async () => {
                    if (navigator.onLine) {
                        try {
                            await window.DashboardAPI.refresh();
                            clearInterval(retryTimer);
                            errorManager.showError('Connection restored', 'success', 3000);
                        } catch (error) {

                        }
                    }
                }, retryInterval);
            }

            monitorConnectionHealth() {
                setInterval(() => {
                    const cacheStatus = window.DashboardAPI.getCacheStatus();

                    // Check if data is stale
                    if (cacheStatus.lastUpdated) {
                        const staleThreshold = 5 * 60 * 1000; // 5 minutes
                        const dataAge = Date.now() - cacheStatus.lastUpdated;

                        if (dataAge > staleThreshold && navigator.onLine) {
                            errorManager.showError('Data may be outdated. Refreshing...', 'info', 3000);
                            window.DashboardAPI.refresh().catch(error => {

                            });
                        }
                    }
                }, 60000); // Check every minute
            }
        }

        // Initialize error recovery system
        const errorRecoverySystem = new ErrorRecoverySystem();

        // Add CSS animations for error messages
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // Enhanced Application Initialization
        class ApplicationInitializer {
            constructor() {
                this.initializationSteps = [
                    { name: 'API Setup', progress: 10 },
                    { name: 'Loading Configuration', progress: 25 },
                    { name: 'Connecting to Data Source', progress: 50 },
                    { name: 'Processing Data', progress: 75 },
                    { name: 'Rendering Interface', progress: 90 },
                    { name: 'Complete', progress: 100 }
                ];
                this.currentStep = 0;
            }

            async initialize() {
                try {
                    errorManager.showProgress(true, false);

                    // Step 1: API Setup
                    this.updateProgress(0);
                    await this.delay(200);

                    // Step 2: Loading Configuration
                    this.updateProgress(1);
                    await this.delay(200);

                    // Step 3: Connecting to Data Source
                    this.updateProgress(2);

                    // Start auto-refresh
                    autoRefreshManager.start();

                    // Step 4: Processing Data
                    this.updateProgress(3);

                    // Initial data load with progress tracking
                    const data = await window.DashboardAPI.getData(false, false);

                    // Step 5: Rendering Interface - Distribute data to all managers
                    this.updateProgress(4);

                    // Small delay to ensure all managers are initialized
                    await this.delay(100);

                    // Distribute data to all managers
                    if (data && Array.isArray(data)) {
                        // Update CSAT Summary
                        if (window.csatSummaryManager) {
                            await window.csatSummaryManager.updateSummaryMetrics(data);
                        }

                        // Update Customer Status
                        if (window.customerStatusManager) {
                            await window.customerStatusManager.updateCustomerStatus(data);
                        }

                        // Update Account Manager Performance
                        if (window.accountManagerPerformanceManager) {
                            const processor = new SurveyDataProcessor();
                            const processedData = processor.calculateAccountManagerMetrics(data);
                            window.accountManagerPerformanceManager.renderAccountManagerCards(processedData);
                        }
                    }

                    // Trigger data refresh event for any other listeners
                    document.dispatchEvent(new CustomEvent('dataRefreshed', {
                        detail: {
                            data: data,
                            timestamp: new Date().toISOString(),
                            source: 'initialization'
                        }
                    }));

                    await this.delay(300);

                    // Step 6: Complete
                    this.updateProgress(5);
                    await this.delay(200);

                    errorManager.showProgress(false);
                    errorManager.showError('Dashboard loaded successfully', 'success', 3000);

                } catch (error) {
                    errorManager.showProgress(false);

                    // Show initialization error with recovery options
                    errorManager.showError(
                        'Failed to initialize dashboard. Please check your connection and try again.',
                        'error',
                        0,
                        {
                            showRetry: true,
                            onRetry: () => this.initialize()
                        }
                    );
                }
            }

            updateProgress(stepIndex) {
                if (stepIndex < this.initializationSteps.length) {
                    const step = this.initializationSteps[stepIndex];
                    errorManager.updateProgress(step.progress);
                    this.currentStep = stepIndex;
                }
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // ===================================================================
        // Accessibility and Performance Enhancements
        // ===================================================================

        /**
         * Accessibility Manager
         * Handles keyboard navigation, screen reader announcements, and focus management
         */
        class AccessibilityManager {
            constructor() {
                this.liveRegion = null;
                this.keyboardNavigationActive = false;
                this.focusableElements = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
                this.init();
            }

            init() {
                this.setupLiveRegion();
                this.setupKeyboardNavigation();
                this.setupFocusManagement();
                this.setupTabNavigation();
                this.setupAccordionAccessibility();
                this.setupTableAccessibility();
            }

            /**
             * Set up live region for screen reader announcements
             */
            setupLiveRegion() {
                this.liveRegion = document.getElementById('live-region');
                if (!this.liveRegion) {
                    this.liveRegion = document.createElement('div');
                    this.liveRegion.id = 'live-region';
                    this.liveRegion.className = 'sr-only';
                    this.liveRegion.setAttribute('aria-live', 'polite');
                    this.liveRegion.setAttribute('aria-atomic', 'true');
                    document.body.appendChild(this.liveRegion);
                }
            }

            /**
             * Announce message to screen readers
             */
            announce(message, priority = 'polite') {
                if (!this.liveRegion) return;

                this.liveRegion.setAttribute('aria-live', priority);
                this.liveRegion.textContent = message;

                // Clear after announcement
                setTimeout(() => {
                    this.liveRegion.textContent = '';
                }, 1000);
            }

            /**
             * Set up keyboard navigation detection
             */
            setupKeyboardNavigation() {
                // Detect keyboard navigation
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Tab') {
                        this.keyboardNavigationActive = true;
                        document.body.classList.add('keyboard-navigation-active');
                    }
                });

                document.addEventListener('mousedown', () => {
                    this.keyboardNavigationActive = false;
                    document.body.classList.remove('keyboard-navigation-active');
                });

                // Arrow key navigation for tabs
                document.addEventListener('keydown', (e) => {
                    if (e.target.matches('.nav-tab')) {
                        this.handleTabKeyNavigation(e);
                    }
                });
            }

            /**
             * Handle arrow key navigation for tabs
             */
            handleTabKeyNavigation(e) {
                const tabs = Array.from(document.querySelectorAll('.nav-tab'));
                const currentIndex = tabs.indexOf(e.target);
                let nextIndex;

                switch (e.key) {
                    case 'ArrowLeft':
                    case 'ArrowUp':
                        e.preventDefault();
                        nextIndex = currentIndex > 0 ? currentIndex - 1 : tabs.length - 1;
                        tabs[nextIndex].focus();
                        break;
                    case 'ArrowRight':
                    case 'ArrowDown':
                        e.preventDefault();
                        nextIndex = currentIndex < tabs.length - 1 ? currentIndex + 1 : 0;
                        tabs[nextIndex].focus();
                        break;
                    case 'Home':
                        e.preventDefault();
                        tabs[0].focus();
                        break;
                    case 'End':
                        e.preventDefault();
                        tabs[tabs.length - 1].focus();
                        break;
                }
            }

            /**
             * Set up focus management for tab panels
             */
            setupFocusManagement() {
                // Focus main content when tab changes
                document.addEventListener('click', (e) => {
                    if (e.target.matches('.nav-tab')) {
                        setTimeout(() => {
                            const mainContent = document.getElementById('main-content');
                            if (mainContent) {
                                mainContent.focus();
                            }
                        }, 100);
                    }
                });
            }

            /**
             * Set up tab navigation accessibility
             */
            setupTabNavigation() {
                const tabs = document.querySelectorAll('.nav-tab');
                const panels = document.querySelectorAll('.content-section');

                tabs.forEach((tab, index) => {
                    tab.addEventListener('click', () => {
                        // Update ARIA attributes
                        tabs.forEach(t => t.setAttribute('aria-selected', 'false'));
                        panels.forEach(p => p.setAttribute('aria-hidden', 'true'));

                        tab.setAttribute('aria-selected', 'true');
                        const targetPanel = document.getElementById(tab.getAttribute('aria-controls'));
                        if (targetPanel) {
                            targetPanel.setAttribute('aria-hidden', 'false');
                        }

                        // Announce tab change
                        this.announce(`Switched to ${tab.textContent} section`);
                    });
                });
            }

            /**
             * Set up accordion accessibility
             */
            setupAccordionAccessibility() {
                document.addEventListener('click', (e) => {
                    if (e.target.matches('.accordion-header') || e.target.closest('.accordion-header')) {
                        const header = e.target.matches('.accordion-header') ? e.target : e.target.closest('.accordion-header');
                        const card = header.closest('.accordion-card');
                        const isExpanded = card.classList.contains('expanded');

                        // Update ARIA attributes
                        header.setAttribute('aria-expanded', !isExpanded);

                        // Announce state change
                        const customerName = header.querySelector('.accordion-title')?.textContent || 'Survey';
                        this.announce(`${customerName} ${isExpanded ? 'collapsed' : 'expanded'}`);
                    }
                });
            }

            /**
             * Set up table accessibility
             */
            setupTableAccessibility() {
                // Add row navigation
                document.addEventListener('keydown', (e) => {
                    if (e.target.matches('td, th')) {
                        this.handleTableNavigation(e);
                    }
                });

                // Announce table updates
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.target.matches('tbody')) {
                            const table = mutation.target.closest('table');
                            const rows = table.querySelectorAll('tbody tr');
                            if (rows.length > 0 && !rows[0].textContent.includes('Loading')) {
                                const tableName = table.getAttribute('aria-labelledby');
                                const heading = document.getElementById(tableName);
                                if (heading) {
                                    this.announce(`${heading.textContent} updated with ${rows.length} items`);
                                }
                            }
                        }
                    });
                });

                document.querySelectorAll('tbody').forEach(tbody => {
                    observer.observe(tbody, { childList: true, subtree: true });
                });
            }

            /**
             * Handle table keyboard navigation
             */
            handleTableNavigation(e) {
                const cell = e.target;
                const row = cell.closest('tr');
                const table = cell.closest('table');
                const cells = Array.from(row.querySelectorAll('td, th'));
                const rows = Array.from(table.querySelectorAll('tr'));
                const currentCellIndex = cells.indexOf(cell);
                const currentRowIndex = rows.indexOf(row);

                switch (e.key) {
                    case 'ArrowLeft':
                        e.preventDefault();
                        if (currentCellIndex > 0) {
                            cells[currentCellIndex - 1].focus();
                        }
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        if (currentCellIndex < cells.length - 1) {
                            cells[currentCellIndex + 1].focus();
                        }
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        if (currentRowIndex > 0) {
                            const targetRow = rows[currentRowIndex - 1];
                            const targetCells = targetRow.querySelectorAll('td, th');
                            if (targetCells[currentCellIndex]) {
                                targetCells[currentCellIndex].focus();
                            }
                        }
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        if (currentRowIndex < rows.length - 1) {
                            const targetRow = rows[currentRowIndex + 1];
                            const targetCells = targetRow.querySelectorAll('td, th');
                            if (targetCells[currentCellIndex]) {
                                targetCells[currentCellIndex].focus();
                            }
                        }
                        break;
                }
            }
        }

        /**
         * Performance Manager
         * Handles optimizations for large datasets and cross-browser compatibility
         */
        class PerformanceManager {
            constructor() {
                this.virtualScrollThreshold = 100;
                this.debounceDelay = 300;
                this.init();
            }

            init() {
                this.setupVirtualScrolling();
                this.setupDebouncing();
                this.setupIntersectionObserver();
                this.setupCrossBrowserCompatibility();
            }

            /**
             * Set up virtual scrolling for large datasets
             */
            setupVirtualScrolling() {
                const tables = document.querySelectorAll('.data-table');
                tables.forEach(table => {
                    const tbody = table.querySelector('tbody');
                    if (tbody) {
                        this.enableVirtualScrolling(tbody);
                    }
                });
            }

            /**
             * Enable virtual scrolling for table body
             */
            enableVirtualScrolling(tbody) {
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'childList') {
                            const rows = tbody.querySelectorAll('tr');
                            if (rows.length > this.virtualScrollThreshold) {
                                this.implementVirtualScrolling(tbody, rows);
                            }
                        }
                    });
                });

                observer.observe(tbody, { childList: true });
            }

            /**
             * Implement virtual scrolling for large row sets
             */
            implementVirtualScrolling(tbody, rows) {
                const container = tbody.closest('.data-table-container');
                if (!container || container.classList.contains('virtual-scroll-enabled')) return;

                container.classList.add('virtual-scroll-enabled');

                // Create virtual scroll container
                const virtualContainer = document.createElement('div');
                virtualContainer.className = 'virtual-scroll-container';

                const virtualContent = document.createElement('div');
                virtualContent.className = 'virtual-scroll-content';

                // Move table into virtual container
                const table = tbody.closest('table');
                container.insertBefore(virtualContainer, table);
                virtualContainer.appendChild(virtualContent);
                virtualContent.appendChild(table);

                // Implement virtual scrolling logic
                this.setupVirtualScrollLogic(virtualContainer, tbody, rows);
            }

            /**
             * Set up virtual scroll logic
             */
            setupVirtualScrollLogic(container, tbody, rows) {
                const rowHeight = 60; // Approximate row height
                const visibleRows = Math.ceil(container.clientHeight / rowHeight) + 5; // Buffer
                let startIndex = 0;

                const updateVisibleRows = () => {
                    const scrollTop = container.scrollTop;
                    startIndex = Math.floor(scrollTop / rowHeight);
                    const endIndex = Math.min(startIndex + visibleRows, rows.length);

                    // Clear tbody
                    tbody.innerHTML = '';

                    // Add visible rows
                    for (let i = startIndex; i < endIndex; i++) {
                        if (rows[i]) {
                            tbody.appendChild(rows[i].cloneNode(true));
                        }
                    }

                    // Update scroll height
                    const totalHeight = rows.length * rowHeight;
                    tbody.style.paddingTop = `${startIndex * rowHeight}px`;
                    tbody.style.paddingBottom = `${(rows.length - endIndex) * rowHeight}px`;
                };

                container.addEventListener('scroll', this.debounce(updateVisibleRows, 16)); // 60fps
                updateVisibleRows(); // Initial render
            }

            /**
             * Set up debouncing for performance
             */
            setupDebouncing() {
                // Debounce resize events
                window.addEventListener('resize', this.debounce(() => {
                    this.handleResize();
                }, this.debounceDelay));

                // Debounce search/filter operations
                document.addEventListener('input', (e) => {
                    if (e.target.matches('[data-search]')) {
                        this.debounce(() => {
                            this.handleSearch(e.target);
                        }, this.debounceDelay)();
                    }
                });
            }

            /**
             * Debounce utility function
             */
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            /**
             * Handle window resize
             */
            handleResize() {
                // Recalculate virtual scroll containers
                const virtualContainers = document.querySelectorAll('.virtual-scroll-container');
                virtualContainers.forEach(container => {
                    // Trigger recalculation
                    container.dispatchEvent(new Event('scroll'));
                });
            }

            /**
             * Set up Intersection Observer for lazy loading
             */
            setupIntersectionObserver() {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const element = entry.target;
                            if (element.dataset.lazyLoad) {
                                this.loadContent(element);
                                observer.unobserve(element);
                            }
                        }
                    });
                }, {
                    rootMargin: '50px'
                });

                // Observe lazy-loadable elements
                document.querySelectorAll('[data-lazy-load]').forEach(el => {
                    observer.observe(el);
                });
            }

            /**
             * Load content for lazy-loaded elements
             */
            loadContent(element) {
                const contentType = element.dataset.lazyLoad;
                switch (contentType) {
                    case 'chart':
                        this.loadChart(element);
                        break;
                    case 'table':
                        this.loadTable(element);
                        break;
                    default:
                }
            }

            /**
             * Set up cross-browser compatibility
             */
            setupCrossBrowserCompatibility() {
                // Polyfill for CSS custom properties in IE
                if (!window.CSS || !CSS.supports('color', 'var(--test)')) {
                    this.polyfillCSSCustomProperties();
                }

                // Polyfill for IntersectionObserver
                if (!window.IntersectionObserver) {
                    this.loadIntersectionObserverPolyfill();
                }

                // Fix for Safari focus issues
                if (navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Chrome')) {
                    this.fixSafariFocusIssues();
                }

                // Fix for IE11 grid issues
                if (navigator.userAgent.includes('Trident')) {
                    this.fixIE11GridIssues();
                }
            }

            /**
             * Polyfill CSS custom properties for IE
             */
            polyfillCSSCustomProperties() {
                // Simple fallback for critical custom properties
                const fallbackStyles = `
                    .nav-tab:focus { outline: 2px solid #1f6a4a; }
                    .accordion-header:focus { outline: 2px solid #1f6a4a; }
                    .table-cell-link:focus { outline: 2px solid #1f6a4a; }
                `;

                const style = document.createElement('style');
                style.textContent = fallbackStyles;
                document.head.appendChild(style);
            }

            /**
             * Fix Safari focus issues
             */
            fixSafariFocusIssues() {
                // Make buttons focusable in Safari
                document.querySelectorAll('button').forEach(button => {
                    if (!button.hasAttribute('tabindex')) {
                        button.setAttribute('tabindex', '0');
                    }
                });
            }

            /**
             * Fix IE11 grid issues
             */
            fixIE11GridIssues() {
                // Add flexbox fallback for IE11
                const ie11Styles = `
                    .metrics-grid { display: flex; flex-wrap: wrap; }
                    .metrics-grid > * { flex: 1; min-width: 300px; }
                `;

                const style = document.createElement('style');
                style.textContent = ie11Styles;
                document.head.appendChild(style);
            }
        }

        // Initialize accessibility and performance managers
        let accessibilityManager;
        let performanceManager;

        // Expose managers globally for debugging and external access
        window.accessibilityManager = null;
        window.performanceManager = null;

        // Initialize application on page load
        document.addEventListener('DOMContentLoaded', () => {
            const appInitializer = new ApplicationInitializer();
            appInitializer.initialize();

            // Initialize accessibility and performance enhancements
            accessibilityManager = new AccessibilityManager();
            performanceManager = new PerformanceManager();

            // Expose globally
            window.accessibilityManager = accessibilityManager;
            window.performanceManager = performanceManager;

            // Announce page load completion
            setTimeout(() => {
                accessibilityManager.announce('Dashboard loaded and ready for use');
            }, 1000);
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                autoRefreshManager.stop();
            } else {
                autoRefreshManager.start();
                // Refresh data when page becomes visible again
                window.DashboardAPI.getData(true).catch(error => {
                    // Visibility refresh failed
                });
            }
        });

        // ===================================================================
        // Data Processing and Calculation Functions
        // ===================================================================

        /**
         * Survey Response Data Processing Class
         * Handles parsing, validation, and calculation of survey metrics
         */
        class SurveyDataProcessor {
            constructor() {
                // Service type mapping to normalize variations
                this.serviceTypeMapping = {
                    // English variations
                    'Last Mile Only': 'Last Mile Only',
                    'Fulfilment Only': 'Fulfillment Only',
                    'Fulfillment Only': 'Fulfillment Only',
                    'Last Mile & Fulfilment': 'Last Mile & Fulfillment',
                    'Last Mile & Fulfillment': 'Last Mile & Fulfillment',

                    // Arabic variations
                    ' ': 'Last Mile Only',
                    ' ': 'Last Mile & Fulfillment',
                    ' ': 'Fulfillment Only'
                };

                this.validServiceTypes = ['Last Mile Only', 'Fulfillment Only', 'Last Mile & Fulfillment'];

                // Account manager name mapping to normalize variations
                this.accountManagerMapping = {
                    'Ibrahim Fadaly': 'Ibrahim Fadaly',
                    'Ibrahim Fadhaly': 'Ibrahim Fadaly', // Normalize spelling variation
                    ' ': 'Ibrahim Fadaly', // Arabic name mapping
                    'Ahmed Saleem': 'Ahmed Saleem',
                    'Ahmed Salem': 'Ahmed Saleem',
                    ' ': 'Ahmed Saleem',
                    ' ': 'Ahmed Saleem',
                    'Ahmed saleem': 'Ahmed Saleem',
                    'Abdullah Ahmed': 'Abdullah Ahmed',
                    ' ': 'Abdullah Ahmed',
                    ' ': 'Abdullah Ahmed',
                    '  ': 'Abdullah Ahmed',
                    '  ': 'Abdullah Ahmed',
                    '  ': 'Abdullah Al Owlaqi',
                    'Abdullah Al Owlaqi': 'Abdullah Al Owlaqi',
                    '': 'Joanna',
                    'Joanna': 'Joanna',
                    'Operation': 'Ahmed Saleem', // Map Operation to Ahmed Saleem
                    'Operations': 'Ahmed Saleem', // Map Operations to Ahmed Saleem
                    // Remove invalid managers for Q3
                    ' ': 'Ahmed Saleem', // Map to Ahmed Saleem instead
                    'Amjad Aljowair': 'Ahmed Saleem', // Map to Ahmed Saleem instead
                    'Starlinks': 'Ahmed Saleem', // Map to Ahmed Saleem instead
                    'Starlinks Team': 'Ahmed Saleem' // Map to Ahmed Saleem instead
                };

                this.validAccountManagers = ['Ibrahim Fadaly', 'Ahmed Saleem', 'Abdullah Ahmed', 'OPS'];
            }

            /**
             * Normalize service type to standard format
             */
            normalizeServiceType(serviceType) {
                if (!serviceType) return null;

                const normalized = this.serviceTypeMapping[serviceType.trim()];
                return normalized || serviceType.trim();
            }

            /**
             * Normalize account manager name to standard format
             */
            normalizeAccountManager(accountManager) {
                if (!accountManager) return null;

                const normalized = this.accountManagerMapping[accountManager.trim()];
                return normalized || accountManager.trim();
            }

            /**
             * Parse and validate survey response data
             * Requirements: 2.2, 8.2
             */
            parseAndValidateSurveyData(rawData) {
                if (!Array.isArray(rawData)) {
                    throw new Error('Survey data must be an array');
                }

                const validatedData = rawData.map((response, index) => {
                    try {
                        return this.validateSurveyResponse(response, index);
                    } catch (error) {
                        return null;
                    }
                }).filter(response => response !== null);

                return validatedData;
            }

            /**
             * Validate individual survey response
             * Requirements: 8.2
             */
            validateSurveyResponse(response, index) {
                const validated = { ...response };

                // Validate required fields
                if (!validated.companyName || typeof validated.companyName !== 'string') {
                    throw new Error(`Invalid company name at row ${index + 1}`);
                }

                // Validate service type
                if (validated.serviceType && !this.validServiceTypes.includes(validated.serviceType)) {
                    // Keep unknown service types as-is
                }

                // Validate rating fields (1-5 scale)
                const ratingFields = [
                    'overallSatisfaction', 'lastMileSatisfaction', 'reverseDeliverySatisfaction',
                    'fulfillmentSatisfaction', 'communicationClarity', 'responsiveness',
                    'problemResolution', 'customizationAbility', 'systemsSatisfaction', 'itSupportSatisfaction'
                ];

                ratingFields.forEach(field => {
                    if (validated[field] !== null && validated[field] !== undefined) {
                        const value = Number(validated[field]);
                        if (isNaN(value) || value < 1 || value > 5) {
                            validated[field] = null;
                        } else {
                            validated[field] = value;
                        }
                    }
                });

                // Validate NPS score (0-10 scale)
                if (validated.npsScore !== null && validated.npsScore !== undefined) {
                    const npsValue = Number(validated.npsScore);
                    if (isNaN(npsValue) || npsValue < 0 || npsValue > 10) {
                        validated.npsScore = null;
                    } else {
                        validated.npsScore = npsValue;
                    }
                }

                // Validate account manager
                if (validated.accountManager && !this.validAccountManagers.includes(validated.accountManager)) {
                    // Keep unknown account managers as-is
                }

                // Validate submission date
                if (validated.submittedAt && !(validated.submittedAt instanceof Date)) {
                    const date = new Date(validated.submittedAt);
                    if (isNaN(date.getTime())) {
                        validated.submittedAt = null;
                        validated.isCompleted = false;
                    } else {
                        validated.submittedAt = date;
                        validated.isCompleted = true;
                    }
                }

                return validated;
            }

            /**
             * Calculate completion rates and satisfaction percentages
             * Requirements: 3.1, 3.2
             */
            calculateOverallMetrics(surveyData) {


                // De-duplicate by normalized company for accurate Q-level metrics
                const normalizeName = (name) => String(name || '')
                    .toLowerCase()
                    .replace(/&/g, 'and')
                    .replace(/[^\p{L}\p{N}]+/gu, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();

                const companyMap = new Map();
                surveyData.forEach(s => {
                    const key = normalizeName(s.companyName);
                    if (!key) return;
                    const entry = companyMap.get(key) || {
                        companyName: s.companyName,
                        isCompleted: false,
                        ratings: []
                    };
                    if (s.isCompleted) {
                        entry.isCompleted = true;
                        if (typeof s.overallSatisfaction === 'number') {
                            entry.ratings.push(s.overallSatisfaction);
                        }
                    }
                    companyMap.set(key, entry);
                });

                // Get pending customers count
                const pendingCustomers = this.getPendingSurveys(surveyData);
                const pendingSurveysCount = pendingCustomers.length;

                const totalSurveysIncludingPending = companyMap.size + pendingSurveysCount;
                const completedSurveys = companyMap.size; // Only completed surveys

                // For display: show total survey responses (only completed responses)
                const totalSurveysForDisplay = surveyData.length;

                // Calculate actual completion rate
                const completionPercentage = totalSurveysIncludingPending > 0
                    ? Math.round((completedSurveys / totalSurveysIncludingPending) * 100)
                    : 100;


                // Calculate satisfied customers (ratings 4-5) - use all survey responses
                const satisfiedCustomers = surveyData.filter(survey =>
                    survey.overallSatisfaction >= 4
                ).length;

                const satisfiedCustomersPercentage = totalSurveysForDisplay > 0
                    ? Math.round((satisfiedCustomers / totalSurveysForDisplay) * 100)
                    : 0;

                // Calculate Net Promoter Score (NPS)
                const npsData = MetricCalculator.calculateNPS(surveyData);

                // Calculate average satisfaction rating
                const perCompanyAverages = Array.from(companyMap.values())
                    .filter(e => e.isCompleted && e.ratings.length > 0)
                    .map(e => e.ratings.reduce((a, b) => a + b, 0) / e.ratings.length);

                const averageSatisfaction = perCompanyAverages.length > 0
                    ? perCompanyAverages.reduce((a, b) => a + b, 0) / perCompanyAverages.length
                    : 0;



                return {
                    totalSurveys: totalSurveysForDisplay,
                    completedSurveys,
                    pendingSurveys: pendingSurveysCount,
                    completionPercentage,
                    satisfiedCustomers,
                    satisfiedCustomersPercentage,
                    averageSatisfaction: Math.round(averageSatisfaction * 10) / 10,
                    totalSurveysIncludingPending,
                    npsData: npsData
                };
            }

            /**
             * Calculate product type breakdown for service types
             * Requirements: 3.3
             */
            calculateProductTypeBreakdown(surveyData) {
                const breakdown = {
                    'Last Mile Only': { completed: 0, satisfied: 0, total: 0 },
                    'Fulfillment Only': { completed: 0, satisfied: 0, total: 0 },
                    'Last Mile & Fulfillment': { completed: 0, satisfied: 0, total: 0 }
                };

                surveyData.forEach(survey => {
                    const serviceType = survey.serviceType;

                    if (breakdown[serviceType]) {
                        breakdown[serviceType].total++;
                        // Force all surveys to be completed
                        breakdown[serviceType].completed++;

                        if (survey.overallSatisfaction >= 4) {
                            breakdown[serviceType].satisfied++;
                        }
                    }
                });

                // Calculate percentages for each service type
                Object.keys(breakdown).forEach(serviceType => {
                    const data = breakdown[serviceType];
                    data.completionRate = data.total > 0 ? 100 : 0; // Force 100% completion rate
                    data.satisfactionRate = data.completed > 0 ? Math.round((data.satisfied / data.completed) * 100) : 0;
                });

                return breakdown;
            }

            /**
             * Calculate account manager performance metrics
             * Requirements: 6.2, 6.4
             */
            calculateAccountManagerMetrics(surveyData) {
                const managerMetrics = {};

                // Initialize metrics for known managers
                this.validAccountManagers.forEach(manager => {
                    managerMetrics[manager] = {
                        name: manager,
                        totalAssigned: 0,
                        completed: 0,
                        pending: 0,
                        satisfied: 0,
                        completionRate: 0,
                        satisfactionRate: 0
                    };
                });

                // Process survey data
                surveyData.forEach(survey => {
                    let manager = survey.accountManager;

                    // Normalize account manager names
                    if (manager === 'Ibrahim Fadhaly') manager = 'Ibrahim Fadaly';
                    if (manager === 'Ahmed Salem') manager = 'Ahmed Saleem';

                    if (manager) {
                        // Initialize manager if not in known list (dynamic detection)
                        if (!managerMetrics[manager]) {
                            managerMetrics[manager] = {
                                name: manager,
                                totalAssigned: 0,
                                completed: 0,
                                pending: 0,
                                satisfied: 0,
                                completionRate: 0,
                                satisfactionRate: 0
                            };
                        }

                        const metrics = managerMetrics[manager];
                        metrics.totalAssigned++;

                        if (survey.submittedAt) {
                            metrics.completed++;

                            if (survey.overallSatisfaction >= 4) {
                                metrics.satisfied++;
                            }
                        } else {
                            metrics.pending++;
                        }
                    }
                });

                // Add Q3 pending customers to account manager metrics (only for Q3)
                const pendingCustomers = this.getPendingSurveys(surveyData);
                pendingCustomers.forEach(customer => {
                    let manager = customer.accountManager;

                    // Normalize account manager names
                    if (manager === 'Ibrahim Fadhaly') manager = 'Ibrahim Fadaly';
                    if (manager === 'Ahmed Salem') manager = 'Ahmed Saleem';

                    if (manager) {
                        // Initialize manager if not in known list
                        if (!managerMetrics[manager]) {
                            managerMetrics[manager] = {
                                name: manager,
                                totalAssigned: 0,
                                completed: 0,
                                pending: 0,
                                satisfied: 0,
                                completionRate: 0,
                                satisfactionRate: 0
                            };
                        }

                        const metrics = managerMetrics[manager];
                        metrics.totalAssigned++;
                        metrics.pending++;
                    }
                });

                // Calculate percentages for each manager
                Object.keys(managerMetrics).forEach(manager => {
                    const metrics = managerMetrics[manager];

                    metrics.completionRate = metrics.totalAssigned > 0
                        ? Math.round((metrics.completed / metrics.totalAssigned) * 100 * 10) / 10
                        : 0;

                    metrics.satisfactionRate = metrics.completed > 0
                        ? Math.round((metrics.satisfied / metrics.completed) * 100 * 10) / 10
                        : 0;
                });

                return managerMetrics;
            }

            /**
             * Get completed surveys sorted by completion date
             * Requirements: 4.2, 4.6
             */
            getCompletedSurveys(surveyData) {
                return surveyData
                    .filter(survey => survey.submittedAt)
                    .sort((a, b) => {
                        // Sort by completion status first, then by company name
                        if (!a.isCompleted && !b.isCompleted) return a.companyName.localeCompare(b.companyName);
                        if (!a.isCompleted) return 1;
                        if (!b.isCompleted) return -1;
                        return b.submittedAt.getTime() - a.submittedAt.getTime();
                    });
            }

            /**
             * Get pending surveys sorted alphabetically by customer name
             * Requirements: 4.3, 4.7
             */
            getPendingSurveys(surveyData) {
                // Only show pending customers for Q3
                const currentQuarter = window.quarterFilter?.currentQuarter || 'all';
                if (currentQuarter.toLowerCase() !== 'q3') {
                    return []; // No pending customers for Q1, Q2, or All
                }

                // Get Q3 pending customers and filter out those who have already submitted
                const q3PendingCustomers = generateQ3PendingCustomers();

                // Get list of companies that have already submitted surveys
                const submittedCompanies = new Set(
                    surveyData
                        .filter(survey => survey.submittedAt && survey.companyName)
                        .map(survey => survey.companyName.toLowerCase().trim())
                );

                // Filter out customers who have already submitted
                const stillPending = q3PendingCustomers.filter(customer => {
                    const customerName = customer.companyName.toLowerCase().trim();
                    return !submittedCompanies.has(customerName);
                });

                // Sort alphabetically by company name
                return stillPending.sort((a, b) =>
                    a.companyName.localeCompare(b.companyName)
                );
            }

            /**
             * Format survey data for accordion display
             * Requirements: 5.1, 5.2, 5.3
             */
            formatSurveyForAccordion(survey) {


                const formatDate = (date) => {
                    if (!date) return 'Not completed';
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                };

                const getRatingColor = (rating) => {
                    if (rating >= 4) return 'excellent';
                    if (rating === 3) return 'average';
                    if (rating >= 1) return 'poor';
                    return 'unknown';
                };

                const formatRating = (rating) => {
                    return rating !== null && rating !== undefined ? `${rating}/5` : 'N/A';
                };

                return {
                    id: survey.id,
                    companyName: survey.companyName,
                    completionDate: formatDate(survey.submittedAt),
                    overallRating: survey.overallSatisfaction,
                    ratingColor: getRatingColor(survey.overallSatisfaction),
                    formattedRating: formatRating(survey.overallSatisfaction),
                    accountManager: survey.accountManager || 'Not assigned',
                    serviceType: survey.serviceType || 'Not specified',
                    questions: [
                        { label: 'Overall Satisfaction', answer: formatRating(survey.overallSatisfaction) },
                        { label: 'NPS Score', answer: survey.npsScore ? `${survey.npsScore}/10` : 'N/A' },
                        { label: 'Last Mile Satisfaction', answer: formatRating(survey.lastMileSatisfaction) },
                        { label: 'Reverse Delivery Satisfaction', answer: formatRating(survey.reverseDeliverySatisfaction) },
                        { label: 'Fulfillment Satisfaction', answer: formatRating(survey.fulfillmentSatisfaction) },
                        { label: 'Communication Clarity', answer: formatRating(survey.communicationClarity) },
                        { label: 'Responsiveness', answer: formatRating(survey.responsiveness) },
                        { label: 'Problem Resolution', answer: formatRating(survey.problemResolution) },
                        { label: 'Customization Ability', answer: formatRating(survey.customizationAbility) },
                        { label: 'Systems Satisfaction', answer: formatRating(survey.systemsSatisfaction) },
                        { label: 'IT Support Satisfaction', answer: formatRating(survey.itSupportSatisfaction) },
                        { label: 'Additional Comments', answer: survey.suggestions || 'No suggestions provided' },
                        { label: 'LaunchPad Non-Usage Explanation', answer: survey.launchpadExplanation || 'Empty' },
                        { label: 'General Improvement Suggestions', answer: survey.generalImprovement || 'Empty' }
                    ]
                };
            }

            /**
             * Handle missing or invalid data gracefully
             * Requirements: 8.2
             */
            handleMissingData(data, fieldName, defaultValue = null) {
                if (data === null || data === undefined || data === '') {
                    return defaultValue;
                }
                return data;
            }

            /**
             * Validate data integrity across all surveys
             * Requirements: 8.2
             */
            validateDataIntegrity(surveyData) {
                const issues = [];

                surveyData.forEach((survey, index) => {
                    // Check for missing critical fields
                    if (!survey.companyName) {
                        issues.push(`Survey ${index + 1}: Missing company name`);
                    }

                    // Treat submittedAt as source of truth; do not flag mismatches

                    // Check for inconsistent ratings
                    if (survey.overallSatisfaction && (survey.overallSatisfaction < 1 || survey.overallSatisfaction > 5)) {
                        issues.push(`Survey ${index + 1}: Overall satisfaction rating out of range (${survey.overallSatisfaction})`);
                    }
                });

                return {
                    isValid: issues.length === 0,
                    issues: issues,
                    totalSurveys: surveyData.length,
                    validSurveys: surveyData.length - issues.length
                };
            }
        }

        /**
         * Metric Calculation Utilities
         * Helper functions for specific metric calculations
         */
        class MetricCalculator {
            /**
             * Calculate percentage with proper rounding
             */
            static calculatePercentage(numerator, denominator, decimalPlaces = 0) {
                if (denominator === 0) return 0;
                const percentage = (numerator / denominator) * 100;
                return Math.round(percentage * Math.pow(10, decimalPlaces)) / Math.pow(10, decimalPlaces);
            }

            /**
             * Calculate average rating with validation
             */
            static calculateAverageRating(ratings, decimalPlaces = 1) {
                const validRatings = ratings.filter(rating =>
                    rating !== null && rating !== undefined && !isNaN(rating)
                );

                if (validRatings.length === 0) return 0;

                const average = validRatings.reduce((sum, rating) => sum + rating, 0) / validRatings.length;
                return Math.round(average * Math.pow(10, decimalPlaces)) / Math.pow(10, decimalPlaces);
            }

            /**
             * Count satisfied customers (ratings 4-5)
             */
            static countSatisfiedCustomers(surveys) {
                return surveys.filter(survey =>
                    survey.isCompleted &&
                    survey.overallSatisfaction !== null &&
                    survey.overallSatisfaction >= 4
                ).length;
            }

            /**
             * Calculate Net Promoter Score (NPS)
             * Detractors: 0-6, Passives: 7-8, Promoters: 9-10
             * NPS = % Promoters - % Detractors
             */
            static calculateNPS(surveys) {
                const validNPSScores = surveys.filter(survey =>
                    survey.isCompleted &&
                    survey.npsScore !== null &&
                    survey.npsScore !== undefined &&
                    !isNaN(survey.npsScore)
                );

                if (validNPSScores.length === 0) {
                    return {
                        npsScore: 0,
                        detractors: { count: 0, percentage: 0 },
                        passives: { count: 0, percentage: 0 },
                        promoters: { count: 0, percentage: 0 },
                        totalResponses: 0
                    };
                }

                const detractors = validNPSScores.filter(survey => survey.npsScore >= 0 && survey.npsScore <= 6);
                const passives = validNPSScores.filter(survey => survey.npsScore >= 7 && survey.npsScore <= 8);
                const promoters = validNPSScores.filter(survey => survey.npsScore >= 9 && survey.npsScore <= 10);

                const total = validNPSScores.length;
                const detractorPercentage = this.calculatePercentage(detractors.length, total, 1);
                const passivePercentage = this.calculatePercentage(passives.length, total, 1);
                const promoterPercentage = this.calculatePercentage(promoters.length, total, 1);

                const npsScore = Math.round(promoterPercentage - detractorPercentage);

                return {
                    npsScore: npsScore,
                    detractors: { count: detractors.length, percentage: detractorPercentage },
                    passives: { count: passives.length, percentage: passivePercentage },
                    promoters: { count: promoters.length, percentage: promoterPercentage },
                    totalResponses: total
                };
            }



            /**
             * Group surveys by field value
             */
            static groupSurveysByField(surveys, fieldName) {
                const groups = {};

                surveys.forEach(survey => {
                    const value = survey[fieldName] || 'Unknown';
                    if (!groups[value]) {
                        groups[value] = [];
                    }
                    groups[value].push(survey);
                });

                return groups;
            }
        }

        // Initialize data processor
        const surveyDataProcessor = new SurveyDataProcessor();

        // Add data processing methods to the public API
        window.DashboardAPI.DataProcessor = {
            /**
             * Process raw survey data and return calculated metrics
             */
            async processData(forceRefresh = false) {
                try {
                    const rawData = await window.DashboardAPI.getData(forceRefresh);
                    const validatedData = surveyDataProcessor.parseAndValidateSurveyData(rawData);

                    return {
                        rawData: validatedData,
                        overallMetrics: surveyDataProcessor.calculateOverallMetrics(validatedData),
                        productTypeBreakdown: surveyDataProcessor.calculateProductTypeBreakdown(validatedData),
                        accountManagerMetrics: surveyDataProcessor.calculateAccountManagerMetrics(validatedData),
                        completedSurveys: surveyDataProcessor.getCompletedSurveys(validatedData),
                        pendingSurveys: surveyDataProcessor.getPendingSurveys(validatedData),
                        dataIntegrity: surveyDataProcessor.validateDataIntegrity(validatedData),
                        questionSatisfaction: surveyDataProcessor.calculateOverallMetrics(validatedData).questionSatisfaction
                    };
                } catch (error) {
                    throw error;
                }
            },

            /**
             * Get formatted survey data for accordion display
             */
            formatSurveyForDisplay(survey) {
                return surveyDataProcessor.formatSurveyForAccordion(survey);
            },

            /**
             * Validate survey data integrity
             */
            validateData(surveyData) {
                return surveyDataProcessor.validateDataIntegrity(surveyData);
            },

            /**
             * Access to metric calculator utilities
             */
            MetricCalculator: MetricCalculator
        };

    </script>


    <!-- Live region for screen reader announcements -->
    <div id="live-region" class="sr-only" aria-live="polite" aria-atomic="true"></div>

    <div class="dashboard-container">
        <!-- Vertical Sidebar -->
        <aside class="sidebar" role="navigation">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <img src="logo.png" alt="Company Logo" class="sidebar-logo-image">
                </div>
                <div class="dashboard-title">
                    <h1>CSAT Tracking Dashboard</h1>
                </div>
            </div>

            <nav class="navigation" role="tablist" aria-label="Dashboard sections">
                <button class="nav-tab active" data-tab="csat-summary" role="tab" aria-selected="true"
                    aria-controls="csat-summary-panel" id="tab-csat-summary">
                    CSAT Summary
                </button>
                <button class="nav-tab" data-tab="customer-status" role="tab" aria-selected="false"
                    aria-controls="customer-status-panel" id="tab-customer-status">
                    Customer Status
                </button>
                <button class="nav-tab" data-tab="completed-surveys" role="tab" aria-selected="false"
                    aria-controls="completed-surveys-panel" id="tab-completed-surveys">
                    Completed Surveys
                </button>
                <button class="nav-tab" data-tab="account-manager-performance" role="tab" aria-selected="false"
                    aria-controls="account-manager-performance-panel" id="tab-account-manager-performance">
                    Account Managers
                </button>
            </nav>

            <div class="sidebar-quarter-filter">
                <label for="quarter-select" class="sidebar-quarter-filter-label">Quarter:</label>
                <div class="sidebar-quarter-filter-wrapper">
                    <select id="quarter-select" class="sidebar-quarter-filter-select" aria-label="Filter by quarter">
                        <option value="all">All Quarters</option>
                        <option value="q1">Q1 2025</option>
                        <option value="q2">Q2 2025</option>
                        <option value="q3">Q3 2025</option>
                        <option value="q4">Q4 2025</option>
                    </select>
                </div>
            </div>


        </aside>

        <!-- Main Content Area -->
        <main class="main-content" id="main-content" tabindex="-1">
            <!-- CSAT Summary Section -->
            <section id="csat-summary-panel" class="content-section active" role="tabpanel"
                aria-labelledby="tab-csat-summary" aria-hidden="false">
                <div class="content-grid">
                    <div class="mt-lg">
                        <h2 class="heading-md mb-lg">Customer Satisfaction Summary</h2>

                        <!-- Loading State -->
                        <div id="csat-loading" class="four-column-grid" style="display: none;">
                            <div class="skeleton-card">
                                <div class="skeleton skeleton-text title"></div>
                                <div class="skeleton skeleton-metric"></div>
                                <div class="skeleton skeleton-text"></div>
                            </div>
                            <div class="skeleton-card">
                                <div class="skeleton skeleton-text title"></div>
                                <div class="skeleton skeleton-metric"></div>
                                <div class="skeleton skeleton-text"></div>
                            </div>
                            <div class="skeleton-card">
                                <div class="skeleton skeleton-text title"></div>
                                <div class="skeleton skeleton-metric"></div>
                                <div class="skeleton skeleton-text"></div>
                                <div class="skeleton skeleton-progress"></div>
                            </div>
                            <div class="skeleton-card">
                                <div class="skeleton skeleton-text title"></div>
                                <div class="skeleton skeleton-metric"></div>
                                <div class="skeleton skeleton-text"></div>
                                <div class="skeleton skeleton-progress"></div>
                            </div>
                        </div>

                        <!-- Main Metrics Grid -->
                        <div id="csat-metrics" class="four-column-grid">
                            <!-- Total Responses Card (First) -->
                            <div class="metric-card">
                                <div class="metric-card-header">
                                    <span class="metric-card-title">Total Responses</span>
                                </div>
                                <div id="total-responses-value" class="metric-value large">0</div>
                                <div class="metric-label">Survey Responses</div>
                                <div class="progress-container">
                                    <div class="progress-label">
                                        <span class="progress-label-text">Total Surveys</span>
                                        <span id="quarter-responses-value" class="progress-label-value">0</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Completion Rate Card (Second) -->
                            <div class="metric-card">
                                <div class="metric-card-header">
                                    <span class="metric-card-title">Completion Rate</span>
                                </div>
                                <div id="completion-rate-value" class="metric-value success">0%</div>
                                <div class="metric-label">Response Rate</div>
                                <div class="progress-container">
                                    <div class="progress-bar">
                                        <div id="completion-rate-progress" class="progress-fill success"
                                            style="width: 0%">
                                        </div>
                                    </div>
                                </div>
                                <div class="progress-container">
                                    <div class="progress-label">
                                        <span class="progress-label-text">Completed</span>
                                        <span id="completed-customers-count" class="progress-label-value">0</span>
                                    </div>
                                </div>
                                <div class="progress-container">
                                    <div class="progress-label">
                                        <span class="progress-label-text">Pending</span>
                                        <span id="pending-customers-count" class="progress-label-value">0</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Satisfaction Rate Card (Third) -->
                            <div class="metric-card">
                                <div class="metric-card-header">
                                    <span class="metric-card-title">Satisfaction Rate</span>
                                </div>
                                <div id="satisfaction-rate-value" class="metric-value">0%</div>
                                <div class="metric-label">Customers Rating 4-5</div>
                                <div class="progress-container">
                                    <div class="progress-bar">
                                        <div id="satisfaction-rate-progress" class="progress-fill" style="width: 0%">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Net Promoter Score Card (Fourth - Far Right) -->
                            <div class="metric-card">
                                <div class="metric-card-header">
                                    <span class="metric-card-title">Net Promoter Score</span>
                                </div>
                                <div id="nps-score-value" class="metric-value large">0</div>
                                <div class="metric-label">NPS Score</div>
                                <div class="progress-container">
                                    <div class="progress-label">
                                        <span class="progress-label-text">Promoters</span>
                                        <span id="nps-promoters-value" class="progress-label-value">0% (0)</span>
                                    </div>
                                </div>
                                <div class="progress-container">
                                    <div class="progress-label">
                                        <span class="progress-label-text">Passives</span>
                                        <span id="nps-passives-value" class="progress-label-value">0% (0)</span>
                                    </div>
                                </div>
                                <div class="progress-container">
                                    <div class="progress-label">
                                        <span class="progress-label-text">Detractors</span>
                                        <span id="nps-detractors-value" class="progress-label-value">0% (0)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Product Type Breakdown -->
                    <div style="margin-top: var(--spacing-3xl);">
                        <h2 class="heading-md mb-lg">Service Type Breakdown</h2>

                        <!-- Loading State for Product Breakdown -->
                        <div id="product-breakdown-loading" class="three-column-grid" style="display: none;">
                            <div class="skeleton-card">
                                <div class="skeleton skeleton-text title"></div>
                                <div class="skeleton skeleton-metric"></div>
                                <div class="skeleton skeleton-text"></div>
                                <div class="skeleton skeleton-progress"></div>
                            </div>
                            <div class="skeleton-card">
                                <div class="skeleton skeleton-text title"></div>
                                <div class="skeleton skeleton-metric"></div>
                                <div class="skeleton skeleton-text"></div>
                                <div class="skeleton skeleton-progress"></div>
                            </div>
                            <div class="skeleton-card">
                                <div class="skeleton skeleton-text title"></div>
                                <div class="skeleton skeleton-metric"></div>
                                <div class="skeleton skeleton-text"></div>
                                <div class="skeleton skeleton-progress"></div>
                            </div>
                        </div>

                        <!-- Product Type Cards -->
                        <div id="product-breakdown" class="three-column-grid">
                            <!-- Last Mile Only Card -->
                            <div class="metric-card">
                                <div class="metric-card-header">
                                    <span class="metric-card-title">Last Mile Only</span>
                                </div>

                                <div class="metric-label"
                                    style="margin-bottom: var(--spacing-md); color: var(--text-tertiary); font-size: 0.875rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em;">
                                    Satisfaction Rate</div>
                                <div id="lastmile-satisfaction-rate" class="metric-value"
                                    style="margin-bottom: var(--spacing-md);">0%</div>
                                <div class="metric-label" style="color: var(--text-muted); font-size: 0.75rem;">
                                    Customers Rating 4-5</div>

                                <div class="progress-container" style="margin-top: var(--spacing-lg);">
                                    <div class="progress-bar">
                                        <div id="lastmile-satisfaction-progress"
                                            class="progress-fill satisfaction-progress" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Fulfillment Only Card -->
                            <div class="metric-card">
                                <div class="metric-card-header">
                                    <span class="metric-card-title">Fulfillment Only</span>
                                </div>

                                <div class="metric-label"
                                    style="margin-bottom: var(--spacing-md); color: var(--text-tertiary); font-size: 0.875rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em;">
                                    Satisfaction Rate</div>
                                <div id="fulfillment-satisfaction-rate" class="metric-value"
                                    style="margin-bottom: var(--spacing-md);">0%</div>
                                <div class="metric-label" style="color: var(--text-muted); font-size: 0.75rem;">
                                    Customers Rating 4-5</div>

                                <div class="progress-container" style="margin-top: var(--spacing-lg);">
                                    <div class="progress-bar">
                                        <div id="fulfillment-satisfaction-progress"
                                            class="progress-fill satisfaction-progress" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Last Mile & Fulfillment Card -->
                            <div class="metric-card">
                                <div class="metric-card-header">
                                    <span class="metric-card-title">Last Mile & Fulfillment</span>
                                </div>

                                <div class="metric-label"
                                    style="margin-bottom: var(--spacing-md); color: var(--text-tertiary); font-size: 0.875rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em;">
                                    Satisfaction Rate</div>
                                <div id="combined-satisfaction-rate" class="metric-value"
                                    style="margin-bottom: var(--spacing-md);">0%</div>
                                <div class="metric-label" style="color: var(--text-muted); font-size: 0.75rem;">
                                    Customers Rating 4-5</div>

                                <div class="progress-container" style="margin-top: var(--spacing-lg);">
                                    <div class="progress-bar">
                                        <div id="combined-satisfaction-progress"
                                            class="progress-fill satisfaction-progress" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>
            </section>

            <!-- Customer Status Section -->
            <section id="customer-status-panel" class="content-section" role="tabpanel"
                aria-labelledby="tab-customer-status" aria-hidden="true">
                <div class="content-grid">
                    <h1 class="heading-lg mb-lg">Customer Status</h1>

                    <!-- Loading State -->
                    <div id="customer-status-loading" class="two-column-grid" style="display: none;">
                        <div class="data-table-container">
                            <h2 class="heading-md"
                                style="padding: var(--spacing-lg); margin: 0; border-bottom: 1px solid var(--primary-border);">
                                Completed Surveys</h2>
                            <div style="padding: var(--spacing-lg);">
                                <div class="skeleton skeleton-table-row"></div>
                                <div class="skeleton skeleton-table-row"></div>
                                <div class="skeleton skeleton-table-row"></div>
                            </div>
                        </div>
                        <div class="data-table-container">
                            <h2 class="heading-md"
                                style="padding: var(--spacing-lg); margin: 0; border-bottom: 1px solid var(--primary-border);">
                                Pending Surveys</h2>
                            <div style="padding: var(--spacing-lg);">
                                <div class="skeleton skeleton-table-row"></div>
                                <div class="skeleton skeleton-table-row"></div>
                                <div class="skeleton skeleton-table-row"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Status Tables -->
                    <div id="customer-status-tables" class="two-column-grid">
                        <!-- Completed Surveys Table -->
                        <div class="data-table-container">
                            <h2 class="heading-md"
                                style="padding: var(--spacing-lg); margin: 0; border-bottom: 1px solid var(--primary-border);"
                                id="completed-surveys-heading">
                                Completed Surveys</h2>
                            <table id="completed-surveys-table" class="data-table" role="table"
                                aria-labelledby="completed-surveys-heading"
                                aria-describedby="completed-surveys-description">
                                <caption id="completed-surveys-description" class="sr-only">
                                    Table showing customers who have completed satisfaction surveys, with completion
                                    dates and assigned account managers. Click customer names to view detailed
                                    responses.
                                </caption>
                                <thead>
                                    <tr role="row">
                                        <th role="columnheader" scope="col" aria-sort="none">Customer Name</th>
                                        <th role="columnheader" scope="col" aria-sort="none">Account Manager</th>
                                        <th role="columnheader" scope="col" aria-sort="descending">Completion Date</th>
                                        <th role="columnheader" scope="col" aria-sort="none">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be populated dynamically -->
                                    <tr>
                                        <td colspan="4"
                                            style="text-align: center; padding: var(--spacing-xl); color: var(--text-secondary);"
                                            role="status" aria-live="polite">
                                            Loading customer data...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pending Surveys Table -->
                        <div class="data-table-container">
                            <h2 class="heading-md"
                                style="padding: var(--spacing-lg); margin: 0; border-bottom: 1px solid var(--primary-border);"
                                id="pending-surveys-heading">
                                Pending Surveys</h2>
                            <table id="pending-surveys-table" class="data-table" role="table"
                                aria-labelledby="pending-surveys-heading"
                                aria-describedby="pending-surveys-description">
                                <caption id="pending-surveys-description" class="sr-only">
                                    Table showing customers with pending satisfaction surveys and their assigned account
                                    managers. Sorted alphabetically by customer name.
                                </caption>
                                <thead>
                                    <tr role="row">
                                        <th role="columnheader" scope="col" aria-sort="ascending">Customer Name</th>
                                        <th role="columnheader" scope="col" aria-sort="none">Account Manager</th>
                                        <th role="columnheader" scope="col" aria-sort="none">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be populated dynamically -->
                                    <tr>
                                        <td colspan="3"
                                            style="text-align: center; padding: var(--spacing-xl); color: var(--text-secondary);"
                                            role="status" aria-live="polite">
                                            Loading customer data...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </section>

            <!-- Completed Surveys Section -->
            <section id="completed-surveys-panel" class="content-section" role="tabpanel"
                aria-labelledby="tab-completed-surveys" aria-hidden="true">
                <div class="content-grid">
                    <h1 class="heading-lg mb-lg">Completed Surveys</h1>
                    <div class="full-width-grid">
                        <!-- Dynamic Accordion Interface for Survey Details -->
                        <div id="completed-surveys-accordion" class="accordion-container">
                            <!-- Accordion cards will be dynamically populated here -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Account Manager Performance Section -->
            <section id="account-manager-performance-panel" class="content-section" role="tabpanel"
                aria-labelledby="tab-account-manager-performance" aria-hidden="true">
                <div class="content-grid">
                    <h1 class="heading-lg mb-lg">Account Manager Performance</h1>

                    <!-- Loading State -->
                    <div id="account-manager-loading" class="full-width-grid" style="display: none;">
                        <div class="data-table-container">
                            <div style="padding: var(--spacing-lg);">
                                <div class="skeleton skeleton-table-row"></div>
                                <div class="skeleton skeleton-table-row"></div>
                                <div class="skeleton skeleton-table-row"></div>
                                <div class="skeleton skeleton-table-row"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Account Manager Performance Table -->
                    <div id="account-manager-table" class="full-width-grid">
                        <div class="data-table-container">
                            <h2 class="heading-md"
                                style="padding: var(--spacing-lg); margin: 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                Account Manager Performance
                            </h2>
                            <table class="data-table" role="table">
                                <thead>
                                    <tr role="row">
                                        <th role="columnheader" scope="col">Account Manager</th>
                                        <th role="columnheader" scope="col">Completed</th>
                                        <th role="columnheader" scope="col">Pending</th>
                                        <th role="columnheader" scope="col">Progress</th>
                                        <th role="columnheader" scope="col">CSAT Score</th>
                                    </tr>
                                </thead>
                                <tbody id="account-manager-tbody">
                                    <!-- Data will be populated dynamically -->
                                    <tr>
                                        <td colspan="5"
                                            style="text-align: center; padding: var(--spacing-xl); color: var(--text-secondary);"
                                            role="status" aria-live="polite">
                                            Loading account manager data...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Basic tab navigation functionality for foundation
        document.addEventListener('DOMContentLoaded', function () {
            const tabs = document.querySelectorAll('.nav-tab');
            const sections = document.querySelectorAll('.content-section');

            // Load active tab from sessionStorage
            const activeTab = sessionStorage.getItem('activeTab') || 'csat-summary';
            showTab(activeTab);

            tabs.forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabId = this.getAttribute('data-tab');
                    showTab(tabId);
                    sessionStorage.setItem('activeTab', tabId);
                });

                // Keyboard navigation
                tab.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.click();
                    }
                });
            });

            function showTab(tabId) {
                // Update tab states
                tabs.forEach(tab => {
                    const isActive = tab.getAttribute('data-tab') === tabId;
                    tab.classList.toggle('active', isActive);
                });

                // Update section visibility
                sections.forEach(section => {
                    const isActive = section.id === tabId + '-panel';
                    section.classList.toggle('active', isActive);
                });

                // Smooth scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });

                // Re-apply the current quarter filter whenever switching tabs


                // Add delay to ensure tab content is loaded before applying filter
                setTimeout(() => {
                    try {
                        if (window.quarterFilter && typeof window.quarterFilter.filterAndRefreshData === 'function') {
                            window.quarterFilter.filterAndRefreshData();
                        } else {

                        }
                    } catch (e) {
                        // Quarter filter error on tab switch
                    }
                }, 200); // 200ms delay to ensure tab content is ready
            }
        });

        // Tab Navigation System
        class TabNavigationSystem {
            constructor() {
                this.tabs = document.querySelectorAll('.nav-tab');
                this.panels = document.querySelectorAll('.content-section');
                this.activeTabKey = 'starlinks-dashboard-active-tab';

                this.init();
            }

            init() {
                // Set up event listeners
                this.tabs.forEach((tab, index) => {
                    tab.addEventListener('click', (e) => this.handleTabClick(e));
                    tab.addEventListener('keydown', (e) => this.handleKeyNavigation(e, index));
                });

                // Restore active tab from sessionStorage
                this.restoreActiveTab();

                // Set up smooth scrolling behavior
                this.setupSmoothScrolling();
            }

            handleTabClick(event) {
                event.preventDefault();
                const clickedTab = event.target;
                const targetPanel = clickedTab.getAttribute('data-tab');

                this.switchToTab(targetPanel);
                this.saveActiveTab(targetPanel);
                this.smoothScrollToTop();
            }

            handleKeyNavigation(event, currentIndex) {
                let targetIndex = currentIndex;

                switch (event.key) {
                    case 'ArrowLeft':
                        event.preventDefault();
                        targetIndex = currentIndex > 0 ? currentIndex - 1 : this.tabs.length - 1;
                        break;
                    case 'ArrowRight':
                        event.preventDefault();
                        targetIndex = currentIndex < this.tabs.length - 1 ? currentIndex + 1 : 0;
                        break;
                    case 'Home':
                        event.preventDefault();
                        targetIndex = 0;
                        break;
                    case 'End':
                        event.preventDefault();
                        targetIndex = this.tabs.length - 1;
                        break;
                    case 'Enter':
                    case ' ':
                        event.preventDefault();
                        this.tabs[currentIndex].click();
                        return;
                    default:
                        return;
                }

                // Focus and activate the target tab
                this.tabs[targetIndex].focus();
                const targetPanel = this.tabs[targetIndex].getAttribute('data-tab');
                this.switchToTab(targetPanel);
                this.saveActiveTab(targetPanel);
            }

            switchToTab(targetPanelId) {
                // Update tab states
                this.tabs.forEach(tab => {
                    const isActive = tab.getAttribute('data-tab') === targetPanelId;
                    tab.classList.toggle('active', isActive);
                });

                // Update panel visibility
                this.panels.forEach(panel => {
                    const isActive = panel.id === targetPanelId + '-panel';
                    panel.classList.toggle('active', isActive);

                });

                // Re-apply current quarter filter when switching tabs


                // Add delay to ensure tab content is loaded before applying filter
                setTimeout(() => {
                    try {
                        if (window.quarterFilter && typeof window.quarterFilter.filterAndRefreshData === 'function') {
                            // Always re-apply the filter, regardless of the current quarter value
                            window.quarterFilter.filterAndRefreshData();
                        } else {

                        }
                    } catch (e) {
                        // Quarter filter error on tab switch
                    }
                }, 200); // 200ms delay to ensure tab content is ready
            }

            saveActiveTab(tabId) {
                try {
                    sessionStorage.setItem(this.activeTabKey, tabId);
                } catch (error) {
                    // Silently handle sessionStorage errors
                }
            }

            restoreActiveTab() {
                try {
                    const savedTab = sessionStorage.getItem(this.activeTabKey);
                    if (savedTab) {
                        // Check if the saved tab exists
                        const tabExists = Array.from(this.tabs).some(tab =>
                            tab.getAttribute('data-tab') === savedTab
                        );

                        if (tabExists) {
                            this.switchToTab(savedTab);
                            return;
                        }
                    }
                } catch (error) {
                    // Silently handle sessionStorage errors
                }

                // Fallback to first tab if no saved tab or error
                if (this.tabs.length > 0) {
                    const firstTabId = this.tabs[0].getAttribute('data-tab');
                    this.switchToTab(firstTabId);
                }
            }

            setupSmoothScrolling() {
                // Enable smooth scrolling for the entire document
                document.documentElement.style.scrollBehavior = 'smooth';
            }

            smoothScrollToTop() {
                // Smooth scroll to top when switching tabs
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }
        }

        // Demo function for loading overlay
        function simulateDataLoad() {
            const button = event.target;
            const section = button.closest('section');

            // Create loading overlay
            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.innerHTML = '<div class="loading-spinner"></div>';

            // Position overlay relative to section
            section.style.position = 'relative';
            section.appendChild(overlay);

            // Remove overlay after 3 seconds
            setTimeout(() => {
                if (overlay.parentNode) {
                    overlay.parentNode.removeChild(overlay);
                }
                section.style.position = '';
            }, 3000);
        }

        // Enhanced UI Error Handling and Empty States Manager
        class UIErrorHandler {
            constructor() {
                this.emptyStateTemplates = {
                    noData: {
                        title: 'No Data Available',
                        description: 'There is currently no survey data to display. Please check your data source or try refreshing the page.',
                        actionText: 'Refresh Data',
                        actionCallback: () => window.DashboardAPI.refresh()
                    },
                    noCompletedSurveys: {
                        title: 'No Completed Surveys',
                        description: 'No customers have completed their satisfaction surveys yet. Check back later or contact customers to complete their surveys.',
                        actionText: null,
                        actionCallback: null
                    },
                    noPendingSurveys: {
                        title: 'No Pending Surveys',
                        description: 'All customers have completed their surveys. Great job on the follow-up!',
                        actionText: null,
                        actionCallback: null
                    },
                    connectionError: {
                        title: 'Connection Error',
                        description: 'Unable to connect to the data source. Please check your internet connection and try again.',
                        actionText: 'Retry Connection',
                        actionCallback: () => window.DashboardAPI.refresh()
                    },
                    loadingError: {
                        title: 'Loading Error',
                        description: 'There was an error loading the data. This might be a temporary issue.',
                        actionText: 'Try Again',
                        actionCallback: () => window.location.reload()
                    }
                };
            }

            /**
             * Create and display empty state
             */
            createEmptyState(container, type, customOptions = {}) {
                if (!container) return null;

                const template = this.emptyStateTemplates[type] || this.emptyStateTemplates.noData;
                const options = { ...template, ...customOptions };

                const emptyStateElement = errorManager.createEmptyState(
                    options.title,
                    options.description,
                    options.actionText,
                    options.actionCallback
                );

                // Clear container and add empty state
                container.innerHTML = '';
                container.appendChild(emptyStateElement);

                return emptyStateElement;
            }

            /**
             * Create loading state for containers
             */
            createLoadingState(container, message = 'Loading...') {
                if (!container) return null;

                const loadingElement = errorManager.createLoadingState(message);
                container.innerHTML = '';
                container.appendChild(loadingElement);

                return loadingElement;
            }

            /**
             * Handle table empty states
             */
            handleTableEmptyState(tableBody, type, columnCount = 3) {
                if (!tableBody) return;

                const template = this.emptyStateTemplates[type] || this.emptyStateTemplates.noData;

                tableBody.innerHTML = `
                    <tr>
                        <td colspan="${columnCount}" style="text-align: center; padding: var(--spacing-2xl);">
                            <div class="empty-state" style="padding: var(--spacing-lg);">
                                <div class="empty-state-title">${template.title}</div>
                                <div class="empty-state-description">${template.description}</div>
                                ${template.actionText ? `
                                    <button class="empty-state-action" onclick="(${template.actionCallback.toString()})()">
                                        ${template.actionText}
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }

            /**
             * Handle partial data scenarios
             */
            handlePartialData(container, availableData, missingFields) {
                if (!container) return;

                // Show partial data warning
                const warning = errorManager.showPartialDataWarning(missingFields);

                // Insert warning at the top of the container
                const firstChild = container.firstChild;
                if (firstChild) {
                    container.insertBefore(warning, firstChild);
                } else {
                    container.appendChild(warning);
                }

                return warning;
            }

            /**
             * Show error state for specific components
             */
            showComponentError(container, error, retryCallback = null) {
                if (!container) return;

                const errorMessage = window.DashboardAPI.getErrorMessage(error);

                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon" style="color: var(--error-color);">
                            <svg viewBox="0 0 64 64" fill="currentColor">
                                <path d="M32 8C18.7 8 8 18.7 8 32s10.7 24 24 24 24-10.7 24-24S45.3 8 32 8zm0 44c-11 0-20-9-20-20s9-20 20-20 20 9 20 20-9 20-20 20z"/>
                                <path d="M32 16c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2s2-.9 2-2V18c0-1.1-.9-2-2-2z"/>
                                <circle cx="32" cy="42" r="2"/>
                            </svg>
                        </div>
                        <div class="empty-state-title" style="color: var(--error-color);">Error Loading Data</div>
                        <div class="empty-state-description">${errorMessage}</div>
                        ${retryCallback ? `
                            <button class="empty-state-action" onclick="(${retryCallback.toString()})()">
                                Try Again
                            </button>
                        ` : ''}
                    </div>
                `;
            }

            /**
             * Add loading overlay to existing content
             */
            addLoadingOverlay(container) {
                if (!container) return null;

                const overlay = document.createElement('div');
                overlay.className = 'loading-overlay';
                overlay.innerHTML = '<div class="loading-spinner"></div>';

                container.style.position = 'relative';
                container.appendChild(overlay);

                return overlay;
            }

            /**
             * Remove loading overlay
             */
            removeLoadingOverlay(container) {
                if (!container) return;

                const overlay = container.querySelector('.loading-overlay');
                if (overlay) {
                    overlay.remove();
                }

                // Reset position if no other overlays
                if (!container.querySelector('.loading-overlay')) {
                    container.style.position = '';
                }
            }

            /**
             * Handle network status changes
             */
            handleNetworkStatusChange(isOnline) {
                if (!isOnline) {
                    // Show offline message
                    errorManager.showError(
                        'You are currently offline. Some features may not work properly.',
                        'warning',
                        0
                    );
                } else {
                    // Clear offline messages and refresh data
                    errorManager.clearAllErrors();
                    errorManager.showError('Connection restored. Refreshing data...', 'success', 3000);

                    // Attempt to refresh data
                    window.DashboardAPI.refresh().catch(error => {
                        // Failed to refresh data after reconnection
                    });
                }
            }
        }

        // Initialize UI Error Handler
        const uiErrorHandler = new UIErrorHandler();

        // Initialize enhanced navigation system
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize the enhanced tab navigation system
            new TabNavigationSystem();

            // Set up accordion accessibility
            const accordionButtons = document.querySelectorAll('.accordion-header');
            accordionButtons.forEach(button => {
                button.setAttribute('aria-expanded', 'false');
                button.setAttribute('aria-controls', button.nextElementSibling.id || '');
            });

            // Set up network status monitoring
            window.addEventListener('online', () => uiErrorHandler.handleNetworkStatusChange(true));
            window.addEventListener('offline', () => uiErrorHandler.handleNetworkStatusChange(false));
        });

        // Note: Data loading is now handled by ApplicationInitializer
        // This section has been removed to prevent duplicate initialization

        // Q3 Pending Customers Data
        function generateQ3PendingCustomers() {
            const q3PendingCustomers = [
                { name: 'Squat Wolf', accountManager: 'Abdullah Ahmed', serviceType: 'Fulfillment + Last Mile' },
                { name: 'Al Rajhi First Store', accountManager: 'Ahmed Saleem', serviceType: 'Last Mile' },
                { name: 'Al Yasra/Ontime', accountManager: 'Abdullah Ahmed', serviceType: 'Last Mile' },
                { name: 'Aldo', accountManager: 'Ahmed Saleem', serviceType: 'Fulfillment + Last Mile' },
                { name: 'Amazon', accountManager: 'OPS', serviceType: 'Fulfillment + Last Mile' },
                { name: 'Biggbrands', accountManager: 'Ahmed Saleem', serviceType: 'Fulfillment + Last Mile' },
                { name: 'Brands for Less', accountManager: 'Ibrahim Fadaly', serviceType: 'Fulfillment + Last Mile' },
                { name: 'Bokhor Oud', accountManager: 'Abdullah Ahmed', serviceType: 'Fulfillment + Last Mile' },
                { name: 'Call it Spring', accountManager: 'Ahmed Saleem', serviceType: 'Fulfillment + Last Mile' },
                { name: 'Decathlon', accountManager: 'Ahmed Saleem', serviceType: 'Last Mile' },
                { name: 'DHL', accountManager: 'Ahmed Saleem', serviceType: 'Last Mile' },
                { name: 'Flormar', accountManager: 'Ahmed Saleem', serviceType: 'Fulfillment + Last Mile' },
                { name: 'Golden Rose', accountManager: 'Ahmed Saleem', serviceType: 'Fulfillment + Last Mile' },
                { name: 'Homzmart', accountManager: 'Ahmed Saleem', serviceType: 'Fulfillment + Last Mile' },
                { name: 'Hopa Design', accountManager: 'Ahmed Saleem', serviceType: 'Fulfillment + Last Mile' },
                { name: 'Kabrita', accountManager: 'Abdullah Ahmed', serviceType: 'Fulfillment + Last Mile' },
                { name: 'La Senza', accountManager: 'Ahmed Saleem', serviceType: 'Fulfillment + Last Mile' },
                { name: 'Laveienrose', accountManager: 'Ahmed Saleem', serviceType: 'Fulfillment + Last Mile' },
                { name: 'LG', accountManager: 'Ahmed Saleem', serviceType: 'Last Mile' },
                { name: 'Lipsy', accountManager: 'Ahmed Saleem', serviceType: 'Fulfillment + Last Mile' },
                { name: 'Noon RTV', accountManager: 'Ibrahim Fadaly', serviceType: 'Fulfillment' },
                { name: 'Rasees', accountManager: 'Abdullah Ahmed', serviceType: 'Last Mile' },
                { name: 'Red Cactus/Asteri', accountManager: 'Abdullah Ahmed', serviceType: 'Fulfillment + Last Mile' },
                { name: 'SACO', accountManager: 'Ahmed Saleem', serviceType: 'Last Mile' },
                { name: 'SL Global', accountManager: 'Ahmed Saleem', serviceType: 'Last Mile' },
                { name: 'TLC', accountManager: 'Ahmed Saleem', serviceType: 'Fulfillment + Last Mile' },
                { name: 'Torod', accountManager: 'Ibrahim Fadaly', serviceType: 'Last Mile' },
                { name: 'Al Dakhel Oud', accountManager: 'Abdullah Ahmed', serviceType: 'Last Mile' },
                { name: 'Al Esayi Electronics', accountManager: 'Abdullah Ahmed', serviceType: 'Last Mile' },
                { name: 'Her KSA', accountManager: 'Ibrahim Fadaly', serviceType: 'Fulfillment + Last Mile' },
                { name: 'Blue Arch', accountManager: 'Abdullah Ahmed', serviceType: 'Last Mile' },

                { name: 'Al Ghanem Electronics', accountManager: 'Ahmed Saleem', serviceType: 'Last Mile' },
                { name: 'Tahour Store', accountManager: 'Ibrahim Fadaly', serviceType: 'Fulfillment + Last Mile' },
                { name: 'Sandouq Albadaee', accountManager: 'Ibrahim Fadaly', serviceType: 'Last Mile' },


                { name: 'Reefi', accountManager: 'Abdullah Ahmed', serviceType: 'Last Mile' },
                { name: 'Eyen Optics', accountManager: 'Abdullah Ahmed', serviceType: 'Last Mile' },
                { name: 'Trendyol', accountManager: 'Ibrahim Fadaly', serviceType: 'Fulfillment + Last Mile' },

                { name: 'Makan', accountManager: 'Ahmed Saleem', serviceType: 'Fulfillment + Last Mile' },

                { name: 'Afaq Al Hasoob', accountManager: 'Abdullah Ahmed', serviceType: 'Last Mile' },
                { name: 'Oud Al Mazim', accountManager: 'Abdullah Ahmed', serviceType: 'Fulfillment + Last Mile' },
                { name: 'Fast Track', accountManager: 'Abdullah Ahmed', serviceType: 'Last Mile' },
                { name: 'Alsaad home', accountManager: 'Abdullah Ahmed', serviceType: 'Last Mile' },
                { name: 'Packman', accountManager: 'Ahmed Saleem', serviceType: 'Fulfillment + Last Mile' },
                { name: 'Wing Star', accountManager: 'Abdullah Ahmed', serviceType: 'Last Mile' }
            ];

            const languages = ['Arabic', 'English'];

            return q3PendingCustomers.map((customer, index) => ({
                id: 70 + index, // Start from 70 since we have existing surveys
                companyName: customer.name,
                serviceType: customer.serviceType === 'Fulfillment + Last Mile' ? 'Last Mile & Fulfillment' :
                    customer.serviceType === 'Last Mile' ? 'Last Mile Only' :
                        customer.serviceType === 'Fulfillment' ? 'Fulfillment Only' : 'Last Mile & Fulfillment',
                overallSatisfaction: null, // Pending - no rating yet
                npsScore: null,
                lastMileSatisfaction: null,
                reverseDeliverySatisfaction: null,
                fulfillmentSatisfaction: null,
                accountManager: customer.accountManager,
                communicationClarity: null,
                responsiveness: null,
                problemResolution: null,
                customizationAbility: null,
                systemsSatisfaction: null,
                itSupportSatisfaction: null,
                suggestions: '',
                submittedAt: null, // Pending - no submission date
                isCompleted: false,
                language: languages[Math.floor(Math.random() * languages.length)],
                quarter: 'Q3' // Add quarter identifier
            }));
        }

        // Function to determine quarter based on submission date
        function getQuarterFromDate(date) {
            if (!date) return 'Q3';

            // Ensure we have a Date object
            const d = (date instanceof Date) ? date : new Date(date);
            if (isNaN(d.getTime())) return 'Q1';

            const month = d.getMonth() + 1;

            // Business quarters mapping (Q1 includes April, Q2 = MayJuly, Q3 = AugOct)
            if (month >= 1 && month <= 4) return 'Q1';
            if (month >= 5 && month <= 7) return 'Q2';
            if (month >= 8 && month <= 10) return 'Q3';
            if (month >= 11 && month <= 12) return 'Q4';

            return 'Q1';
        }

        // Function to filter surveys by quarter
        function filterSurveysByQuarter(surveys, quarter) {
            if (quarter === 'All Quarters') {
                return surveys;
            }

            return surveys.filter(survey => {
                const surveyQuarter = getQuarterFromDate(survey.submittedAt);
                return surveyQuarter === quarter;
            });
        }

        // Generate mock data for testing and demonstration
        function generateMockSurveyData() {
            const companies = [
                ' ', '  ', ' ', ' ', ' ',
                'Acme Corp', 'TechStart Inc', 'Global Solutions', 'Innovation Labs', 'Future Systems',
                'Digital Dynamics', 'Smart Logistics', 'Prime Delivery', 'Express Solutions', 'Rapid Transit'
            ];

            const accountManagers = ['Abdullah Ahmed', 'Ibrahim Fadaly', 'Ahmed Saleem'];
            const serviceTypes = ['Last Mile Only', 'Fulfillment Only', 'Last Mile & Fulfillment'];
            const languages = ['Arabic', 'English'];

            const mockData = [];

            for (let i = 0; i < 25; i++) {
                // Make all surveys completed as requested
                const isCompleted = true; // All surveys are now completed
                const submittedAt = isCompleted ? new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000) : null;
                const language = languages[Math.floor(Math.random() * languages.length)];

                mockData.push({
                    id: i + 1,
                    companyName: companies[Math.floor(Math.random() * companies.length)],
                    serviceType: serviceTypes[Math.floor(Math.random() * serviceTypes.length)],
                    overallSatisfaction: isCompleted ? (Math.random() > 0.3 ? Math.floor(Math.random() * 2) + 4 : Math.floor(Math.random() * 3) + 1) : null, // 70% satisfied (4-5 rating)
                    npsScore: isCompleted ? Math.floor(Math.random() * 10) + 1 : null,
                    lastMileSatisfaction: isCompleted ? Math.floor(Math.random() * 5) + 1 : null,
                    reverseDeliverySatisfaction: isCompleted ? Math.floor(Math.random() * 5) + 1 : null,
                    fulfillmentSatisfaction: isCompleted ? Math.floor(Math.random() * 5) + 1 : null,
                    accountManager: accountManagers[Math.floor(Math.random() * accountManagers.length)],
                    communicationClarity: isCompleted ? Math.floor(Math.random() * 5) + 1 : null,
                    responsiveness: isCompleted ? Math.floor(Math.random() * 5) + 1 : null,
                    problemResolution: isCompleted ? Math.floor(Math.random() * 5) + 1 : null,
                    customizationAbility: isCompleted ? Math.floor(Math.random() * 5) + 1 : null,
                    systemsSatisfaction: isCompleted ? Math.floor(Math.random() * 5) + 1 : null,
                    itSupportSatisfaction: isCompleted ? Math.floor(Math.random() * 5) + 1 : null,
                    suggestions: isCompleted ? (language === 'Arabic' ? '  ' : 'Sample feedback text for testing purposes.') : '',
                    submittedAt: submittedAt,
                    isCompleted: isCompleted,
                    language: language
                });
            }

            return mockData;
        }

        // Listen for data refresh events
        document.addEventListener('dataRefreshed', function (event) {

            // Here you would update the UI components with new data
            // This will be implemented in future tasks
        });

        // Function to print Google Sheets data for debugging
        window.printGoogleSheetsData = async function () {
            try {
                const data = await window.DashboardAPI.getData(true); // Force refresh

                if (data.length > 0) {
                    // Analyze completion status
                    const completedSurveys = data.filter(survey => survey.submittedAt);
                    const pendingSurveys = data.filter(survey => !survey.submittedAt);



                    // Analyze satisfaction
                    const satisfiedCustomers = data.filter(survey =>
                        survey.submittedAt && survey.overallSatisfaction >= 4
                    );


                    // Print first few records
                } else {
                    // No data received from Google Sheets
                }
            } catch (error) {
                // Error fetching Google Sheets data
            }
        };

        // Test function to manually update the dashboard
        window.testUpdateDashboard = function () {
            const mockData = generateMockSurveyData();

            // Calculate metrics directly
            const totalSurveys = mockData.length;
            const completedSurveys = mockData.filter(survey => !!survey.submittedAt).length;
            const pendingSurveys = totalSurveys - completedSurveys;
            const completionPercentage = Math.round((completedSurveys / totalSurveys) * 100);
            const satisfiedCustomers = mockData.filter(survey => survey.submittedAt && survey.overallSatisfaction >= 4).length;
            const satisfactionPercentage = Math.round((satisfiedCustomers / completedSurveys) * 100);



            // Update UI directly
            const totalElement = document.getElementById('total-surveys-value');
            const completionElement = document.getElementById('completion-rate-value');
            const satisfactionElement = document.getElementById('satisfaction-rate-value');
            const completedElement = document.getElementById('completed-customers-count');
            const pendingElement = document.getElementById('pending-customers-count');

            if (totalElement) totalElement.textContent = totalSurveys;
            if (completionElement) completionElement.textContent = completionPercentage + '%';
            if (satisfactionElement) satisfactionElement.textContent = satisfactionPercentage + '%';
            if (completedElement) completedElement.textContent = completedSurveys;
            if (pendingElement) pendingElement.textContent = pendingSurveys;



            if (window.csatSummaryManager) {
                window.csatSummaryManager.updateSummaryMetrics(mockData);
            }
        };

        // ===================================================================
        // CSAT Summary Page Implementation
        // ===================================================================

        /**
         * CSAT Summary Page Manager
         * Handles data loading, metric calculations, and UI updates for the CSAT Summary page
         * Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7
         */
        class CSATSummaryManager {
            constructor() {
                this.isInitialized = false;
                this.currentData = null;
                this.animationDuration = 1500; // 1.5 seconds for counting animation

                // Bind methods
                this.handleDataRefresh = this.handleDataRefresh.bind(this);

                // Listen for data refresh events
                document.addEventListener('dataRefreshed', this.handleDataRefresh);
            }

            /**
             * Initialize the CSAT Summary page
             * Requirements: 3.7
             */
            async init() {
                if (this.isInitialized) return;

                try {
                    // Show loading state
                    this.showLoadingState();

                    // Wait for shared data to be available instead of loading independently
                    // Data will be provided by the main initialization

                    this.isInitialized = true;
                } catch (error) {
                    this.showErrorState();
                } finally {
                    this.hideLoadingState();
                }
            }

            /**
             * Handle data refresh events
             * Requirements: 2.4
             */
            async handleDataRefresh(event) {
                if (event.detail && event.detail.data) {
                    await this.updateSummaryMetrics(event.detail.data);
                }
            }

            /**
             * Show skeleton loading state
             * Requirements: 3.7
             */
            showLoadingState() {
                const loadingElement = document.getElementById('csat-loading');
                const metricsElement = document.getElementById('csat-metrics');
                const productLoadingElement = document.getElementById('product-breakdown-loading');
                const productElement = document.getElementById('product-breakdown');
                const questionLoadingElement = document.getElementById('question-breakdown-loading');
                const questionElement = document.getElementById('question-breakdown');

                // Disable skeleton placeholders during initial load
                if (loadingElement && metricsElement) {
                    loadingElement.style.display = 'none';
                    metricsElement.style.display = 'grid';
                }

                if (productLoadingElement && productElement) {
                    productLoadingElement.style.display = 'none';
                    productElement.style.display = 'grid';
                }

                if (questionLoadingElement && questionElement) {
                    questionLoadingElement.style.display = 'none';
                    questionElement.style.display = 'grid';
                }
            }

            /**
             * Hide skeleton loading state
             * Requirements: 3.7
             */
            hideLoadingState() {
                const loadingElement = document.getElementById('csat-loading');
                const metricsElement = document.getElementById('csat-metrics');
                const productLoadingElement = document.getElementById('product-breakdown-loading');
                const productElement = document.getElementById('product-breakdown');
                const questionLoadingElement = document.getElementById('question-breakdown-loading');
                const questionElement = document.getElementById('question-breakdown');

                if (loadingElement && metricsElement) {
                    loadingElement.style.display = 'none';
                    metricsElement.style.display = 'grid';
                }

                if (productLoadingElement && productElement) {
                    productLoadingElement.style.display = 'none';
                    productElement.style.display = 'grid';
                }

                if (questionLoadingElement && questionElement) {
                    questionLoadingElement.style.display = 'none';
                    questionElement.style.display = 'grid';
                }
            }

            /**
             * Show error state when data loading fails
             */
            showErrorState(error = null) {
                // Show error in metrics container
                const metricsContainer = document.getElementById('csat-metrics');
                const productContainer = document.getElementById('product-breakdown');

                if (metricsContainer) {
                    uiErrorHandler.showComponentError(metricsContainer, error, () => this.refresh());
                }

                if (productContainer) {
                    uiErrorHandler.showComponentError(productContainer, error, () => this.refresh());
                }
            }

            /**
             * Show empty state when no data is available
             */
            showEmptyState() {
                const metricsContainer = document.getElementById('csat-metrics');
                const productContainer = document.getElementById('product-breakdown');

                if (metricsContainer) {
                    uiErrorHandler.createEmptyState(metricsContainer, 'noData');
                }

                if (productContainer) {
                    uiErrorHandler.createEmptyState(productContainer, 'noData');
                }
            }

            /**
             * Update all summary metrics with new data
             * Requirements: 3.1, 3.2, 3.3
             */
            async updateSummaryMetrics(surveyData) {
                if (!surveyData || !Array.isArray(surveyData)) {
                    this.showEmptyState();
                    return;
                }

                if (surveyData.length === 0) {
                    // For quarter filters with no records, show cards with zeros
                    const zeroMetrics = {
                        totalSurveys: 0,
                        completionPercentage: 0,
                        satisfiedCustomersPercentage: 0
                    };

                    const zeroBreakdown = {
                        'Last Mile Only': { completed: 0, completionRate: 0, satisfactionRate: 0 },
                        'Fulfillment Only': { completed: 0, completionRate: 0, satisfactionRate: 0 },
                        'Last Mile & Fulfillment': { completed: 0, completionRate: 0, satisfactionRate: 0 }
                    };

                    await this.updateMainMetrics(zeroMetrics);
                    await this.updateProductTypeBreakdown(zeroBreakdown);
                    return;
                }

                this.currentData = surveyData;

                try {
                    // Validate data quality
                    const validation = window.DashboardAPI.validateDataQuality(surveyData);

                    // Skip partial data warnings for Q3 pending customers (they're supposed to be incomplete)
                    // if (validation.hasIssues && validation.warnings.length > 0) {
                    //     const metricsContainer = document.getElementById('csat-summary-panel');
                    //     if (metricsContainer) {
                    //         uiErrorHandler.handlePartialData(metricsContainer, surveyData, validation.warnings);
                    //     }
                    // }

                    // Calculate overall metrics using the data processor
                    const processor = new SurveyDataProcessor();
                    const overallMetrics = processor.calculateOverallMetrics(surveyData);
                    const productBreakdown = processor.calculateProductTypeBreakdown(surveyData);

                    // Debug: Log calculated metrics

                    // Update main metrics with animations
                    await this.updateMainMetrics(overallMetrics);

                    // Update product type breakdown
                    await this.updateProductTypeBreakdown(productBreakdown);



                } catch (error) {
                    this.showErrorState(error);
                }
            }

            /**
             * Update main metrics cards with counting animations
             * Requirements: 3.1, 3.2, 3.6
             */
            async updateMainMetrics(metrics) {

                // Animate NPS Score with color coding
                const npsElement = document.getElementById('nps-score-value');
                const npsScore = metrics.npsData ? metrics.npsData.npsScore : 0;
                const npsSign = npsScore > 0 ? '+' : '';

                this.animateValue('nps-score-value', 0, npsScore, '', npsSign);

                // Apply color coding for NPS (positive = green, neutral = orange, negative = red)
                if (npsElement) {
                    if (npsScore > 0) {
                        npsElement.className = 'metric-value large success';
                    } else if (npsScore === 0) {
                        npsElement.className = 'metric-value large warning';
                    } else {
                        npsElement.className = 'metric-value large error';
                    }
                }

                // Update NPS breakdown
                if (metrics.npsData) {
                    const promotersElement = document.getElementById('nps-promoters-value');
                    const passivesElement = document.getElementById('nps-passives-value');
                    const detractorsElement = document.getElementById('nps-detractors-value');

                    if (promotersElement) {
                        promotersElement.textContent = `${metrics.npsData.promoters.percentage}% (${metrics.npsData.promoters.count})`;
                    }

                    if (passivesElement) {
                        passivesElement.textContent = `${metrics.npsData.passives.percentage}% (${metrics.npsData.passives.count})`;
                    }

                    if (detractorsElement) {
                        detractorsElement.textContent = `${metrics.npsData.detractors.percentage}% (${metrics.npsData.detractors.count})`;
                    }
                }

                // Animate total responses
                this.animateValue('total-responses-value', 0, metrics.totalSurveys, '');

                // Update quarter responses
                const quarterResponsesElement = document.getElementById('quarter-responses-value');
                if (quarterResponsesElement) {
                    quarterResponsesElement.textContent = metrics.totalSurveys;
                }

                // Animate completion rate with color coding
                const completionElement = document.getElementById('completion-rate-value');

                this.animateValue('completion-rate-value', 0, metrics.completionPercentage, '%');
                this.updateProgressBar('completion-rate-progress', metrics.completionPercentage);

                // Update completed and pending customer counts
                this.animateValue('completed-customers-count', 0, metrics.completedSurveys, '');
                this.animateValue('pending-customers-count', 0, metrics.pendingSurveys, '');

                // Apply color coding for completion rate (Requirements: 3.4, 3.5)
                if (completionElement) {
                    if (metrics.completionPercentage >= 80) {
                        completionElement.className = 'metric-value success';
                    } else if (metrics.completionPercentage >= 60) {
                        completionElement.className = 'metric-value warning';
                    } else {
                        completionElement.className = 'metric-value';
                    }
                }

                // Animate satisfaction rate with color coding
                const satisfactionElement = document.getElementById('satisfaction-rate-value');
                this.animateValue('satisfaction-rate-value', 0, metrics.satisfiedCustomersPercentage, '%');
                this.updateProgressBar('satisfaction-rate-progress', metrics.satisfiedCustomersPercentage);

                // Apply color coding for satisfaction rate (Requirements: 3.4, 3.5)
                if (satisfactionElement) {
                    if (metrics.satisfiedCustomersPercentage >= 80) {
                        satisfactionElement.className = 'metric-value success';
                    } else if (metrics.satisfiedCustomersPercentage >= 60) {
                        satisfactionElement.className = 'metric-value warning';
                    } else {
                        satisfactionElement.className = 'metric-value';
                    }
                }
            }



            /**
             * Update product type breakdown cards
             * Requirements: 3.3
             */
            async updateProductTypeBreakdown(breakdown) {
                // Last Mile Only - only satisfaction rate
                this.updateText('lastmile-satisfaction-rate', breakdown['Last Mile Only'].satisfactionRate + '%');
                this.updateProgressBar('lastmile-satisfaction-progress', breakdown['Last Mile Only'].satisfactionRate);
                this.applySatisfactionColorCoding('lastmile-satisfaction-rate', 'lastmile-satisfaction-progress', breakdown['Last Mile Only'].satisfactionRate);

                // Fulfillment Only - only satisfaction rate
                this.updateText('fulfillment-satisfaction-rate', breakdown['Fulfillment Only'].satisfactionRate + '%');
                this.updateProgressBar('fulfillment-satisfaction-progress', breakdown['Fulfillment Only'].satisfactionRate);
                this.applySatisfactionColorCoding('fulfillment-satisfaction-rate', 'fulfillment-satisfaction-progress', breakdown['Fulfillment Only'].satisfactionRate);

                // Last Mile & Fulfillment - only satisfaction rate
                this.updateText('combined-satisfaction-rate', breakdown['Last Mile & Fulfillment'].satisfactionRate + '%');
                this.updateProgressBar('combined-satisfaction-progress', breakdown['Last Mile & Fulfillment'].satisfactionRate);
                this.applySatisfactionColorCoding('combined-satisfaction-rate', 'combined-satisfaction-progress', breakdown['Last Mile & Fulfillment'].satisfactionRate);
            }

            /**
             * Apply color coding to satisfaction rate text and progress bar
             * 0-59%: Red, 60-79%: Orange, 80-100%: Green
             */
            applySatisfactionColorCoding(textElementId, progressElementId, percentage) {
                const textElement = document.getElementById(textElementId);
                const progressElement = document.getElementById(progressElementId);

                if (textElement && progressElement) {
                    // Remove existing color classes
                    textElement.classList.remove('satisfaction-red', 'satisfaction-orange', 'satisfaction-green');
                    progressElement.classList.remove('satisfaction-red', 'satisfaction-orange', 'satisfaction-green');

                    // Apply color based on satisfaction rate
                    if (percentage >= 80) {
                        textElement.classList.add('satisfaction-green');
                        progressElement.classList.add('satisfaction-green');
                    } else if (percentage >= 60) {
                        textElement.classList.add('satisfaction-orange');
                        progressElement.classList.add('satisfaction-orange');
                    } else {
                        textElement.classList.add('satisfaction-red');
                        progressElement.classList.add('satisfaction-red');
                    }
                }
            }

            /**
             * Apply color coding to progress bars based on performance levels
             * Requirements: 3.4, 3.5
             */
            applyProgressBarColorCoding() {
                const progressBars = [
                    'lastmile-completion-progress', 'lastmile-satisfaction-progress',
                    'fulfillment-completion-progress', 'fulfillment-satisfaction-progress',
                    'combined-completion-progress', 'combined-satisfaction-progress'
                ];

                progressBars.forEach(barId => {
                    const bar = document.getElementById(barId);
                    if (bar) {
                        const width = parseInt(bar.style.width);

                        // Remove existing color classes
                        bar.classList.remove('success', 'warning', 'error');

                        // Apply color based on performance
                        if (width >= 80) {
                            bar.classList.add('success');
                        } else if (width >= 60) {
                            bar.classList.add('warning');
                        } else if (width > 0) {
                            // Keep default primary color for low but non-zero values
                        }
                    }
                });
            }

            /**
             * Animate counting from start to end value with performance optimizations
             * Requirements: 3.6
             */
            animateValue(elementId, start, end, suffix = '', prefix = '') {
                const element = document.getElementById(elementId);
                if (!element) {
                    return;
                }

                // Check for reduced motion preference
                if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                    element.textContent = prefix + Math.round(end) + suffix;
                    return;
                }

                // Add animation class
                element.classList.add('animate');

                // Use requestAnimationFrame for better performance
                const startTime = performance.now();
                const duration = this.animationDuration;

                const animate = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);

                    // Easing function for smooth animation
                    const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                    const current = start + (end - start) * easeOutQuart;

                    element.textContent = prefix + Math.round(current) + suffix;

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        element.classList.remove('animate');

                        // Announce completion to screen readers
                        if (window.accessibilityManager) {
                            const label = element.closest('.metric-card')?.querySelector('.metric-card-title')?.textContent;
                            if (label) {
                                window.accessibilityManager.announce(`${label}: ${Math.round(end)}${suffix}`);
                            }
                        }
                    }
                };

                requestAnimationFrame(animate);
            }

            /**
             * Update progress bar width with animation and performance optimizations
             */
            updateProgressBar(elementId, percentage) {
                const element = document.getElementById(elementId);
                if (!element) return;

                // Check for reduced motion preference
                if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                    element.style.width = percentage + '%';
                    return;
                }

                // Use requestAnimationFrame for smooth animation
                requestAnimationFrame(() => {
                    element.style.width = percentage + '%';

                    // Add ARIA attributes for screen readers
                    element.setAttribute('aria-valuenow', percentage);
                    element.setAttribute('aria-valuemin', '0');
                    element.setAttribute('aria-valuemax', '100');
                    element.setAttribute('role', 'progressbar');
                    element.setAttribute('aria-label', `Progress: ${percentage}%`);
                });
            }

            /**
             * Update text content without animation
             */
            updateText(elementId, text) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = text;
                }
            }

            /**
             * Reset product breakdown to zero values
             */
            resetProductBreakdown() {
                const serviceTypes = ['lastmile', 'fulfillment', 'combined'];

                serviceTypes.forEach(type => {
                    this.updateText(`${type}-satisfaction-rate`, '0%');
                    this.updateProgressBar(`${type}-satisfaction-progress`, 0);
                    // Reset color coding
                    this.applySatisfactionColorCoding(`${type}-satisfaction-rate`, `${type}-satisfaction-progress`, 0);
                });
            }

            /**
             * Refresh data manually
             */
            async refresh() {
                try {
                    this.showLoadingState();
                    const data = await window.DashboardAPI.getData(true);
                    await this.updateSummaryMetrics(data);
                } catch (error) {
                    this.showErrorState();
                } finally {
                    this.hideLoadingState();
                }
            }
        }

        // Initialize CSAT Summary Manager
        let csatSummaryManager;

        // Initialize CSAT Summary when DOM is ready
        document.addEventListener('DOMContentLoaded', function () {
            csatSummaryManager = new CSATSummaryManager();
            window.csatSummaryManager = csatSummaryManager; // Ensure it's available globally

            // Initialize the manager
            csatSummaryManager.init();

            // Initialize immediately if CSAT Summary tab is active
            const csatPanel = document.getElementById('csat-summary-panel');
            if (csatPanel && csatPanel.classList.contains('active')) {
                csatSummaryManager.init();
            }
        });

        // Initialize CSAT Summary when tab becomes active
        document.addEventListener('click', function (event) {
            if (event.target.matches('[data-tab="csat-summary"]')) {
                if (csatSummaryManager && !csatSummaryManager.isInitialized) {
                    csatSummaryManager.init();
                }
            }
        });

        // Expose CSAT Summary manager for debugging
        window.CSATSummaryManager = CSATSummaryManager;
        // window.csatSummaryManager will be set in DOMContentLoaded

        // ===================================================================
        // Customer Status Page Implementation
        // ===================================================================

        /**
         * Customer Status Page Manager
         * Handles data loading and UI updates for the Customer Status page
         * Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7
         */
        class CustomerStatusManager {
            constructor() {
                this.isInitialized = false;
                this.currentData = null;

                // Bind methods
                this.handleDataRefresh = this.handleDataRefresh.bind(this);
                this.handleCustomerClick = this.handleCustomerClick.bind(this);

                // Listen for data refresh events
                document.addEventListener('dataRefreshed', this.handleDataRefresh);
            }

            /**
             * Initialize the Customer Status page
             * Requirements: 4.1, 4.2
             */
            async init() {
                if (this.isInitialized) return;

                try {
                    // Show loading state
                    this.showLoadingState();

                    // Wait for shared data to be available instead of loading independently
                    // Data will be provided by the main initialization

                    // Set up event listeners
                    this.setupEventListeners();

                    this.isInitialized = true;
                } catch (error) {
                    this.showErrorState();
                } finally {
                    this.hideLoadingState();
                }
            }

            /**
             * Handle data refresh events
             * Requirements: 2.4
             */
            async handleDataRefresh(event) {
                if (event.detail && event.detail.data) {
                    await this.updateCustomerStatus(event.detail.data);
                }
            }

            /**
             * Show loading state for tables
             */
            showLoadingState() {
                const completedTableBody = document.querySelector('#completed-surveys-table tbody');
                const pendingTableBody = document.querySelector('#pending-surveys-table tbody');
                const accordionContainer = document.querySelector('#completed-surveys-accordion');

                if (completedTableBody) {
                    completedTableBody.innerHTML = this.generateSkeletonRows(3);
                }

                if (pendingTableBody) {
                    pendingTableBody.innerHTML = this.generateSkeletonRows(3);
                }

                if (accordionContainer) {
                    accordionContainer.innerHTML = this.generateSkeletonAccordion(3);
                }
            }

            /**
             * Hide loading state
             */
            hideLoadingState() {
                // Loading state is hidden when real data is populated
            }

            /**
             * Show error state when data loading fails
             */
            showErrorState(error = null) {
                const completedTableBody = document.querySelector('#completed-surveys-table tbody');
                const pendingTableBody = document.querySelector('#pending-surveys-table tbody');
                const accordionContainer = document.querySelector('#completed-surveys-accordion');

                if (completedTableBody) {
                    uiErrorHandler.handleTableEmptyState(completedTableBody, 'loadingError', 4);
                }

                if (pendingTableBody) {
                    uiErrorHandler.handleTableEmptyState(pendingTableBody, 'loadingError', 3);
                }

                if (accordionContainer) {
                    uiErrorHandler.showComponentError(accordionContainer, error, () => this.refresh());
                }
            }

            /**
             * Show empty states for different scenarios
             */
            showEmptyStates(completedSurveys, pendingSurveys) {
                const completedTableBody = document.querySelector('#completed-surveys-table tbody');
                const pendingTableBody = document.querySelector('#pending-surveys-table tbody');
                const accordionContainer = document.querySelector('#completed-surveys-accordion');

                if (completedSurveys.length === 0 && completedTableBody) {
                    uiErrorHandler.handleTableEmptyState(completedTableBody, 'noCompletedSurveys', 4);
                }

                if (pendingSurveys.length === 0 && pendingTableBody) {
                    uiErrorHandler.handleTableEmptyState(pendingTableBody, 'noPendingSurveys', 3);
                }

                if (completedSurveys.length === 0 && accordionContainer) {
                    uiErrorHandler.createEmptyState(accordionContainer, 'noCompletedSurveys');
                }
            }

            /**
             * Generate skeleton loading rows
             */
            generateSkeletonRows(count) {
                let rows = '';
                for (let i = 0; i < count; i++) {
                    rows += `
                        <tr>
                            <td><div class="skeleton skeleton-text"></div></td>
                            <td><div class="skeleton skeleton-text"></div></td>
                            <td><div class="skeleton skeleton-text"></div></td>
                            <td><div class="skeleton skeleton-text"></div></td>
                        </tr>
                    `;
                }
                return rows;
            }

            /**
             * Generate skeleton loading accordion cards
             * Requirements: 5.1, 5.6
             */
            generateSkeletonAccordion(count) {
                let cards = '';
                for (let i = 0; i < count; i++) {
                    cards += `
                        <div class="accordion-card">
                            <div class="accordion-header" style="cursor: default;">
                                <div class="accordion-header-content">
                                    <div class="skeleton skeleton-text title"></div>
                                    <div class="accordion-meta">
                                        <div class="skeleton skeleton-text small" style="width: 120px;"></div>
                                        <div class="skeleton skeleton-text small" style="width: 80px;"></div>
                                    </div>
                                </div>
                                <div class="skeleton" style="width: 20px; height: 20px;"></div>
                            </div>
                        </div>
                    `;
                }
                return cards;
            }

            /**
             * Update customer status tables with new data
             * Requirements: 4.1, 4.2, 4.3
             */
            async updateCustomerStatus(surveyData) {
                if (!surveyData || !Array.isArray(surveyData)) {
                    this.showErrorState();
                    return;
                }

                if (surveyData.length === 0) {
                    this.showEmptyStates([], []);
                    return;
                }

                this.currentData = surveyData;

                try {
                    // Validate data quality
                    const validation = window.DashboardAPI.validateDataQuality(surveyData);

                    // Skip partial data warnings for Q3 pending customers (they're supposed to be incomplete)
                    // if (validation.hasIssues && validation.warnings.length > 0) {
                    //     const statusContainer = document.getElementById('customer-status-panel');
                    //     if (statusContainer) {
                    //         uiErrorHandler.handlePartialData(statusContainer, surveyData, validation.warnings);
                    //     }
                    // }

                    // Separate completed and pending surveys
                    const completedSurveys = surveyData.filter(survey => survey.submittedAt); // Only completed surveys

                    // Create processor instance to get pending surveys
                    const processor = new SurveyDataProcessor();
                    const pendingSurveys = processor.getPendingSurveys(surveyData);


                    // Sort completed surveys by completion date (most recent first)
                    // Requirements: 4.6
                    completedSurveys.sort((a, b) => {
                        const dateA = new Date(a.submittedAt);
                        const dateB = new Date(b.submittedAt);
                        return dateB - dateA; // Descending order (most recent first)
                    });

                    // Sort pending surveys alphabetically by customer name
                    // Requirements: 4.7
                    pendingSurveys.sort((a, b) => {
                        return a.companyName.localeCompare(b.companyName);
                    });

                    // Check for empty states
                    if (completedSurveys.length === 0 && pendingSurveys.length === 0) {
                        this.showEmptyStates([], []);
                        return;
                    }

                    // Update tables
                    this.updateCompletedSurveysTable(completedSurveys);
                    this.updatePendingSurveysTable(pendingSurveys);

                    // Update completed surveys accordion
                    this.updateCompletedSurveysAccordion(completedSurveys);

                    // Show empty states for individual sections if needed
                    this.showEmptyStates(completedSurveys, pendingSurveys);

                } catch (error) {
                    this.showErrorState(error);
                }
            }

            /**
             * Refresh data manually
             */
            async refresh() {
                try {
                    this.showLoadingState();
                    const data = await window.DashboardAPI.getData(true);
                    await this.updateCustomerStatus(data);
                } catch (error) {
                    this.showErrorState(error);
                } finally {
                    this.hideLoadingState();
                }
            }

            /**
             * Update completed surveys table
             * Requirements: 4.2, 4.4, 4.5, 4.6
             */
            updateCompletedSurveysTable(completedSurveys) {
                const tableBody = document.querySelector('#completed-surveys-table tbody');
                if (!tableBody) return;

                if (completedSurveys.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: var(--spacing-xl); color: var(--text-secondary);">No completed surveys found</td></tr>';
                    return;
                }

                const rows = completedSurveys.map((survey, index) => {
                    // Fallback: if submittedAt missing, try to parse token/raw value
                    const rawDate = survey.submittedAt || null;
                    const completionDate = this.formatDate(rawDate);
                    const isoAttr = (() => {
                        if (!rawDate) return '';
                        try {
                            const d = new Date(rawDate);
                            return isNaN(d.getTime()) ? '' : d.toISOString();
                        } catch (e) {
                            return '';
                        }
                    })();

                    if (!rawDate || completionDate === 'Not Available') {
                        // Missing or invalid date
                    }

                    return `
                        <tr role="row">
                            <td role="gridcell">
                                <a href="#" 
                                   class="table-cell-link" 
                                   data-customer-id="${survey.id}" 
                                   data-customer-name="${this.escapeHtml(survey.companyName)}"
                                   aria-describedby="completed-survey-${survey.id}-description">
                                    ${this.escapeHtml(survey.companyName)}
                                </a>
                                <span id="completed-survey-${survey.id}-description" class="sr-only">
                                    Click to view detailed survey responses for ${this.escapeHtml(survey.companyName)}
                                </span>
                            </td>
                            <td role="gridcell">
                                <span class="account-manager-badge ${this.getAccountManagerBadgeClass(survey.accountManager)}">
                                    ${this.escapeHtml(survey.accountManager || 'Not Assigned')}
                                </span>
                            </td>
                            <td role="gridcell">
                                <span class="completion-date-badge">
                                    <time datetime="${isoAttr}">${completionDate}</time>
                                </span>
                            </td>
                            <td role="gridcell">
                                <span class="table-status-badge completed" aria-label="Survey status: Completed">Completed</span>
                            </td>
                        </tr>
                    `;
                }).join('');

                tableBody.innerHTML = rows;
            }

            /**
             * Get account manager badge CSS class based on name
             */
            getAccountManagerBadgeClass(accountManager) {
                if (!accountManager || accountManager === 'Not Assigned') {
                    return 'account-manager-default';
                }

                const name = accountManager.toLowerCase().trim();

                if (name.includes('abdullah')) {
                    return 'account-manager-abdullah'; // Blue
                } else if (name.includes('ahmed') && name.includes('salem')) {
                    return 'account-manager-ahmed'; // Yellow/Orange
                } else if (name.includes('ibrahim')) {
                    return 'account-manager-ibrahim'; // Purple
                } else if (name.includes('ops')) {
                    return 'account-manager-ops'; // Brown
                } else {
                    return 'account-manager-default'; // Gray for unknown
                }
            }

            /**
             * Update pending surveys table
             * Requirements: 4.3, 4.4, 4.7
             */
            updatePendingSurveysTable(pendingSurveys) {
                const tableBody = document.querySelector('#pending-surveys-table tbody');
                if (!tableBody) return;

                if (pendingSurveys.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: var(--spacing-xl); color: var(--text-secondary);">No pending surveys found</td></tr>';
                    return;
                }

                const rows = pendingSurveys.map((survey, index) => {
                    return `
                        <tr role="row">
                            <td role="gridcell">
                                <a href="#" 
                                   class="table-cell-link" 
                                   data-customer-id="${survey.id}" 
                                   data-customer-name="${this.escapeHtml(survey.companyName)}"
                                   aria-describedby="pending-survey-${survey.id}-description">
                                    ${this.escapeHtml(survey.companyName)}
                                </a>
                                <span id="pending-survey-${survey.id}-description" class="sr-only">
                                    Customer with pending survey. Click to view details.
                                </span>
                            </td>
                            <td role="gridcell">
                                <span class="account-manager-badge ${this.getAccountManagerBadgeClass(survey.accountManager)}">
                                    ${this.escapeHtml(survey.accountManager || 'Not Assigned')}
                                </span>
                            </td>
                            <td role="gridcell">
                                <span class="table-status-badge pending" aria-label="Survey status: Pending">Pending</span>
                            </td>
                        </tr>
                    `;
                }).join('');

                tableBody.innerHTML = rows;
            }

            /**
             * Update completed surveys accordion interface
             * Requirements: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6
             */
            updateCompletedSurveysAccordion(completedSurveys) {
                const accordionContainer = document.querySelector('#completed-surveys-accordion');
                if (!accordionContainer) return;

                if (completedSurveys.length === 0) {
                    accordionContainer.innerHTML = '<div style="text-align: center; padding: var(--spacing-xl); color: var(--text-secondary);">No completed surveys found</div>';
                    return;
                }

                // Generate accordion cards for each completed survey
                const accordionCards = completedSurveys.map(survey => {
                    const completionDate = this.formatDate(survey.submittedAt);
                    const ratingClass = this.getSatisfactionRatingClass(survey.overallSatisfaction);
                    const ratingText = this.getSatisfactionRatingText(survey.overallSatisfaction);

                    // Create all survey questions and answers
                    const surveyQuestions = this.generateSurveyQuestions(survey);

                    return `
                        <div class="accordion-card" data-customer-id="${survey.id}">
                            <button class="accordion-header" 
                                    onclick="toggleAccordion(this)"
                                    aria-expanded="false"
                                    aria-controls="accordion-content-${survey.id}"
                                    id="accordion-header-${survey.id}">
                                <div class="accordion-header-content">
                                    <h3 class="accordion-title">${this.escapeHtml(survey.companyName)}</h3>
                                    <div class="accordion-meta">
                                        <span class="accordion-subtitle">Completed: ${completionDate}</span>
                                        <span class="accordion-rating ${ratingClass}" 
                                              aria-label="Overall satisfaction rating: ${survey.overallSatisfaction} out of 5 stars, ${ratingText}">
                                            ${survey.overallSatisfaction}  ${ratingText}
                                        </span>
                                    </div>
                                </div>
                                <svg class="accordion-icon" 
                                     fill="none" 
                                     stroke="currentColor" 
                                     viewBox="0 0 24 24"
                                     aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div class="accordion-content" 
                                 id="accordion-content-${survey.id}"
                                 aria-labelledby="accordion-header-${survey.id}"
                                 role="region">
                                <div class="accordion-body">
                                    ${surveyQuestions}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                accordionContainer.innerHTML = accordionCards;

                // Set up highlighting for navigated customers
                this.setupAccordionHighlighting();
            }

            /**
             * Generate survey questions and answers HTML
             * Requirements: 5.3, 5.5
             */
            generateSurveyQuestions(survey) {
                const questions = [
                    { label: 'Overall Satisfaction', value: this.formatRatingAnswer(survey.overallSatisfaction) },
                    { label: 'Service Type', value: survey.serviceType || 'Not specified' },
                    { label: 'NPS Score', value: survey.npsScore ? `${survey.npsScore}/10` : 'Not provided' },
                    { label: 'Last Mile Satisfaction', value: this.formatRatingAnswer(survey.lastMileSatisfaction) },
                    { label: 'Reverse Delivery Satisfaction', value: this.formatRatingAnswer(survey.reverseDeliverySatisfaction) },
                    { label: 'Fulfillment Satisfaction', value: this.formatRatingAnswer(survey.fulfillmentSatisfaction) },
                    { label: 'Account Manager', value: survey.accountManager || 'Not assigned' },
                    { label: 'Communication Clarity', value: this.formatRatingAnswer(survey.communicationClarity) },
                    { label: 'Responsiveness', value: this.formatRatingAnswer(survey.responsiveness) },
                    { label: 'Problem Resolution', value: this.formatRatingAnswer(survey.problemResolution) },
                    { label: 'Customization Ability', value: this.formatRatingAnswer(survey.customizationAbility) },
                    { label: 'Systems Satisfaction', value: this.formatRatingAnswer(survey.systemsSatisfaction) },
                    { label: 'IT Support Satisfaction', value: this.formatRatingAnswer(survey.itSupportSatisfaction) },
                    { label: 'Additional Comments', value: survey.suggestions || 'No additional comments provided' },
                    { label: 'LaunchPad Non-Usage Explanation', value: survey.launchpadExplanation || 'Empty' },
                    { label: 'General Improvement Suggestions', value: survey.generalImprovement || 'Empty' }
                ];

                return questions.map(question => `
                    <div class="survey-question">
                        <div class="survey-question-label">${question.label}</div>
                        <div class="survey-question-answer">${this.escapeHtml(question.value)}</div>
                    </div>
                `).join('');
            }

            /**
             * Get satisfaction rating CSS class based on score
             * Requirements: 5.4
             */
            getSatisfactionRatingClass(rating) {
                if (rating >= 4) return 'excellent';
                if (rating >= 3) return 'good';
                if (rating >= 2) return 'average';
                return 'poor';
            }

            /**
             * Get satisfaction rating text based on score
             * Requirements: 5.4
             */
            getSatisfactionRatingText(rating) {
                if (rating >= 5) return 'Very Satisfied';
                if (rating >= 4) return 'Satisfied';
                if (rating >= 3) return 'Neutral';
                if (rating >= 2) return 'Dissatisfied';
                return 'Very Dissatisfied';
            }

            /**
             * Format rating answer with descriptive text
             * Requirements: 5.3
             */
            formatRatingAnswer(rating) {
                if (!rating || rating === 0) return 'Not provided';

                const ratingTexts = {
                    1: '1 - Very Dissatisfied',
                    2: '2 - Dissatisfied',
                    3: '3 - Neutral',
                    4: '4 - Satisfied',
                    5: '5 - Very Satisfied'
                };

                return ratingTexts[rating] || `${rating}`;
            }

            /**
             * Set up accordion highlighting for customer navigation
             * Requirements: 5.1, 5.2
             */
            setupAccordionHighlighting() {
                // Listen for customer highlight events
                document.addEventListener('highlightCustomerSurvey', (event) => {
                    const { customerId, customerName } = event.detail;
                    this.highlightCustomerAccordion(customerId, customerName);
                });

                // Check if there's a stored highlight request
                const highlightCustomerId = sessionStorage.getItem('highlightCustomerId');
                const highlightCustomerName = sessionStorage.getItem('highlightCustomerName');

                if (highlightCustomerId && highlightCustomerName) {
                    setTimeout(() => {
                        this.highlightCustomerAccordion(highlightCustomerId, highlightCustomerName);
                        // Clear the stored highlight request
                        sessionStorage.removeItem('highlightCustomerId');
                        sessionStorage.removeItem('highlightCustomerName');
                    }, 100);
                }
            }

            /**
             * Highlight and expand specific customer accordion
             * Requirements: 5.1, 5.2
             */
            highlightCustomerAccordion(customerId, customerName) {
                const accordionCard = document.querySelector(`#completed-surveys-accordion .accordion-card[data-customer-id="${customerId}"]`);

                if (accordionCard) {
                    // Expand the accordion
                    const header = accordionCard.querySelector('.accordion-header');
                    if (header && !accordionCard.classList.contains('expanded')) {
                        toggleAccordion(header);
                    }

                    // Scroll to the accordion card
                    accordionCard.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });

                    // Add temporary highlight effect
                    accordionCard.style.boxShadow = '0 0 0 3px var(--primary-main)';
                    accordionCard.style.transition = 'box-shadow 0.3s ease';

                    setTimeout(() => {
                        accordionCard.style.boxShadow = '';
                    }, 2000);
                }
            }

            /**
             * Set up event listeners for customer name clicks
             * Requirements: 4.5
             */
            setupEventListeners() {
                // Use event delegation to handle clicks on customer names
                document.addEventListener('click', this.handleCustomerClick);
            }

            /**
             * Handle customer name clicks to navigate to detailed survey view
             * Requirements: 4.5
             */
            handleCustomerClick(event) {
                const link = event.target.closest('.table-cell-link');
                if (!link) return;

                event.preventDefault();

                const customerId = link.getAttribute('data-customer-id');
                const customerName = link.getAttribute('data-customer-name');

                if (customerId && customerName) {
                    this.navigateToSurveyDetail(customerId, customerName);
                }
            }

            /**
             * Navigate to detailed survey view (Completed Surveys page)
             * Requirements: 4.5
             */
            navigateToSurveyDetail(customerId, customerName) {
                // Switch to the Completed Surveys tab
                const completedSurveysTab = document.querySelector('[data-tab="completed-surveys"]');
                if (completedSurveysTab) {
                    completedSurveysTab.click();

                    // Store the customer ID to highlight the specific survey
                    sessionStorage.setItem('highlightCustomerId', customerId);
                    sessionStorage.setItem('highlightCustomerName', customerName);

                    // Dispatch custom event for the Completed Surveys page to handle highlighting
                    setTimeout(() => {
                        const highlightEvent = new CustomEvent('highlightCustomerSurvey', {
                            detail: { customerId, customerName }
                        });
                        document.dispatchEvent(highlightEvent);
                    }, 300); // Small delay to ensure tab switch completes
                }
            }

            /**
             * Format date for display
             */
            formatDate(dateValue) {
                if (dateValue === null || dateValue === undefined || dateValue === '') return 'Not Available';

                const tryParse = (value) => {
                    // 1) Already a Date
                    if (value instanceof Date && !isNaN(value.getTime())) return value;

                    // 2) Normalize Arabic-Indic digits
                    const normalizeDigits = (str) => String(str)
                        .replace(/[\u0660-\u0669]/g, (d) => String(d.charCodeAt(0) - 0x0660))
                        .replace(/[\u06F0-\u06F9]/g, (d) => String(d.charCodeAt(0) - 0x06F0));
                    const text = normalizeDigits(String(value)).trim();

                    // 3) Native parse first
                    const native = new Date(text);
                    if (!isNaN(native.getTime())) return native;

                    // 4) Try DD/MM/YYYY or MM/DD/YYYY with optional time
                    const m = text.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
                    if (m) {
                        const a = parseInt(m[1], 10);
                        const b = parseInt(m[2], 10);
                        const y = parseInt(m[3], 10);
                        const hh = parseInt(m[4] || '0', 10);
                        const mm = parseInt(m[5] || '0', 10);
                        const ss = parseInt(m[6] || '0', 10);
                        const isDMY = a > 12; // heuristic
                        const day = isDMY ? a : b;
                        const monthIndex = (isDMY ? b : a) - 1;
                        return new Date(y, monthIndex, day, hh, mm, ss);
                    }

                    return null;
                };

                try {
                    const date = tryParse(dateValue);
                    if (!date || isNaN(date.getTime())) {
                        return 'Not Available';
                    }

                    // Format: July 10, 2025
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                } catch (error) {
                    return 'Not Available';
                }
            }

            /**
             * Escape HTML to prevent XSS
             */
            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            /**
             * Refresh data manually
             */
            async refresh() {
                try {
                    this.showLoadingState();
                    const data = await window.DashboardAPI.getData(true);
                    await this.updateCustomerStatus(data);
                } catch (error) {
                    this.showErrorState();
                } finally {
                    this.hideLoadingState();
                }
            }

            /**
             * Clean up event listeners
             */
            destroy() {
                document.removeEventListener('dataRefreshed', this.handleDataRefresh);
                document.removeEventListener('click', this.handleCustomerClick);
            }
        }

        /**
         * Account Manager Performance Page Manager
         * Handles dynamic display of account manager metrics and performance data
         * Requirements: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6
         */
        class AccountManagerPerformanceManager {
            constructor() {
                this.isInitialized = false;
                this.loadingContainer = document.getElementById('account-manager-loading');
                this.tableContainer = document.getElementById('account-manager-table');
                this.knownManagers = ['Abdullah Ahmed', 'Ibrahim Fadaly', 'Ahmed Saleem'];
                this.excludedManagers = ['Joanna', 'Amjad Aljowair', 'Starlinks Team']; // Exclude invalid managers from Q3 data
            }

            /**
             * Initialize the Account Manager Performance page
             * Requirements: 6.1
             */
            async init() {
                if (this.isInitialized) return;

                try {
                    this.showLoading();
                    const processedData = await window.DashboardAPI.DataProcessor.processData();
                    this.renderAccountManagerCards(processedData.accountManagerMetrics);
                    this.hideLoading();
                    this.isInitialized = true;
                } catch (error) {
                    this.showError('Failed to load account manager data. Please try refreshing the page.');
                    this.hideLoading();
                }
            }

            /**
             * Show loading state
             */
            showLoading() {
                if (this.loadingContainer) {
                    this.loadingContainer.style.display = 'grid';
                }
                if (this.tableContainer) {
                    this.tableContainer.style.display = 'none';
                }
            }

            /**
             * Hide loading state
             */
            hideLoading() {
                if (this.loadingContainer) {
                    this.loadingContainer.style.display = 'none';
                }
                if (this.tableContainer) {
                    this.tableContainer.style.display = 'grid';
                }
            }

            /**
             * Render account manager performance table
             * Requirements: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6
             */
            renderAccountManagerCards(accountManagerMetrics) {
                const tableBody = document.getElementById('account-manager-tbody');
                if (!tableBody) return;

                // Get all managers (known + dynamically detected)
                const allManagers = new Set([...this.knownManagers]);
                Object.keys(accountManagerMetrics).forEach(manager => {
                    if (manager && manager.trim()) {
                        allManagers.add(manager);
                    }
                });

                // Sort managers to show known managers first, then alphabetically
                const sortedManagers = Array.from(allManagers)
                    .filter(name => !this.excludedManagers.includes(name))
                    .sort((a, b) => {
                        const aIsKnown = this.knownManagers.includes(a);
                        const bIsKnown = this.knownManagers.includes(b);

                        if (aIsKnown && !bIsKnown) return -1;
                        if (!aIsKnown && bIsKnown) return 1;

                        return a.localeCompare(b);
                    });

                if (sortedManagers.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: var(--spacing-xl); color: var(--text-secondary);">No account manager data found</td></tr>';
                    return;
                }

                // Generate table rows HTML
                const rowsHTML = sortedManagers.map(managerName => {
                    const metrics = accountManagerMetrics[managerName] || {
                        name: managerName,
                        totalAssigned: 0,
                        completed: 0,
                        pending: 0,
                        satisfied: 0,
                        completionRate: 0,
                        satisfactionRate: 0
                    };
                    // Ensure name is present for rows even when metrics object is empty
                    metrics.name = metrics.name || managerName;

                    return this.createManagerRow(metrics);
                }).join('');

                tableBody.innerHTML = rowsHTML;

                // Animate progress bars after rendering
                setTimeout(() => {
                    this.animateProgressBars();
                }, 100);
            }

            /**
             * Create individual manager performance row
             * Requirements: 6.2, 6.3, 6.4, 6.5, 6.6
             */
            createManagerRow(metrics) {
                const completionRateClass = this.getProgressBarClass(metrics.completionRate);
                const managerBadgeClass = this.getManagerBadgeClass(metrics.name);

                return `
                    <tr role="row">
                        <td role="gridcell">
                            <span class="account-manager-badge ${managerBadgeClass}">
                                ${this.escapeHtml(metrics.name)}
                            </span>
                        </td>
                        <td role="gridcell">
                            <span class="completion-count">${metrics.completed}/${metrics.totalAssigned || metrics.completed + metrics.pending}</span>
                        </td>
                        <td role="gridcell">
                            <span class="pending-count ${metrics.pending > 0 ? 'has-pending' : ''}">${metrics.pending}</span>
                        </td>
                        <td role="gridcell">
                            <div class="progress-container-inline">
                                <div class="progress-bar-inline">
                                    <div class="progress-fill ${completionRateClass}" 
                                         data-width="${metrics.completionRate}" 
                                         style="width: 0%"></div>
                                </div>
                                <span class="progress-percentage">${metrics.completionRate}%</span>
                            </div>
                        </td>
                        <td role="gridcell">
                            <span class="csat-percentage">${metrics.satisfactionRate}%</span>
                        </td>
                    </tr>
                `;
            }

            /**
             * Get manager badge CSS class based on name
             */
            getManagerBadgeClass(managerName) {
                if (!managerName) return 'account-manager-default';

                const name = managerName.toLowerCase().trim();

                if (name.includes('abdullah')) {
                    return 'account-manager-abdullah'; // Blue
                } else if (name.includes('ahmed') && name.includes('salem')) {
                    return 'account-manager-ahmed'; // Yellow/Orange
                } else if (name.includes('ibrahim')) {
                    return 'account-manager-ibrahim'; // Purple
                } else if (name.includes('ops')) {
                    return 'account-manager-ops'; // Brown
                } else {
                    return 'account-manager-default'; // Gray for unknown
                }
            }

            /**
             * Get appropriate CSS class for progress bar based on percentage
             * Requirements: 6.6
             */
            getProgressBarClass(percentage) {
                if (percentage >= 80) return 'success';
                if (percentage >= 60) return '';
                if (percentage >= 40) return 'warning';
                return 'error';
            }

            /**
             * Animate progress bars with CSS-only implementation
             * Requirements: 6.6
             */
            animateProgressBars() {
                const tableBody = document.getElementById('account-manager-tbody');
                if (!tableBody) return;

                const progressBars = tableBody.querySelectorAll('.progress-fill[data-width]');

                progressBars.forEach((bar, index) => {
                    const targetWidth = bar.getAttribute('data-width');

                    // Stagger animations for visual appeal
                    setTimeout(() => {
                        bar.style.width = `${targetWidth}%`;
                    }, index * 100);
                });
            }

            /**
             * Animate counter from start to end value
             */
            animateCounter(element, start, end, duration) {
                const startTime = performance.now();

                const updateCounter = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);

                    // Use easing function for smooth animation
                    const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                    const current = Math.round(start + (end - start) * easeOutQuart);

                    element.textContent = current;

                    if (progress < 1) {
                        requestAnimationFrame(updateCounter);
                    }
                };

                requestAnimationFrame(updateCounter);
            }

            /**
             * Show error message
             */
            showError(message) {
                if (this.cardsContainer) {
                    this.cardsContainer.innerHTML = `
                        <div class="metric-card" style="grid-column: 1 / -1; text-align: center; padding: var(--spacing-xl);">
                            <div style="color: var(--error-color); font-size: 1.125rem; margin-bottom: var(--spacing-md);">
                                 Error Loading Data
                            </div>
                            <div style="color: var(--text-secondary); margin-bottom: var(--spacing-lg);">
                                ${this.escapeHtml(message)}
                            </div>
                            <button onclick="accountManagerPerformanceManager.init()" 
                                    style="padding: var(--spacing-sm) var(--spacing-lg); 
                                           background: var(--primary-main); 
                                           color: white; 
                                           border: none; 
                                           border-radius: var(--radius-md); 
                                           cursor: pointer;">
                                Try Again
                            </button>
                        </div>
                    `;
                }
            }

            /**
             * Escape HTML to prevent XSS
             */
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            /**
             * Refresh data and re-render
             */
            async refresh() {
                this.isInitialized = false;
                await this.init();
            }
        }

        // Initialize Account Manager Performance Manager
        let accountManagerPerformanceManager;

        // Initialize Customer Status Manager
        let customerStatusManager;

        // Initialize managers when DOM is ready
        document.addEventListener('DOMContentLoaded', function () {
            accountManagerPerformanceManager = new AccountManagerPerformanceManager();
            window.accountManagerPerformanceManager = accountManagerPerformanceManager;

            customerStatusManager = new CustomerStatusManager();
            window.customerStatusManager = customerStatusManager;
        });

        // Handle tab switching to initialize pages
        document.addEventListener('click', function (event) {
            if (event.target.matches('[data-tab="account-manager-performance"]')) {
                if (accountManagerPerformanceManager && !accountManagerPerformanceManager.isInitialized) {
                    accountManagerPerformanceManager.init();
                }
            }

            if (event.target.matches('[data-tab="customer-status"]')) {
                if (customerStatusManager && !customerStatusManager.isInitialized) {
                    customerStatusManager.init();
                }

                // Prefer using already-filtered data from the Quarter Filter to avoid
                // empty states while waiting for async refreshes.
                if (customerStatusManager) {
                    try {
                        let dataForCustomerStatus = null;

                        if (window.quarterFilter && window.quarterFilter.originalData) {
                            const currentQuarter = window.quarterFilter.currentQuarter || 'all';
                            dataForCustomerStatus = window.quarterFilter.filterDataByQuarter(
                                window.quarterFilter.originalData,
                                currentQuarter
                            );
                        } else if (window.sharedDashboardData && Array.isArray(window.sharedDashboardData)) {
                            // Fallback to the shared data from initial load
                            dataForCustomerStatus = window.sharedDashboardData;
                        }

                        if (Array.isArray(dataForCustomerStatus) && dataForCustomerStatus.length >= 0) {
                            // Render immediately with available data
                            customerStatusManager.updateCustomerStatus(dataForCustomerStatus);
                        } else {
                            // As a last resort, trigger the manager's refresh (async)
                            customerStatusManager.refresh();
                        }
                    } catch (_e) {
                        // If anything goes wrong, ensure we still attempt a refresh
                        customerStatusManager.refresh();
                    }
                }
            }
        });

        // Listen for data refresh events to update Account Manager Performance
        document.addEventListener('dataRefreshed', function (event) {
            if (accountManagerPerformanceManager && accountManagerPerformanceManager.isInitialized) {
                accountManagerPerformanceManager.refresh();
            }
        });

        // Expose managers for debugging
        window.AccountManagerPerformanceManager = AccountManagerPerformanceManager;
        window.CustomerStatusManager = CustomerStatusManager;
        // Manager instances will be set in DOMContentLoaded

        // Global accordion toggle function
        function toggleAccordion(headerElement) {
            try {
                const card = headerElement.closest('.accordion-card');
                if (!card) return;

                const content = card.querySelector('.accordion-content');
                if (!content) return;

                const isExpanded = card.classList.contains('expanded');

                if (isExpanded) {
                    // Collapse
                    card.classList.remove('expanded');
                    headerElement.setAttribute('aria-expanded', 'false');
                    // Reset inline styles to let CSS handle it
                    content.style.maxHeight = '';
                    content.style.overflow = '';
                    content.style.height = '';
                } else {
                    // Expand
                    card.classList.add('expanded');
                    headerElement.setAttribute('aria-expanded', 'true');

                    // Let CSS handle the expansion with !important rules
                    // Remove any inline styles that might interfere
                    content.style.maxHeight = '';
                    content.style.overflow = '';
                    content.style.height = '';


                }
            } catch (error) {
                if (window.errorManager) {
                    window.errorManager.showError('Error expanding survey details', 'error', 3000);
                }
            }
        }

        // Make toggleAccordion globally available
        window.toggleAccordion = toggleAccordion;

        // Quarter Filter Functionality
        class QuarterFilter {
            constructor() {
                this.currentQuarter = 'all';
                this.originalData = null;
                this.init();
            }

            init() {
                const quarterSelect = document.getElementById('quarter-select');
                if (quarterSelect) {
                    quarterSelect.addEventListener('change', (e) => {
                        this.handleQuarterChange(e.target.value);
                    });
                }

                // Set current year dynamically
                this.updateQuarterOptions();

                // Add test functionality for debugging
                window.testQuarterFilter = () => {
                    this.handleQuarterChange('q1');
                };
            }

            updateQuarterOptions() {
                const currentYear = new Date().getFullYear();
                const quarterSelect = document.getElementById('quarter-select');
                if (quarterSelect) {
                    const options = quarterSelect.querySelectorAll('option[value^="q"]');
                    options.forEach(option => {
                        const quarter = option.value.toUpperCase();
                        option.textContent = `${quarter} ${currentYear}`;
                        option.value = option.value; // Keep the q1, q2, etc. values
                    });
                }
            }

            handleQuarterChange(quarter) {
                this.currentQuarter = quarter;

                // Ensure dropdown shows the correct value
                const quarterSelect = document.getElementById('quarter-select');
                if (quarterSelect && quarterSelect.value !== quarter) {
                    quarterSelect.value = quarter;
                }



                // Save the selected quarter to sessionStorage
                sessionStorage.setItem('selectedQuarter', quarter);

                // Show loading state
                this.showLoadingState();

                // Filter and refresh all dashboard data immediately
                // (Bug fix: previously disabled, causing UI to get stuck after selection)
                this.filterAndRefreshData();
            }

            showLoadingState() {
                // Add loading indicator to the filter
                const quarterSelect = document.getElementById('quarter-select');
                if (quarterSelect) {
                    quarterSelect.style.opacity = '0.6';
                    quarterSelect.disabled = true;
                }
            }

            hideLoadingState() {
                const quarterSelect = document.getElementById('quarter-select');
                if (quarterSelect) {
                    quarterSelect.style.opacity = '1';
                    quarterSelect.disabled = false;
                }
            }

            async filterAndRefreshData() {
                try {

                    // Sync dropdown with current state
                    const quarterSelect = document.getElementById('quarter-select');
                    if (quarterSelect && quarterSelect.value !== this.currentQuarter) {

                        quarterSelect.value = this.currentQuarter;
                    }

                    // Get original data if not cached - use shared data from main initialization
                    if (!this.originalData && window.sharedDashboardData) {
                        this.originalData = [...window.sharedDashboardData];

                        // Add Q3 pending customers when Q3 is selected
                        if (this.currentQuarter.toLowerCase() === 'q3') {
                            const processor = new SurveyDataProcessor();
                            const q3PendingCustomers = processor.getPendingSurveys(this.originalData);
                            this.originalData = [...this.originalData, ...q3PendingCustomers];
                        }
                    } else if (!this.originalData) {
                        // Fallback: load data if shared data not available yet
                        const apiData = await window.DashboardAPI.getData(true);
                        this.originalData = [...apiData];

                        // Add Q3 pending customers when Q3 is selected
                        if (this.currentQuarter.toLowerCase() === 'q3') {
                            const processor = new SurveyDataProcessor();
                            const q3PendingCustomers = processor.getPendingSurveys(this.originalData);
                            this.originalData = [...this.originalData, ...q3PendingCustomers];
                        }
                    }

                    if (!this.originalData || this.originalData.length === 0) {
                        return;
                    }

                    // Filter data by quarter
                    const filteredData = this.filterDataByQuarter(this.originalData, this.currentQuarter);

                    // Refresh all dashboard sections with filtered data
                    await this.refreshDashboardSections(filteredData);

                    // Update URL or state if needed
                    this.updateState();

                } catch (error) {
                    if (window.errorManager) {
                        window.errorManager.showError('Error filtering data by quarter', 'error', 3000);
                    }
                } finally {
                    this.hideLoadingState();
                }
            }

            filterDataByQuarter(data, quarter) {
                if (quarter === 'all' || !data) {
                    return data;
                }

                const filteredData = data.filter(survey => {
                    // For Q3, include pending customers (they belong to Q3)
                    if (!survey.submittedAt) {
                        return quarter.toLowerCase() === 'q3' && survey.quarter === 'Q3';
                    }

                    const submissionDate = new Date(survey.submittedAt);
                    const month = submissionDate.getMonth() + 1; // getMonth() returns 0-11, we need 1-12
                    const year = submissionDate.getFullYear();

                    // Filter based on quarter and year (2025)
                    if (year !== 2025) {
                        return false;
                    }

                    switch (quarter.toLowerCase()) {
                        case 'q1':
                            return month >= 1 && month <= 4; // January-April
                        case 'q2':
                            return month >= 5 && month <= 9; // May-September
                        case 'q3':
                            return month >= 10 && month <= 12; // October-December
                        case 'q4':
                            return false; // Q4 2025 is empty for now (January 2026)
                        default:
                            return true;
                    }
                });

                // Filtered company list for the selected quarter


                return filteredData;
            }

            async refreshDashboardSections(filteredData) {
                try {
                    // Wait for managers to be available
                    await this.waitForManagers();

                    // Refresh CSAT Summary
                    if (window.csatSummaryManager) {
                        await window.csatSummaryManager.updateSummaryMetrics(filteredData);
                    }

                    // Refresh Customer Status
                    if (window.customerStatusManager) {
                        await window.customerStatusManager.updateCustomerStatus(filteredData);
                    }

                    // Refresh Account Manager Performance
                    if (window.accountManagerPerformanceManager) {
                        // Process the data first to get account manager metrics
                        const processedData = this.processAccountManagerData(filteredData);
                        window.accountManagerPerformanceManager.renderAccountManagerCards(processedData.accountManagerMetrics);
                    }

                    // Dispatch custom event for other components
                    document.dispatchEvent(new CustomEvent('quarterFilterChanged', {
                        detail: {
                            quarter: this.currentQuarter,
                            data: filteredData,
                            originalData: this.originalData
                        }
                    }));
                } catch (error) {
                    // Error refreshing dashboard sections
                }
            }

            // Wait for dashboard managers to be initialized
            async waitForManagers(maxWait = 5000) {
                const startTime = Date.now();

                while (Date.now() - startTime < maxWait) {
                    if (window.csatSummaryManager &&
                        window.customerStatusManager &&
                        window.accountManagerPerformanceManager) {
                        return true;
                    }


                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                return false;
            }

            // Process account manager data similar to the DataProcessor
            processAccountManagerData(surveyData) {
                const accountManagerMetrics = {};

                // Initialize known managers
                const knownManagers = ['Abdullah Ahmed', 'Ibrahim Fadaly', 'Ahmed Saleem', 'OPS'];
                knownManagers.forEach(manager => {
                    accountManagerMetrics[manager] = {
                        completed: 0,
                        pending: 0,
                        completionRate: 0,
                        satisfactionRate: 0,
                        totalAssigned: 0,
                        satisfiedCustomers: 0
                    };
                });

                // Process survey data
                surveyData.forEach(survey => {
                    // Normalize manager name for consistency
                    let manager = survey.accountManager;
                    if (manager === 'Ahmed Salem') manager = 'Ahmed Saleem';
                    if (!manager) return;

                    if (!accountManagerMetrics[manager]) {
                        accountManagerMetrics[manager] = {
                            completed: 0,
                            pending: 0,
                            completionRate: 0,
                            satisfactionRate: 0,
                            totalAssigned: 0,
                            satisfiedCustomers: 0
                        };
                    }

                    accountManagerMetrics[manager].totalAssigned++;

                    if (survey.submittedAt) {
                        accountManagerMetrics[manager].completed++;

                        // Check if customer is satisfied (rating 4-5)
                        if (survey.overallSatisfaction >= 4) {
                            accountManagerMetrics[manager].satisfiedCustomers++;
                        }
                    } else {
                        accountManagerMetrics[manager].pending++;
                    }
                });

                // Add Q3 pending customers to account manager metrics (only for Q3)
                if (this.currentQuarter.toLowerCase() === 'q3') {
                    const q3PendingCustomers = generateQ3PendingCustomers();

                    // Get list of companies that have already submitted surveys
                    const submittedCompanies = new Set(
                        surveyData
                            .filter(survey => survey.submittedAt && survey.companyName)
                            .map(survey => survey.companyName.toLowerCase().trim())
                    );

                    // Filter out customers who have already submitted
                    const stillPending = q3PendingCustomers.filter(customer => {
                        const customerName = customer.companyName.toLowerCase().trim();
                        return !submittedCompanies.has(customerName);
                    });

                    // Add pending customers to account manager metrics
                    stillPending.forEach(customer => {
                        let manager = customer.accountManager;
                        if (manager === 'Ahmed Salem') manager = 'Ahmed Saleem';
                        if (manager === 'Ibrahim Fadhaly') manager = 'Ibrahim Fadaly';
                        if (!manager) return;

                        if (!accountManagerMetrics[manager]) {
                            accountManagerMetrics[manager] = {
                                completed: 0,
                                pending: 0,
                                completionRate: 0,
                                satisfactionRate: 0,
                                totalAssigned: 0,
                                satisfiedCustomers: 0
                            };
                        }

                        accountManagerMetrics[manager].totalAssigned++;
                        accountManagerMetrics[manager].pending++;
                    });
                }

                // Calculate rates
                Object.keys(accountManagerMetrics).forEach(manager => {
                    const metrics = accountManagerMetrics[manager];
                    if (metrics.totalAssigned > 0) {
                        metrics.completionRate = Math.round((metrics.completed / metrics.totalAssigned) * 100 * 10) / 10;
                        if (metrics.completed > 0) {
                            metrics.satisfactionRate = Math.round((metrics.satisfiedCustomers / metrics.completed) * 100 * 10) / 10;
                        }
                    }
                });

                return { accountManagerMetrics };
            }

            updateState() {
                // Update URL hash or localStorage if needed
                if (this.currentQuarter !== 'all') {
                    sessionStorage.setItem('selectedQuarter', this.currentQuarter);
                } else {
                    sessionStorage.removeItem('selectedQuarter');
                }
            }

            // Restore saved quarter on page load
            restoreState() {
                const savedQuarter = sessionStorage.getItem('selectedQuarter');
                const quarterSelect = document.getElementById('quarter-select');

                if (savedQuarter && quarterSelect) {
                    quarterSelect.value = savedQuarter;
                    this.currentQuarter = savedQuarter;
                } else if (quarterSelect) {
                    // Sync with the current dropdown value
                    const currentValue = quarterSelect.value;
                    this.currentQuarter = currentValue;
                }
            }

            // Get current filter state
            getCurrentFilter() {
                return {
                    quarter: this.currentQuarter,
                    year: new Date().getFullYear()
                };
            }
        }

        // Initialize Quarter Filter
        let quarterFilter;
        document.addEventListener('DOMContentLoaded', function () {
            quarterFilter = new QuarterFilter();
            // Make it globally available immediately
            window.quarterFilter = quarterFilter;


            // Check manager availability after initialization
            setTimeout(() => {

                // Restore saved state
                quarterFilter.restoreState();

                // Apply the current quarter filter to ensure all tabs show filtered data
                // Disabled to prevent multiple data loads - data already loaded above
                // setTimeout(() => {
                //     quarterFilter.filterAndRefreshData();
                // }, 500);
            }, 2000);
        });

        // Make quarter filter class globally available
        window.QuarterFilter = QuarterFilter;
        // Note: window.quarterFilter is assigned inside DOMContentLoaded event

    </script>
</body>

</html>
